<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Rental Property Calculator — calculate ROI on rental property, cash‑on‑cash return, IRR, cap rate for single‑family and multi‑family rentals</title>
    <meta name="description" content="Rental property calculator to calculate return on rental properties. Analyze single‑family and multi‑family rentals: ROI on rental property, cash‑on‑cash return, IRR, cap rate, NOI, mortgage P&I, expenses, and a 20‑year investment summary with profit when sold." />
    <meta property="og:title" content="Rental Property Calculator — calculate return on rental properties (ROI), cash‑on‑cash, IRR, cap rate" />
    <meta property="og:description" content="Human‑readable rental property calculator that helps you calculate multi‑family returns and single‑family ROI: cash‑on‑cash return, internal rate of return (IRR), capitalization rate (cap rate), NOI, expenses, and 20‑year projections." />
    <meta name="keywords" content="rental property calculator, calculate return on rental properties, ROI on rental property, calculate multi family returns, cash on cash return, IRR, cap rate, net operating income, rental analysis, 20 year investment summary" />
    <style>
      *, *::before, *::after {
        box-sizing: border-box;
      }

      :root {
        color-scheme: dark;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        --nav-offset: clamp(6px, 2vw, 14px);
        --app-pad-x: clamp(12px, 4vw, 24px);
      }

      body {
        margin: 0;
        padding: 24px 0;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        background: transparent;
        color: #e2e8f0;
        overflow-x: hidden;
        touch-action: auto;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: auto;
      }

      .app {
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
        padding: 0 var(--app-pad-x) 32px;
        display: grid;
        gap: 18px;
        background: linear-gradient(135deg, rgba(25, 28, 48, 0.9), rgba(20, 23, 42, 0.95));
        border: none;
        border-radius: 0;
        box-shadow: none;
        box-sizing: border-box;
        touch-action: auto;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: auto;
      }

      header h1 {
        margin: 0;
        font-size: 26px;
        font-weight: 600;
        letter-spacing: -0.01em;
      }

      header p {
        margin: 8px 0 0;
        color: rgba(226, 232, 240, 0.75);
        font-size: 14px;
      }

      .section-title {
        font-size: 11px;
        font-weight: 500;
        letter-spacing: 0.16em;
        color: rgba(148, 163, 184, 0.65);
        text-transform: uppercase;
        margin-bottom: 14px;
      }

      .section-summary {
        font-size: 11px;
        font-weight: 500;
        letter-spacing: 0.16em;
        color: rgba(148, 163, 184, 0.75);
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 0 18px;
        min-height: 46px;
        line-height: 1.1;
      }

      /* Responsive header toggles using flexbox */
      .section-summary {
        display: flex;
        width: 100%;
        align-items: center;
      }
      .summary-spacer {
        flex-grow: 1;
      }
      .purchase-header-toggles, .sell-header-toggle {
        flex-shrink: 0;
        display: flex;
        align-items: center;
        gap: 0;
      }
      .purchase-header-toggles .row { 
        display: inline-flex; 
        align-items: center; 
        gap: 5px;
        padding: 4px 12px;
      }
      .purchase-header-toggles .row:not(:last-child) {
        border-right: 1px solid rgba(100, 116, 139, 0.4);
      }
      .purchase-header-toggles .label { 
        margin: 0; 
        font-size: 11px; 
        font-weight: 600;
        white-space: nowrap; 
        color: #e2e8f0;
        text-transform: uppercase;
        letter-spacing: 0.02em;
      }
      .purchase-header-toggles .yesno-toggle, .sell-header-toggle .yesno-toggle {
        transform: scale(0.9);
        transform-origin: right center;
      }

      @media (max-width: 620px) {
        .purchase-header-toggles, .sell-header-toggle {
          display: none;
        }
      }

      /* Hide header toggles when the section is collapsed */
      details[data-openai-component="purchase-details"]:not([open]) .purchase-header-toggles {
        display: none;
      }

      details[data-openai-component="sell-exit-assumptions"]:not([open]) .sell-header-toggle {
        display: none;
      }

      .section-summary::after {
        content: "";
        width: 9px;
        height: 9px;
        border-right: 2px solid rgba(148, 163, 184, 0.6);
        border-bottom: 2px solid rgba(148, 163, 184, 0.6);
        transform: rotate(45deg);
        margin-left: auto;
        transition: transform 0.24s ease, border-color 0.24s ease;
      }

      details[open] .section-summary::after {
        transform: rotate(-135deg);
      }

      .section-summary:hover::after,
      .section-summary:focus-visible::after {
        border-color: #0ea5e9;
      }

      .collapsible-content {
        padding: 14px 16px;
        margin-top: 0;
      }

      .collapsible-content .grid + .grid {
        margin-top: 12px;
      }

      .field-group {
        padding: 16px 0 12px;
      }

      .field-group + .field-group {
        border-top: 1px solid rgba(148, 163, 184, 0.08);
        padding-top: 20px;
      }

      .field-group-label {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        font-size: 10px;
        font-weight: 600;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.7);
        margin: 0 0 14px;
      }

      .field-group-label .icon {
        width: 18px;
        height: 18px;
        border-radius: 6px;
        background: linear-gradient(135deg, rgba(14, 165, 233, 0.45), rgba(99, 102, 241, 0.35));
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: rgba(15, 23, 42, 0.92);
        font-size: 12px;
        box-shadow: 0 4px 12px rgba(14, 165, 233, 0.25);
      }

      .section-block {
        border-radius: 12px;
        border: 1px solid rgba(71, 85, 105, 0.3);
        background: linear-gradient(135deg, rgba(30, 33, 56, 0.85), rgba(25, 28, 48, 0.9));
        padding: 16px;
        display: grid;
        gap: 12px;
        box-shadow: 0 4px 12px rgba(10, 13, 28, 0.4);
        min-width: 0;
      }

      details.section-block {
        padding: 0;
      }

      details.section-block > summary {
        padding: 0;
      }

      details.section-block > summary.section-summary {
        padding: 0 18px;
        min-height: 46px;
      }

      details.section-block > .collapsible-content {
        padding-bottom: 14px;
      }

      .grid {
        display: grid;
        gap: 14px;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }

      .grid > * {
        min-width: 0;
      }

      .grid.duo-columns {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 16px 18px;
      }

      .grid.trio-columns {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 14px 16px;
      }

      /* Inline pair: main amount + small percent input aligned horizontally */
      .inline-pair {
        display: grid;
        grid-template-columns: 1fr 72px;
        gap: 12px;
        align-items: end;
        padding: 10px 12px;
        border: 1px solid rgba(71, 85, 105, 0.35);
        border-radius: 10px;
        background: rgba(37, 40, 65, 0.45);
        transition: border-color 0.2s ease, background 0.2s ease, box-shadow 0.2s ease;
      }
      .inline-pair .pair-col { display: grid; gap: 4px; }
      .percent-compact { position: relative; }
      .percent-compact input[type="number"] { width: 100%; }
      .inline-pair:hover {
        border-color: rgba(14, 165, 233, 0.35);
        box-shadow: 0 4px 12px rgba(10, 13, 28, 0.25);
      }
      .inline-pair:focus-within {
        border-color: rgba(14, 165, 233, 0.55);
        background: rgba(14, 165, 233, 0.06);
        box-shadow: 0 0 0 1px rgba(14, 165, 233, 0.35), 0 8px 16px rgba(14, 165, 233, 0.18);
      }
      /* Loan preset UI */
      .loan-preset-block {
        display: grid;
        grid-template-columns: minmax(180px, 240px) 1fr;
        gap: 12px;
        align-items: end;
        margin: 10px 0 6px;
      }
      .preset-chips {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .preset-chip {
        position: relative;
        padding: 8px 14px;
        border-radius: 9999px;
        font-size: 12px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: rgba(236, 230, 255, 0.9);
        border: 1px solid rgba(168, 85, 247, 0.6);
        background: linear-gradient(180deg, rgba(139, 92, 246, 0.18), rgba(139, 92, 246, 0.08));
        box-shadow: inset 0 0 0 1px rgba(168, 85, 247, 0.25);
        transition: background 0.2s ease, box-shadow 0.2s ease, transform 0.06s ease;
        cursor: pointer;
      }
      .preset-chip:hover { box-shadow: 0 6px 14px rgba(139, 92, 246, 0.2); }
      .preset-chip:active { transform: translateY(1px); }
      .preset-chip.active {
        color: #1a1c2b;
        background: linear-gradient(180deg, rgba(193, 148, 255, 0.95), rgba(168, 85, 247, 0.85));
        border-color: rgba(193, 148, 255, 0.95);
        box-shadow: 0 8px 18px rgba(139, 92, 246, 0.35);
      }
      /* Inline preset dropdown next to yes/no toggle */
      .preset-inline { position: relative; display: inline-block; margin-left: 0; }
      .preset-inline::after {
        content: "";
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 0; height: 0;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-top: 6px solid rgba(193, 148, 255, 0.95);
        pointer-events: none;
      }
      .preset-select {
        -webkit-appearance: none;
        appearance: none;
        padding: 6px 32px 6px 12px;
        border-radius: 9999px;
        font-size: 12px;
        letter-spacing: 0.06em;
        color: rgba(236, 230, 255, 0.92);
        border: 1px solid rgba(168, 85, 247, 0.6);
        background: linear-gradient(180deg, rgba(139, 92, 246, 0.18), rgba(139, 92, 246, 0.08));
        box-shadow: inset 0 0 0 1px rgba(168, 85, 247, 0.25);
        cursor: pointer;
      }
      .preset-select:hover { box-shadow: 0 6px 14px rgba(139, 92, 246, 0.2); }
      .preset-select:focus { outline: none; border-color: rgba(193, 148, 255, 0.95); box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.35); }
      .preset-select option { background: #141729; color: #eee7ff; }
      /* VA Disability Toggle */
      .va-disability-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-left: 12px;
        padding-left: 12px;
        border-left: 1px solid rgba(71, 85, 105, 0.4);
      }
      .va-toggle-label {
        font-size: 11px;
        color: rgba(148, 163, 184, 0.9);
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }
      .va-tooltip {
        position: relative;
        cursor: help;
        color: rgba(148, 163, 184, 0.7);
      }
      .va-tooltip svg { width: 14px; height: 14px; }
      .va-tooltip::after {
        content: attr(data-tooltip);
        position: absolute;
        left: 50%;
        top: 100%;
        transform: translateX(-50%);
        background: #1e293b;
        color: #f1f5f9;
        font-size: 11px;
        line-height: 1.4;
        padding: 8px 10px;
        border-radius: 6px;
        width: 200px;
        white-space: normal;
        text-align: center;
        margin-top: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        opacity: 0;
        visibility: hidden;
        z-index: 1000;
        pointer-events: none;
      }
      .va-tooltip::before {
        content: "";
        position: absolute;
        left: 50%;
        top: 100%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-bottom-color: #1e293b;
        margin-top: -4px;
        opacity: 0;
        visibility: hidden;
        z-index: 1000;
      }
      .va-tooltip:hover::after,
      .va-tooltip:hover::before {
        opacity: 1;
        visibility: visible;
      }
      .toggle-group.mini {
        display: flex;
        background: rgba(30, 41, 59, 0.6);
        border-radius: 6px;
        padding: 2px;
      }
      .toggle-group.mini input[type="radio"] { display: none; }
      .toggle-group.mini label {
        padding: 4px 10px;
        font-size: 11px;
        font-weight: 500;
        color: rgba(148, 163, 184, 0.8);
        cursor: pointer;
        border-radius: 4px;
        transition: all 0.15s;
      }
      .toggle-group.mini input[type="radio"]:checked + label {
        background: rgba(56, 189, 248, 0.2);
        color: #38bdf8;
      }
      /* Year 1 Summary split card */
      .result-split {
        position: relative;
        display: flex;
        gap: 28px;
        align-items: flex-start;
        padding-top: 0;
      }
      .result-split::before {
        content: "";
        position: absolute;
        top: 0;
        bottom: 0;
        left: 50%;
        width: 1px;
        transform: translateX(-0.5px);
        background: linear-gradient(180deg, rgba(148, 163, 184, 0.15), rgba(148, 163, 184, 0.05));
      }
      .result-split .split-col {
        flex: 1;
        min-width: 0;
        padding: 0 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
      .result-split .split-col .label { margin-bottom: 4px; }
      .result-split .split-col .value { margin-top: 0; }
      .result-split .split-col .hint { margin-top: 4px; opacity: 0.8; }
      @media (max-width: 720px) {
        .result-split {
          flex-direction: column;
          gap: 18px;
          align-items: center;
        }
        .result-split::before { display: none; }
      }
      /* Align lone vacancy label with the two inline pairs in Income */
      [data-openai-component="income-details"] .grid.trio-columns > label.percent-field {
        align-self: start;
        margin-top: 12px;
      }
      .percent-compact::after {
        content: "%";
        position: absolute;
        right: 6px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 12px;
        color: rgba(226, 232, 240, 0.5);
        pointer-events: none;
      }
      /* Outputs slide layout */
      .two-col { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 18px; align-items: start; }
      .two-col > * { min-width: 0; }
      @media (max-width: 1000px) { .two-col { grid-template-columns: 1fr; } }
      .three-col { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 16px; align-items: start; }
      .three-col > * { min-width: 0; }
      @media (max-width: 1200px) { .three-col { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
      @media (max-width: 900px) { .three-col { grid-template-columns: 1fr; } }
      @media (max-width: 720px) { .grid.duo-columns, .grid.trio-columns { grid-template-columns: 1fr; } }
      .metrics-grid { display: grid; gap: 8px; }
      .metric { display: flex; justify-content: space-between; align-items: baseline; padding: 10px 12px; border-radius: 10px; background: rgba(37, 40, 65, 0.45); border: 1px solid rgba(71, 85, 105, 0.35); }
      .metric .label { color: rgba(203, 213, 225, 0.9); font-size: 13px; }
      .metric .value { color: rgba(248, 250, 252, 0.96); font-weight: 600; }
      .kpi-main { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 16px; margin-bottom: 12px; }
      @media (max-width: 520px) { .kpi-main { grid-template-columns: 1fr; } }
      .kpi-item { text-align: center; padding: 14px 12px; border-radius: 12px; background: linear-gradient(180deg, rgba(14, 165, 233, 0.08), rgba(14, 165, 233, 0.02)); border: 1px solid rgba(56, 189, 248, 0.25); }
      .kpi-item:first-child { background: linear-gradient(180deg, rgba(52, 211, 153, 0.10), rgba(16, 185, 129, 0.035)); border-color: rgba(52, 211, 153, 0.35); }
      .kpi-label { display: block; font-size: 12px; letter-spacing: 0.06em; color: rgba(226, 232, 240, 0.82); margin-bottom: 4px; text-transform: uppercase; }
      .kpi-number { display: block; font-size: 28px; font-weight: 700; color: rgba(248, 250, 252, 0.98); line-height: 1.2; }
      .kpi-sub { display: block; font-size: 13px; color: rgba(203, 213, 225, 0.86); }
      .neg { color: #fca5a5 !important; }
      /* Deal Quality Indicator Styles */
      .deal-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 18px;
        border-radius: 24px;
        font-size: 14px;
        font-weight: 600;
        letter-spacing: 0.02em;
        margin-bottom: 16px;
      }
      .deal-indicator.good {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.18), rgba(16, 185, 129, 0.12));
        border: 1px solid rgba(34, 197, 94, 0.4);
        color: #4ade80;
      }
      .deal-indicator.mediocre {
        background: linear-gradient(135deg, rgba(250, 204, 21, 0.18), rgba(234, 179, 8, 0.12));
        border: 1px solid rgba(250, 204, 21, 0.4);
        color: #fde047;
      }
      .deal-indicator.bad {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.18), rgba(220, 38, 38, 0.12));
        border: 1px solid rgba(239, 68, 68, 0.4);
        color: #fca5a5;
      }
      .deal-emoji { font-size: 18px; line-height: 1; }
      /* Cashflow-focused summary card */
      .cashflow-summary {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 8px 0;
      }
      .cashflow-main {
        margin-bottom: 12px;
      }
      .cashflow-main .label {
        font-size: 11px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: rgba(226, 232, 240, 0.7);
        margin-bottom: 4px;
      }
      .cashflow-main .cashflow-values {
        display: flex;
        align-items: baseline;
        justify-content: center;
        gap: 16px;
        flex-wrap: wrap;
      }
      .cashflow-main .value-primary {
        font-size: 38px;
        font-weight: 700;
        color: rgba(248, 250, 252, 0.98);
        line-height: 1.1;
      }
      .cashflow-main .value-primary.positive { color: #4ade80; }
      .cashflow-main .value-primary.negative { color: #fca5a5; }
      .cashflow-main .value-secondary {
        font-size: 20px;
        font-weight: 600;
        color: rgba(203, 213, 225, 0.9);
      }
      .cashflow-main .value-secondary.positive { color: rgba(74, 222, 128, 0.85); }
      .cashflow-main .value-secondary.negative { color: rgba(252, 165, 165, 0.85); }
      .cashflow-main .period-label {
        font-size: 13px;
        color: rgba(148, 163, 184, 0.8);
        margin-left: 2px;
      }
      .income-row {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: rgba(148, 163, 184, 0.85);
        margin-top: 8px;
        padding-top: 12px;
        border-top: 1px solid rgba(71, 85, 105, 0.25);
      }
      .income-row .income-value {
        color: rgba(226, 232, 240, 0.95);
        font-weight: 500;
      }
      .cap-rate-row {
        border-top: none;
        padding-top: 0;
        margin-top: 4px;
      }
      .cap-rate-value {
        color: #60a5fa;
        font-weight: 600;
        font-size: 14px;
      }
      .breakeven-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 14px;
        padding: 10px 16px;
        background: rgba(239, 68, 68, 0.08);
        border: 1px solid rgba(239, 68, 68, 0.25);
        border-radius: 8px;
        font-size: 13px;
        color: rgba(252, 165, 165, 0.95);
      }
      .breakeven-row svg { width: 16px; height: 16px; opacity: 0.8; flex-shrink: 0; }
      .breakeven-row .breakeven-price {
        font-weight: 600;
        color: #fca5a5;
      }
      @media (max-width: 480px) {
        .cashflow-main .value-primary { font-size: 32px; }
        .cashflow-main .value-secondary { font-size: 18px; }
        .cashflow-main .cashflow-values { gap: 10px; }
      }
      .metrics-table { width: 100%; border-collapse: collapse; table-layout: fixed; background: rgba(23, 26, 45, 0.6); border-radius: 12px; overflow: hidden; }
      /* Distribute columns to fill cell: label 50%, monthly 25%, annual 25% */
      .metrics-table thead th:nth-child(1), .metrics-table tbody td:nth-child(1) { width: 50%; }
      .metrics-table thead th:nth-child(2), .metrics-table tbody td:nth-child(2) { width: 25%; }
      .metrics-table thead th:nth-child(3), .metrics-table tbody td:nth-child(3) { width: 25%; }
      .metrics-table th, .metrics-table td { padding: 10px 12px; border-bottom: 1px solid rgba(71, 85, 105, 0.35); font-size: 13px; }
      .metrics-table thead th { background: rgba(30, 41, 59, 0.7); text-align: right; }
      .metrics-table thead th:first-child { text-align: left; }
      .metrics-table tbody td:first-child { color: rgba(226, 232, 240, 0.9); text-align: left; }
      .metrics-table tbody td { text-align: right; color: rgba(248, 250, 252, 0.92); }
      .metrics-table tr.em td { font-weight: 600; color: #fca5a5; }
      .donut-row { display: grid; grid-template-columns: auto 1fr; gap: 16px; align-items: center; }
      @media (max-width: 520px) { .donut-row { grid-template-columns: 1fr; } }
      /* 2x2 Year 1 grid: KPI x 2 on row 1, table + donut on row 2 */
      .year1-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 16px;
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
        align-items: start;
      }
      @media (max-width: 1000px) { .year1-grid { grid-template-columns: 1fr; } }
      .donut-legend { display: grid; gap: 8px; font-size: 13px; color: rgba(226, 232, 240, 0.9); }
      .donut-legend .legend-item { display: flex; align-items: center; gap: 10px; padding: 4px 0; cursor: default; }
      .donut-legend .legend-item .swatch { width: 12px; height: 12px; border-radius: 50%; box-shadow: 0 0 0 2px rgba(255,255,255,0.06) inset; flex: 0 0 auto; }
      .donut-legend .legend-item .name { color: rgba(241, 245, 249, 0.96); font-weight: 500; }
      .donut-legend .legend-item .pct { margin-left: auto; color: rgba(203, 213, 225, 0.85); }
      .breakdown-table-wrap { justify-self: start; }
      /* Year-by-Year table: prevent horizontal overflow expanding layout */
      .yearly-table { width: 100%; border-collapse: collapse; display: block; overflow-x: auto; max-width: 100%; white-space: nowrap; background: rgba(23, 26, 45, 0.6); border-radius: 12px; }
      .yearly-table th, .yearly-table td { padding: 10px 12px; border-bottom: 1px solid rgba(71, 85, 105, 0.35); font-size: 13px; text-align: right; }
      .yearly-table thead th:first-child, .yearly-table tbody td:first-child { text-align: left; }
      @media (max-width: 720px) { .metrics-table th, .metrics-table td { font-size: 12px; padding: 8px 10px; } .kpi-number { font-size: 26px; } }

      @media (max-width: 720px) { .inline-pair { grid-template-columns: 1fr 68px; } }
      @media (max-width: 640px) { .inline-pair { grid-template-columns: 1fr 64px; } }

      .is-hidden {
        display: none !important;
      }

      label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 12px;
        color: rgba(226, 232, 240, 0.68);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      label .field-helper {
        font-size: 11px;
        color: rgba(148, 163, 184, 0.6);
        text-transform: none;
        letter-spacing: 0;
        font-weight: 400;
        margin-top: -2px;
      }

      label.has-error input,
      label.has-error select {
        border-bottom-color: #f87171;
      }

      label .field-message {
        font-size: 10px;
        color: #fca5a5;
        text-transform: none;
        letter-spacing: 0;
        font-weight: 400;
      }

      /* Estimated value indicator - inline with title */
      .label-row {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .estimated-indicator {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        font-size: 9px;
        color: rgba(96, 165, 250, 0.6);
        font-weight: 400;
        text-transform: none;
        letter-spacing: 0;
        opacity: 0.9;
        white-space: nowrap;
        position: relative;
        cursor: help;
      }
      .estimated-indicator svg {
        width: 10px;
        height: 10px;
        flex-shrink: 0;
      }
      .estimated-indicator.hidden {
        display: none;
      }
      /* Custom tooltip with arrow */
      .estimated-indicator::before,
      .estimated-indicator::after {
        position: absolute;
        pointer-events: none;
        opacity: 0;
        visibility: hidden;
        z-index: 1000;
      }
      .estimated-indicator::after {
        content: attr(data-tooltip);
        left: 50%;
        top: 100%;
        transform: translateX(-50%);
        background: #1e293b;
        color: #f1f5f9;
        font-size: 13px;
        line-height: 1.4;
        padding: 8px 12px;
        border-radius: 6px;
        width: 180px;
        white-space: normal;
        text-align: center;
        margin-top: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      }
      /* Arrow pointing up */
      .estimated-indicator::before {
        content: "";
        left: 50%;
        top: 100%;
        transform: translateX(-50%);
        border: 6px solid transparent;
        border-bottom-color: #1e293b;
        margin-top: -4px;
      }
      .estimated-indicator:hover::before,
      .estimated-indicator:hover::after {
        opacity: 1;
        visibility: visible;
      }

      /* Prevent Purchase Details inputs from stretching too wide in narrow iframe */
      #purchase_inputs_row #purchase_price,
      #purchase_inputs_row #closing_cost,
      #simple_property_tax_row #simple_property_tax {
        max-width: 260px;
        width: min(260px, 100%);
      }
      @media (max-width: 640px) {
        #purchase_inputs_row #purchase_price,
        #purchase_inputs_row #closing_cost,
        #simple_property_tax_row #simple_property_tax { max-width: 200px; width: min(200px, 100%); }
      }

      .percent-field {
        position: relative;
      }

      .percent-field input[type="number"] {
        padding-right: 32px;
      }

      .percent-field::after {
        content: "%";
        position: absolute;
        right: 4px;
        top: 34px;
        font-size: 12px;
        color: rgba(226, 232, 240, 0.5);
        pointer-events: none;
      }

      input[type="number"],
      input[type="text"],
      select {
        border: none;
        border-bottom: 1px solid rgba(100, 116, 139, 0.4);
        border-radius: 0;
        background: transparent;
        color: #e2e8f0;
        font-size: 15px;
        padding: 6px 4px;
        transition: border-color 0.2s ease, color 0.2s ease;
      }

      input::placeholder {
        color: rgba(226, 232, 240, 0.38);
      }

      .slider-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 10px;
      }

      .slider-row input[type="range"] {
        flex: 1;
        appearance: none;
        height: 4px;
        border-radius: 999px;
        background: linear-gradient(90deg, rgba(14,165,233,0.45), rgba(56,189,248,0.35));
        outline: none;
      }

      .slider-row input[type="range"]::-webkit-slider-thumb {
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #22d3ee;
        border: 2px solid rgba(15,23,42,0.85);
        box-shadow: 0 4px 10px rgba(14,165,233,0.45);
        cursor: pointer;
      }

      .slider-row input[type="range"]::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #22d3ee;
        border: 2px solid rgba(15,23,42,0.85);
        box-shadow: 0 4px 10px rgba(14,165,233,0.45);
        cursor: pointer;
      }

      .slider-value {
        font-size: 12px;
        font-weight: 600;
        letter-spacing: 0.08em;
        color: rgba(148, 163, 184, 0.9);
        min-width: 54px;
        text-align: right;
        text-transform: uppercase;
      }

      .scenario-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        align-items: center;
        width: 100%;
        margin: 0 auto;
      }

      [data-openai-component="loan-input-form"] .section-title {
        margin-bottom: 12px;
      }

      [data-openai-component="loan-input-form"] .grid {
        margin-top: 12px;
      }

      .scenario-chip {
        padding: 8px 14px;
        border-radius: 999px;
        border: 1px solid rgba(167, 139, 250, 0.55); /* light purple border */
        background: rgba(20, 23, 42, 0.85);
        color: #c4b5fd; /* light purple text */
        font-size: 11px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .scenario-chip:hover,
      .scenario-chip:focus-visible {
        background: rgba(167, 139, 250, 0.14); /* light purple wash */
        border-color: rgba(167, 139, 250, 0.75);
        color: #a78bfa; /* hover text */
        outline: none;
        box-shadow: 0 6px 20px rgba(167, 139, 250, 0.28);
      }

      .scenario-chip.active {
        background: linear-gradient(135deg, rgba(167,139,250,0.32), rgba(167,139,250,0.18));
        border-color: rgba(167, 139, 250, 0.85);
        color: #e9d5ff; /* lighter purple when active */
        box-shadow: 0 10px 28px rgba(167,139,250,0.32);
      }

      .card-controls {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .icon-btn {
        width: 30px;
        height: 30px;
        border-radius: 8px;
        border: 1px solid rgba(34, 211, 238, 0.35);
        background: rgba(15, 23, 42, 0.85);
        color: #22d3ee;
        display: grid;
        place-items: center;
        cursor: pointer;
        transition: all 0.18s ease;
      }

      .icon-btn:hover,
      .icon-btn:focus-visible {
        border-color: rgba(14, 165, 233, 0.8);
        color: #0ea5e9;
        box-shadow: 0 8px 20px rgba(14,165,233,0.35);
        outline: none;
      }

      /* Inline tooltips */
      label.has-tip { position: relative; }
      .label-row { display: inline-flex; align-items: center; gap: 8px; }
      .info-wrap { position: relative; display: inline-grid; place-items: center; }
      .info-trigger {
        display: inline-grid;
        place-items: center;
        width: 18px;
        height: 18px;
        border-radius: 999px;
        border: 1px solid rgba(167,139,250,0.6);
        background: radial-gradient(120px 120px at 50% -40%, rgba(167,139,250,0.22), transparent 60%), rgba(32, 35, 60, 0.82);
        color: #c4b5fd;
        font-size: 12px;
        line-height: 1;
        cursor: pointer;
        padding: 0;
        transition: all .18s ease;
      }
      .info-trigger:hover,
      .info-trigger:focus-visible { outline: none; border-color: rgba(167,139,250,0.9); color: #e9d5ff; box-shadow: 0 6px 18px rgba(167,139,250,0.32); }
      .info-bubble {
        position: absolute;
        z-index: 50;
        left: 50%;
        bottom: calc(100% + 8px);
        transform: translateX(-50%);
        min-width: 220px;
        max-width: 320px;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(167,139,250,0.45);
        background: linear-gradient(135deg, rgba(30, 33, 56, 0.96), rgba(22, 25, 46, 0.98));
        color: #e2e8f0;
        box-shadow: 0 12px 28px rgba(20, 17, 40, 0.6), 0 0 0 1px rgba(167,139,250,0.12) inset;
        pointer-events: none;
        opacity: 0;
        transition: opacity .18s ease, transform .18s ease;
      }
      .info-bubble .tip-title { font-size: 11px; letter-spacing: .12em; text-transform: uppercase; color: #c4b5fd; margin: 0 0 6px; }
      .info-bubble .tip-text { font-size: 12px; color: rgba(226,232,240,0.88); margin: 0; line-height: 1.35; }
      .info-bubble .tip-range { display:block; margin-top:6px; font-size:12px; color:#e9d5ff; }
      .info-wrap:hover .info-bubble,
      .info-trigger:focus + .info-bubble,
      .info-wrap:focus-within .info-bubble { opacity: 1; pointer-events: auto; }

      input[type="checkbox"] {
        width: 18px;
        height: 18px;
      }

      input:focus,
      select:focus {
        outline: none;
        border-bottom-color: #0ea5e9;
        color: #f1f5f9;
      }

      .checkbox-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 0;
        margin-top: 10px;
      }

      /* Compact yes/no segmented toggle used in Purchase Details */
      .field-group-header {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 10px;
      }
      .field-group-header .field-group-label { margin: 0; }
      .yesno-toggle {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 2px;
        border-radius: 9999px;
        border: 1px solid rgba(100, 116, 139, 0.35);
        background: rgba(37, 40, 65, 0.6);
      }
      .yesno-toggle .yesno-option {
        position: relative;
        display: inline-flex;
        align-items: center;
        border-radius: 9999px;
        cursor: pointer;
        user-select: none;
      }
      .yesno-toggle .yesno-option input {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
        pointer-events: none;
      }
      .yesno-toggle .yesno-option span {
        display: inline-block;
        padding: 4px 10px;
        font-size: 12px;
        letter-spacing: 0.06em;
        color: rgba(226, 232, 240, 0.82);
        border-radius: 9999px;
      }
      .yesno-toggle .yesno-option input:checked + span {
        color: #0ea5e9;
        background: rgba(14, 165, 233, 0.12);
      }

      /* Space between the header (question + toggle) and the dependent inputs */
      [data-openai-component="purchase-details"] .field-group > .grid {
        margin-top: 18px;
      }

      .checkbox-row input[type="checkbox"] {
        width: 16px;
        height: 16px;
        margin: 0;
      }

      .checkbox-row span {
        font-size: 11px;
        color: rgba(148, 163, 184, 0.75);
        text-transform: none;
        letter-spacing: 0;
      }

      .result-stack {
        display: grid;
        gap: 10px;
      }

      .quick-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 8px 12px;
      }

      .view-container {
        display: grid;
        gap: 16px;
        align-content: start;
      }

      .breakdown-chart canvas {
        width: 100%;
        height: auto;
        aspect-ratio: 1 / 1;
        display: block;
      }

      .breakdown-chart .chart-value {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: #f8fafc;
        font-weight: 700;
        font-size: clamp(22px, 3vw, 34px);
        letter-spacing: -0.015em;
        pointer-events: none;
        z-index: 1;
      }

      .breakdown-chart .chart-value span {
        display: block;
        margin-top: 6px;
        font-size: 12px;
        font-weight: 600;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: rgba(165, 243, 252, 0.5);
      }

      .breakdown-list {
        display: grid;
        gap: 10px;
        align-content: stretch;
        overflow: hidden;
        grid-template-rows: repeat(var(--rows, 5), 1fr);
        touch-action: auto;
      }

      .breakdown-row {
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border-radius: 12px;
        background: linear-gradient(140deg, rgba(28, 34, 64, 0.88), rgba(17, 21, 40, 0.92));
        border: 1px solid rgba(79, 108, 158, 0.28);
        box-shadow: 0 8px 20px rgba(12, 16, 32, 0.32);
        min-height: 0;
      }

      .breakdown-pill {
        width: 34px;
        height: 34px;
        border-radius: 10px;
        display: grid;
        place-items: center;
        font-size: 16px;
        font-weight: 600;
        color: #0f172a;
      }

      .breakdown-pill.primary {
        background: linear-gradient(150deg, rgba(14, 165, 233, 0.95), rgba(14, 165, 233, 0.65));
      }

      .breakdown-pill.accent {
        background: linear-gradient(150deg, rgba(99, 102, 241, 0.9), rgba(59, 130, 246, 0.7));
      }

      .breakdown-pill.subtle {
        background: linear-gradient(150deg, rgba(16, 185, 129, 0.9), rgba(45, 212, 191, 0.7));
      }

      .breakdown-details {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .breakdown-details .label {
        font-size: 13px;
        color: #f8fafc;
        font-weight: 600;
        letter-spacing: 0.05em;
      }

      .breakdown-details .hint {
        font-size: 11px;
        color: rgba(203, 213, 225, 0.72);
        letter-spacing: 0.02em;
        line-height: 1.35;
      }

      .breakdown-row input[type="number"] {
        width: 100px;
        text-align: right;
        font-size: 15px;
        padding: 6px 8px;
        border-radius: 8px;
        border: 1px solid rgba(100, 116, 139, 0.4);
        background: rgba(15, 23, 42, 0.5);
        color: #e2e8f0;
        transition: border-color 0.2s ease, background 0.2s ease;
      }

      .breakdown-row input[type="number"]:focus {
        border-color: #0ea5e9;
        background: rgba(14, 165, 233, 0.1);
        outline: none;
        color: #f1f5f9;
      }

      .breakdown-row .value {
        font-size: 18px;
        font-weight: 700;
        color: #ecfeff;
        text-align: right;
        letter-spacing: -0.015em;
      }

      .breakdown-footnote {
        font-size: 12px;
        color: rgba(148, 163, 184, 0.6);
        letter-spacing: 0;
        line-height: 1.4;
        margin-top: 4px;
      }

      .slide-header h2 {
        margin: 0;
        font-size: 24px;
        font-weight: 600;
        letter-spacing: -0.02em;
        color: #f1f5f9;
      }
      .slide-header {
        position: relative;
        margin: 0;
        padding: 10px 0 0;
      }

      .slide-header p {
        margin: 6px 0 0;
        color: rgba(148, 163, 184, 0.75);
        font-size: 13px;
        line-height: 1.5;
      }

      .header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
      }
      .header-actions {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
      }
      .rate-indicator {
        position: absolute;
        top: 4px;
        right: 0;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .button-row {
        text-align: center;
        padding-top: 8px;
      }

      .cta-button {
        padding: 10px 20px;
        font-size: 13px;
        font-weight: 600;
        border-radius: 999px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        display: inline-block;
        letter-spacing: 0.05em;
      }

      .cta-button.primary {
        background: #0ea5e9;
        color: #0f172a;
        border-color: #0ea5e9;
      }

      .cta-button.primary:hover {
        background: #38bdf8;
        border-color: #38bdf8;
      }

      .cta-button.secondary {
        background: rgba(71, 85, 105, 0.35);
        border: 1px solid rgba(100, 116, 139, 0.6);
        color: #cbd5e1;
        font-size: 12px;
        padding: 8px 16px;
      }

      .cta-button.secondary:hover {
        background: rgba(71, 85, 105, 0.6);
        border-color: rgba(100, 116, 139, 0.8);
      }
      .rate-refresh {
        display: none !important;
      }
      .rate-refresh:hover { background: rgba(14, 165, 233, 0.18); }
      .rate-refresh:focus-visible {
        outline: 2px solid rgba(14, 165, 233, 0.65);
        outline-offset: 2px;
      }
      .rate-refresh svg { width: 16px; height: 16px; }
      .rate-refresh.is-spinning svg {
        animation: rateRefreshSpin 0.9s linear infinite;
      }
      @keyframes rateRefreshSpin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      .rate-badge {
        font-size: 11px;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: #0ea5e9;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid rgba(14, 165, 233, 0.35);
        background: linear-gradient(180deg, rgba(14,165,233,0.18), rgba(14,165,233,0.10));
        line-height: 1.6;
        pointer-events: none;
        display: inline-flex;
        align-items: baseline;
        gap: 6px;
        box-shadow: 0 0 0 1px rgba(14,165,233,0.12) inset, 0 8px 24px rgba(14,165,233,0.12);
      }
      .rate-badge .rate-label { color: rgba(14,165,233,0.78); font-weight: 600; letter-spacing: 0.14em; }
      .rate-badge .rate-num { color: #22d3ee; font-weight: 800; font-size: clamp(16px, 2.4vw, 24px); line-height: 1; letter-spacing: 0.01em; }
      /* Scale badge down in narrow iframe */
      @media (max-width: 820px) {
        .rate-badge { padding: 6px 10px; font-size: 10px; }
        .rate-badge .rate-num { font-size: clamp(14px, 2vw, 20px); }
      }
      @media (max-width: 560px) {
        .rate-badge { display: none; }
      }
      .rate-cta-stack {
        position: absolute;
        right: 0;
        top: 8px;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      .rate-cta {
        background: linear-gradient(135deg, rgba(14,165,233,0.18), rgba(14,165,233,0.06));
        border: 1px solid rgba(14,165,233,0.28);
        color: rgba(226, 244, 255, 0.9);
        padding: 8px 20px;
        font: inherit;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        border-radius: 999px;
        cursor: pointer;
        transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease, border-color 0.18s ease;
        z-index: 1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        line-height: 1.15;
        white-space: nowrap;
        box-shadow: 0 10px 26px rgba(14,165,233,0.18), 0 0 0 1px rgba(14,165,233,0.08) inset;
        backdrop-filter: blur(6px);
      }
      .rate-cta:hover,
      .rate-cta:focus-visible {
        color: #0df9ff;
        border-color: rgba(13, 249, 255, 0.55);
        background: linear-gradient(135deg, rgba(14,165,233,0.26), rgba(34,211,238,0.12));
        box-shadow: 0 14px 32px rgba(14,165,233,0.26);
        transform: translateY(-1px);
        outline: none;
      }
      .rate-cta svg {
        width: 15px;
        height: 15px;
        display: block;
        color: inherit;
        filter: drop-shadow(0 2px 4px rgba(14,165,233,0.35));
      }

      /* Email modal (overlay) */
      .modal-overlay {
        position: fixed;
        inset: 0;
        display: none;
        align-items: flex-start;
        justify-content: center;
        padding-top: var(--modal-top, clamp(24px, 8vh, 72px));
        overflow-y: auto;
        background: rgba(2, 6, 23, 0.66);
        z-index: 9999;
      }
      .modal-dialog {
        width: min(420px, 92vw);
        box-sizing: border-box;
        border-radius: 12px;
        border: 1px solid rgba(71, 85, 105, 0.35);
        background: linear-gradient(135deg, rgba(30, 33, 56, 0.9), rgba(25, 28, 48, 0.95));
        box-shadow: 0 10px 40px rgba(2, 6, 23, 0.6);
        padding: 16px;
        display: grid;
        gap: 12px;
      }
      .modal-dialog h3 {
        margin: 0;
        font-size: 16px;
        letter-spacing: -0.01em;
        color: #e2e8f0;
      }
      .modal-dialog p { margin: 0; color: rgba(148,163,184,0.8); font-size: 13px; }
      .modal-dialog input[type="email"] { display:block; width: 100%; max-width: 100%; box-sizing: border-box; padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(100,116,139,0.35); background: rgba(15,23,42,0.5); color: #e2e8f0; font-size: 14px; }
      .modal-dialog textarea { display:block; width: 100%; max-width: 100%; box-sizing: border-box; padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(100,116,139,0.35); background: rgba(15,23,42,0.5); color: #e2e8f0; font-size: 14px; min-height: 100px; }
      .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 4px; }
      .modal-actions button { background: rgba(37,40,65,0.8); border: 1px solid rgba(100,116,139,0.35); color: rgba(226,232,240,0.92); padding: 8px 12px; font: inherit; font-size: 12px; letter-spacing: 0.08em; text-transform: uppercase; border-radius: 8px; cursor: pointer; }
      .modal-actions button.primary { color: #0ea5e9; border-color: rgba(14,165,233,0.5); background: rgba(14,165,233,0.12); }
      .modal-status { min-height: 18px; font-size: 12px; color: rgba(148,163,184,0.9); }

      /* Add Units button */
      .add-units-btn {
        margin-left: 8px;
        padding: 3px 8px;
        font-size: 10px;
        font-weight: 600;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: rgba(14, 165, 233, 0.95);
        background: rgba(14, 165, 233, 0.1);
        border: 1px solid rgba(14, 165, 233, 0.3);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s;
      }
      .add-units-btn:hover {
        background: rgba(14, 165, 233, 0.2);
        border-color: rgba(14, 165, 233, 0.5);
      }

      /* Unit Rent Modal */
      .unit-rent-modal .modal-dialog {
        width: min(480px, 92vw);
      }
      .unit-rent-list {
        display: grid;
        gap: 8px;
        max-height: 280px;
        overflow-y: auto;
        padding-right: 4px;
      }
      .unit-rent-item {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .unit-rent-item .unit-label {
        font-size: 13px;
        color: rgba(148, 163, 184, 0.9);
        min-width: 60px;
      }
      .unit-rent-item input {
        flex: 1;
        padding: 8px 10px;
        border-radius: 6px;
        border: 1px solid rgba(100, 116, 139, 0.35);
        background: rgba(15, 23, 42, 0.5);
        color: #e2e8f0;
        font-size: 14px;
      }
      .unit-rent-item .remove-unit-btn {
        padding: 6px 8px;
        font-size: 14px;
        color: rgba(239, 68, 68, 0.8);
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.25);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s;
      }
      .unit-rent-item .remove-unit-btn:hover {
        background: rgba(239, 68, 68, 0.2);
        color: #fca5a5;
      }
      .unit-rent-add-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 8px 12px;
        font-size: 12px;
        font-weight: 500;
        color: rgba(74, 222, 128, 0.95);
        background: rgba(34, 197, 94, 0.1);
        border: 1px dashed rgba(34, 197, 94, 0.4);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s;
      }
      .unit-rent-add-btn:hover {
        background: rgba(34, 197, 94, 0.15);
        border-color: rgba(34, 197, 94, 0.6);
      }
      .unit-rent-total {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        background: rgba(14, 165, 233, 0.08);
        border: 1px solid rgba(14, 165, 233, 0.25);
        border-radius: 8px;
        margin-top: 4px;
      }
      .unit-rent-total .total-label {
        font-size: 13px;
        color: rgba(148, 163, 184, 0.9);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .unit-rent-total .total-value {
        font-size: 18px;
        font-weight: 600;
        color: #38bdf8;
      }

      /* Save Calculation Modal */
      .save-calc-modal .modal-dialog {
        width: min(400px, 92vw);
      }
      .save-calc-modal input[type="text"] {
        display: block;
        width: 100%;
        box-sizing: border-box;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid rgba(100, 116, 139, 0.35);
        background: rgba(15, 23, 42, 0.5);
        color: #e2e8f0;
        font-size: 14px;
      }
      .save-calc-modal input[type="text"]::placeholder {
        color: rgba(148, 163, 184, 0.6);
      }

      /* Saved Calculations List */
      .saved-calcs-section {
        margin-top: 16px;
        padding: 12px;
        background: rgba(15, 23, 42, 0.4);
        border: 1px solid rgba(71, 85, 105, 0.3);
        border-radius: 10px;
      }
      .saved-calcs-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
      }
      .saved-calcs-header h4 {
        margin: 0;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: rgba(148, 163, 184, 0.9);
      }
      .saved-calcs-count {
        font-size: 11px;
        padding: 2px 8px;
        background: rgba(14, 165, 233, 0.15);
        color: #38bdf8;
        border-radius: 10px;
      }
      .saved-calcs-list {
        display: grid;
        gap: 8px;
        max-height: 200px;
        overflow-y: auto;
      }
      .saved-calc-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        background: rgba(30, 33, 56, 0.6);
        border: 1px solid rgba(71, 85, 105, 0.3);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.15s;
      }
      .saved-calc-item:hover {
        background: rgba(37, 40, 65, 0.8);
        border-color: rgba(100, 116, 139, 0.4);
      }
      .saved-calc-item.active {
        border-color: rgba(14, 165, 233, 0.5);
        background: rgba(14, 165, 233, 0.08);
      }
      .saved-calc-info {
        flex: 1;
        min-width: 0;
      }
      .saved-calc-name {
        font-size: 13px;
        font-weight: 500;
        color: #e2e8f0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .saved-calc-meta {
        font-size: 11px;
        color: rgba(148, 163, 184, 0.7);
        margin-top: 2px;
      }
      .saved-calc-actions {
        display: flex;
        gap: 4px;
      }
      .saved-calc-actions button {
        padding: 4px 6px;
        font-size: 11px;
        background: rgba(37, 40, 65, 0.8);
        border: 1px solid rgba(100, 116, 139, 0.3);
        color: rgba(148, 163, 184, 0.9);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s;
      }
      .saved-calc-actions button:hover {
        background: rgba(51, 55, 85, 0.9);
        color: #e2e8f0;
      }
      .saved-calc-actions .delete-btn:hover {
        background: rgba(239, 68, 68, 0.2);
        border-color: rgba(239, 68, 68, 0.4);
        color: #fca5a5;
      }
      .saved-calcs-empty {
        text-align: center;
        padding: 16px;
        color: rgba(148, 163, 184, 0.6);
        font-size: 12px;
      }

      /* Saved Calculations Panel */
      .saved-calcs-panel .section-summary {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .saved-calcs-badge {
        font-size: 14px;
        font-weight: 600;
        padding: 3px 10px;
        background: rgba(14, 165, 233, 0.15);
        color: #38bdf8;
        border-radius: 12px;
      }
      .saved-calcs-badge:empty,
      .saved-calcs-badge[data-count="0"] {
        display: none;
      }
      .saved-calcs-list-main {
        display: grid;
        gap: 8px;
      }
      .saved-calcs-list-main .saved-calc-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
        background: rgba(30, 33, 56, 0.5);
        border: 1px solid rgba(71, 85, 105, 0.3);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.15s;
      }
      .saved-calcs-list-main .saved-calc-item:hover {
        background: rgba(37, 40, 65, 0.7);
        border-color: rgba(100, 116, 139, 0.4);
      }
      .saved-calcs-list-main .saved-calc-info {
        flex: 1;
        min-width: 0;
      }
      .saved-calcs-list-main .saved-calc-name {
        font-size: 14px;
        font-weight: 500;
        color: #e2e8f0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .saved-calcs-list-main .saved-calc-meta {
        font-size: 12px;
        color: rgba(148, 163, 184, 0.7);
        margin-top: 3px;
      }
      .saved-calcs-list-main .saved-calc-actions {
        display: flex;
        gap: 6px;
      }
      .saved-calcs-list-main .saved-calc-actions button {
        padding: 6px 10px;
        font-size: 11px;
        font-weight: 500;
        background: rgba(37, 40, 65, 0.8);
        border: 1px solid rgba(100, 116, 139, 0.3);
        color: rgba(148, 163, 184, 0.9);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s;
      }
      .saved-calcs-list-main .saved-calc-actions button:hover {
        background: rgba(51, 55, 85, 0.9);
        color: #e2e8f0;
      }
      .saved-calcs-list-main .saved-calc-actions .load-btn:hover {
        background: rgba(14, 165, 233, 0.15);
        border-color: rgba(14, 165, 233, 0.4);
        color: #38bdf8;
      }
      .saved-calcs-list-main .saved-calc-actions .delete-btn:hover {
        background: rgba(239, 68, 68, 0.15);
        border-color: rgba(239, 68, 68, 0.4);
        color: #fca5a5;
      }

      /* Highlight section action buttons */
      .cashflow-summary {
        position: relative;
      }
      .highlight-actions {
        position: absolute;
        right: 0;
        bottom: 0;
        display: flex;
        gap: 10px;
      }
      .highlight-action-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        padding: 0;
        background: rgba(30, 33, 56, 0.7);
        border: 1px solid rgba(71, 85, 105, 0.4);
        border-radius: 10px;
        color: rgba(148, 163, 184, 0.85);
        cursor: pointer;
        transition: all 0.15s;
      }
      .highlight-action-btn:hover {
        background: rgba(37, 40, 65, 0.9);
        border-color: rgba(100, 116, 139, 0.6);
        color: #e2e8f0;
      }
      .highlight-action-btn svg {
        width: 22px;
        height: 22px;
      }

      .toast-container { position: fixed; right: 16px; bottom: 16px; display: grid; gap: 8px; z-index: 10000; }
      .toast { display: inline-flex; align-items: center; gap: 8px; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(100,116,139,0.35); background: rgba(15,23,42,0.92); color: #e2e8f0; font-size: 12px; letter-spacing: 0.02em; opacity: 0; transform: translateY(6px); transition: opacity .2s ease, transform .2s ease; }
      .toast.show { opacity: 1; transform: translateY(0); }
      .toast.success { border-color: rgba(16,185,129,0.45); color: #a7f3d0; }
      .toast.error { border-color: rgba(239,68,68,0.45); color: #fecaca; }

/* Scoped spacing fixes for breakdown slide */

.carousel-slide[data-card="breakdown"] .slide-header h2 { margin: 0; }

.carousel-slide[data-card="breakdown"] .slide-header p { margin: 0; }

.carousel-slide[data-card="breakdown"] .slide-content > .section-block:first-of-type { margin-top: 0 !important; }

.carousel-slide[data-card="breakdown"] #breakdownChart,

.carousel-slide[data-card="breakdown"] canvas#breakdownChart { margin-top: 0 !important; }

      /* Root-cause fix: prevent this slide from stretching to tallest slide height */
      .carousel-slide[data-card="breakdown"] { align-items: flex-start; }

      /* Ensure the internal grid packs to the top, no vertical distribution */
      .carousel-slide[data-card="breakdown"] .slide-content.breakdown {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        align-content: flex-start;
        row-gap: 8px;
      }

      /* Remove any accidental margins on the first content block */
      .carousel-slide[data-card="breakdown"] .slide-content.breakdown > *:first-child { margin-top: 0 !important; }
      .carousel-slide[data-card="breakdown"] .breakdown-card { margin-top: 0 !important; }
      .carousel-slide[data-card="breakdown"] .slide-content.breakdown > * { margin-block-start: 0 !important; }

      .totals-list {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px 18px;
        font-size: 13px;
        color: rgba(148, 163, 184, 0.9);
      }

      .totals-item {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .totals-item .label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(148, 163, 184, 0.7);
      }

      .totals-item .value {
        color: #e2e8f0;
        font-weight: 600;
      }

      .result-card {
        border-radius: 12px;
        padding: 16px;
        background: linear-gradient(135deg, rgba(30, 33, 56, 0.8), rgba(25, 28, 48, 0.85));
        border: 1px solid rgba(71, 85, 105, 0.3);
        display: grid;
        gap: 8px;
        box-shadow: 0 4px 12px rgba(10, 13, 28, 0.35);
      }

      .result-card .label {
        font-size: 10px;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.65);
        font-weight: 600;
      }

      .result-card .value {
        font-size: 26px;
        font-weight: 700;
        color: #f1f5f9;
        letter-spacing: -0.01em;
      }

      .result-card .sub {
        display: block;
        margin-top: 4px;
        font-size: 16px;
        color: rgba(148, 163, 184, 0.8);
      }

      .result-card .hint {
        font-size: 12px;
        color: rgba(148, 163, 184, 0.6);
        line-height: 1.4;
      }

      .result-card.primary {
        padding: 20px 20px 20px;
        background: linear-gradient(140deg, rgba(14, 165, 233, 0.18), rgba(20, 23, 42, 0.95));
        border: 1px solid rgba(14, 165, 233, 0.4);
        position: relative;
        box-shadow: 0 8px 24px rgba(14, 165, 233, 0.2), 0 0 80px rgba(14, 165, 233, 0.08);
        gap: 10px;
      }

      .result-card.primary .card-header {
        position: absolute;
        top: 20px;
        left: 12px;
        right: auto;
        display: block;
        padding: 0;
        margin: 0;
      }

      .result-card.primary .label {
        color: rgba(148, 163, 184, 0.85);
        font-size: 11px;
        letter-spacing: 0.14em;
        font-weight: 600;
      }

      .result-card.primary .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: #0ea5e9;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid rgba(14, 165, 233, 0.4);
        background: rgba(14, 165, 233, 0.15);
      }

      .result-card.primary .value {
        font-size: 48px;
        font-weight: 700;
        line-height: 1;
        color: #f1f5f9;
        letter-spacing: -0.02em;
      }

      .result-card.secondary {
        background: linear-gradient(135deg, rgba(25, 28, 48, 0.7), rgba(20, 23, 42, 0.75));
        border-color: rgba(71, 85, 105, 0.25);
        padding: 14px;
      }

      .result-card.secondary .value,
      .result-card.secondary .hint {
        font-size: 13px;
        font-weight: 400;
      }

      .result-card.secondary .value {
        color: #f1f5f9;
        font-size: 22px;
      }

      .cta-pill {
        display: flex;
        width: 100%;
        box-sizing: border-box;
        justify-content: center;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        margin: 14px 0 12px;
        border-radius: 12px;
        background: linear-gradient(140deg, rgba(16, 185, 129, 0.18), rgba(12, 18, 34, 0.9));
        color: #eafff2;
        font-weight: 700;
        letter-spacing: 0.02em;
        border: 1px solid rgba(52, 211, 153, 0.45);
        box-shadow: 0 4px 14px rgba(16, 185, 129, 0.18);
        cursor: pointer;
        text-decoration: none;
      }
      .cta-pill:hover { filter: brightness(1.08); border-color: rgba(52, 211, 153, 0.65); }
      .cta-pill svg { width: 16px; height: 16px; opacity: 0.9; }

      .actions {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        font-size: 10px;
        color: rgba(148, 163, 184, 0.75);
        gap: 8px;
      }

      .actions button {
        background: rgba(37, 40, 65, 0.8);
        border: 1px solid rgba(100, 116, 139, 0.35);
        color: rgba(148, 163, 184, 0.9);
        padding: 8px 14px;
        font: inherit;
        font-size: 11px;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        border-radius: 8px;
        transition: all 0.2s ease;
      }

      .actions button:hover,
      .actions button:focus-visible {
        color: #0ea5e9;
        border-color: #0ea5e9;
        background: rgba(14, 165, 233, 0.15);
        box-shadow: 0 4px 14px rgba(14, 165, 233, 0.25);
        outline: none;
      }

      /* Push the buttons as a group to the right: first button gets auto margin */
      #printBtn { margin-left: auto; }
      .actions button svg { width: 14px; height: 14px; margin-right: 6px; display: inline-block; vertical-align: middle; }

      /* Subscribe Banner */
      .subscribe-banner {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin: 6px 0;
        padding: 12px 18px;
        background: linear-gradient(90deg, rgba(14, 165, 233, 0.12), rgba(14, 165, 233, 0.04));
        border: 1px solid rgba(14, 165, 233, 0.18);
        border-radius: 10px;
      }

      .subscribe-banner.is-hidden {
        display: none;
      }

      .subscribe-banner-text {
        font-size: 14px;
        color: rgba(226, 232, 240, 0.9);
        font-weight: 500;
        letter-spacing: 0.01em;
      }

      .subscribe-banner-actions {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-shrink: 0;
      }

      .subscribe-banner-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        font: inherit;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #0f172a;
        background: linear-gradient(180deg, #22d3ee, #0ea5e9);
        border: none;
        border-radius: 999px;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      .subscribe-banner-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4);
      }

      .subscribe-banner-btn svg {
        width: 16px;
        height: 16px;
      }

      .subscribe-banner-close {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        padding: 0;
        background: transparent;
        border: 1px solid rgba(148, 163, 184, 0.3);
        border-radius: 6px;
        color: rgba(148, 163, 184, 0.8);
        cursor: pointer;
        transition: border-color 0.15s ease, color 0.15s ease;
      }

      .subscribe-banner-close:hover {
        border-color: rgba(148, 163, 184, 0.6);
        color: rgba(226, 232, 240, 0.9);
      }

      .subscribe-banner-close svg {
        width: 16px;
        height: 16px;
      }

      @media (max-width: 640px) {
        .subscribe-banner {
          flex-direction: column;
          align-items: stretch;
          gap: 12px;
          text-align: center;
        }

        .subscribe-banner-actions {
          justify-content: center;
        }
      }

      /* Related Calculators Section */
      .related-calculators-section {
        margin-top: 24px;
        padding: 20px;
        background: rgba(30, 41, 59, 0.5);
        border-radius: 16px;
        border: 1px solid rgba(71, 85, 105, 0.3);
      }

      .related-calculators-title {
        font-size: 14px;
        font-weight: 600;
        color: rgba(148, 163, 184, 0.9);
        text-align: center;
        margin-bottom: 16px;
      }

      .related-calculators-grid {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .related-calc-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        font-size: 14px;
        font-weight: 600;
        color: #0ea5e9;
        background: transparent;
        border: 1px solid rgba(14, 165, 233, 0.3);
        border-radius: 999px;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .related-calc-btn:hover {
        background: rgba(14, 165, 233, 0.1);
        border-color: rgba(14, 165, 233, 0.5);
      }

      .related-calc-btn:active {
        transform: scale(0.97);
        background: rgba(14, 165, 233, 0.2);
        border-color: rgba(14, 165, 233, 0.6);
      }

      .related-calc-btn svg {
        width: 18px;
        height: 18px;
      }

      .related-calc-btn-center {
        flex-basis: 100%;
        max-width: 220px;
        justify-content: center;
      }

      @media (max-width: 560px) {
        .related-calculators-grid {
          flex-direction: column;
        }

        .related-calc-btn {
          justify-content: center;
        }

        .related-calc-btn-center {
          max-width: none;
        }
      }

      /* Bottom Action Buttons */
      .bottom-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 24px;
        padding: 20px 0;
        border-top: 1px solid rgba(71, 85, 105, 0.3);
      }

      .bottom-action-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 8px;
        font: inherit;
        font-size: 14px;
        font-weight: 500;
        color: rgba(148, 163, 184, 0.85);
        background: transparent;
        border: none;
        cursor: pointer;
        transition: color 0.15s ease, transform 0.1s ease;
        flex: 1;
      }

      .bottom-action-btn:hover {
        color: rgba(226, 232, 240, 1);
      }

      .bottom-action-btn:active {
        transform: scale(0.95);
        color: #0ea5e9;
      }

      .bottom-action-btn svg {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
      }

      @media (max-width: 560px) {
        .bottom-actions {
          flex-wrap: wrap;
          justify-content: center;
          gap: 8px;
        }

        .bottom-action-btn {
          flex: 0 0 auto;
          padding: 10px 12px;
          font-size: 12px;
        }

        .bottom-action-btn svg {
          width: 16px;
          height: 16px;
        }
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
        font-size: 13px;
      }

      th,
      td {
        padding: 8px 10px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.12);
        text-align: right;
      }

      th {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(226, 232, 240, 0.6);
      }

      td.label {
        text-align: left;
      }

      .schedule-note {
        margin-top: 10px;
        font-size: 12px;
        color: rgba(226, 232, 240, 0.6);
      }

      /* Amortization schedule container: rely on section-block for chrome */
      #schedulePreview {
        overflow: auto;
      }

      @keyframes glow {
        0% {
          box-shadow: 0 0 0 rgba(56, 189, 248, 0);
        }
        40% {
          box-shadow: 0 0 48px rgba(56, 189, 248, 0.45);
        }
        100% {
          box-shadow: 0 0 0 rgba(56, 189, 248, 0);
        }
      }

      .glow-animate {
        animation: glow 1s ease-in-out;
      }

      @media (prefers-reduced-motion: reduce) {
        .glow-animate {
          animation: none !important;
        }
        .carousel-track,
        .carousel-nav {
          transition: none !important;
        }
      }

      @media (max-width: 700px) {
        .breakdown-layout {
          grid-template-columns: 1fr;
          gap: 16px;
        }
      }

      @media (max-width: 560px) {
        body {
          padding: 18px;
        }

        .app {
          padding: 22px;
        }

        button {
          flex: 1 1 100%;
        }

        #cardPrev {
          left: 6px;
        }

        #cardNext {
          right: 6px;
        }

        .breakdown-layout {
          grid-template-columns: 1fr;
          gap: 16px;
        }

        .breakdown-chart {
          padding: 24px;
        }

        .breakdown-chart canvas {
          width: 180px;
          height: 180px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div id="viewsContainer">
        <div class="view-container" id="summaryView">



            <header class="slide-header">
              <h1>The Landlord's Cash Flow Analyzer</h1>
              <p>Aligned with Fannie Mae investment property guidelines.<br />Analyze ROI, cash-on-cash return, cap rate, and 20-year projections.</p>
              <div class="rate-cta-stack">
                <span class="rate-badge" data-openai-component="rate-badge">
                  <span class="rate-label">TODAY'S AVERAGE RATE</span>
                  <span class="rate-num">5%</span>
                </span>
              </div>
            </header>

            <!-- Subscribe Banner -->
            <div class="subscribe-banner" id="subscribeBanner">
              <span class="subscribe-banner-text">Want expert tips to maximize your rental property returns?</span>
              <div class="subscribe-banner-actions">
                <button type="button" class="subscribe-banner-btn" id="subscribeBannerBtn">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="4" width="20" height="16" rx="2"/>
                    <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
                  </svg>
                  Subscribe
                </button>
                <button type="button" class="subscribe-banner-close" id="subscribeBannerClose" aria-label="Dismiss">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 6 6 18"/>
                    <path d="m6 6 12 12"/>
                  </svg>
                </button>
              </div>
            </div>

  <!-- Saved Calculations Section (hidden by default, shown when there are saved items) -->
  <details class="section-block collapsible saved-calcs-panel" id="savedCalcsPanel" data-openai-component="saved-calculations" style="display:none">
    <summary class="section-summary">
      <span class="summary-title">📁 Saved Calculations</span>
      <span class="saved-calcs-badge" id="savedCalcsBadge">0</span>
    </summary>
    <div class="collapsible-content">
      <div class="saved-calcs-list-main" id="savedCalcsListMain"></div>
    </div>
  </details>

  <!-- Rental Property Calculator: New Input Sections -->
  <details class="section-block collapsible" data-openai-component="purchase-details" open>
    <summary class="section-summary">
      <span class="summary-title">🏠 Purchase Details</span>
      <div class="summary-spacer"></div>
    </summary>
    <div class="collapsible-content" style="padding-top: 0;">
      <div class="purchase-header-toggles" aria-label="Purchase toggles" style="margin-bottom: 26px; margin-top: -15px; width: 100%; justify-content: center; background: rgba(2, 6, 23, 0.3); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 6px 0;">
        <div class="row">
          <p class="label">Mode</p>
          <div class="yesno-toggle" role="group" aria-label="Calculator Mode">
            <label class="yesno-option">
              <input type="radio" id="mode_simple" name="calc_mode" value="simple" checked />
              <span>Simple</span>
            </label>
            <label class="yesno-option">
              <input type="radio" id="mode_advanced" name="calc_mode" value="advanced" />
              <span>Advanced</span>
            </label>
          </div>
        </div>
        <div class="row">
          <p class="label">Use Loan?</p>
          <div class="yesno-toggle" role="group" aria-label="Use Loan">
            <label class="yesno-option">
              <input type="radio" id="use_loan_yes" name="use_loan" value="yes" checked />
              <span>Yes</span>
            </label>
            <label class="yesno-option">
              <input type="radio" id="use_loan_no" name="use_loan" value="no" />
              <span>No</span>
            </label>
          </div>
        </div>
        <div class="row" id="need_repairs_row">
          <p class="label">Need Repairs?</p>
          <div class="yesno-toggle" role="group" aria-label="Need Repairs">
            <label class="yesno-option">
              <input type="radio" id="need_repairs_yes" name="need_repairs" value="yes" />
              <span>Yes</span>
            </label>
            <label class="yesno-option">
              <input type="radio" id="need_repairs_no" name="need_repairs" value="no" checked />
              <span>No</span>
            </label>
          </div>
        </div>
      </div>
      <div class="grid duo-columns" id="purchase_inputs_row">
        <label>
          Purchase Price ($)
          <input type="text" id="purchase_price" inputmode="numeric" pattern="[0-9,]*" />
        </label>
        <label>
          <span class="label-row">Additional Closing Cost ($)<span class="estimated-indicator" id="closing_cost_estimated" data-tooltip="Estimated based on purchase price. You can change it."><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>Est.</span></span>
          <input type="text" id="closing_cost" inputmode="numeric" pattern="[0-9,]*" />
        </label>
      </div>
      <!-- Property Tax row - visible only in Simple mode -->
      <div class="grid duo-columns simple-mode-only" id="simple_property_tax_row" style="display:none">
        <label>
          <span class="label-row">Property Tax ($/yr)<span class="estimated-indicator" id="simple_property_tax_estimated" data-tooltip="Estimated based on purchase price. You can change it."><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>Est.</span></span>
          <input type="text" id="simple_property_tax" inputmode="numeric" pattern="[0-9,]*" />
        </label>
        <label style="visibility:hidden">
          <span>&nbsp;</span>
          <input type="text" disabled />
        </label>
      </div>

      <div class="field-group" id="loan_field_group">
        <div class="field-group-header">
          <div class="loan-field preset-inline">
            <select id="loan_preset" aria-label="Preset loan" class="preset-select">
              <option value="">Choose Preset Loan</option>
              <option value="first-time">First-time buyer 3% down</option>
              <option value="conventional-20">20% down conventional</option>
              <option value="va-zero">VA zero-down</option>
            </select>
          </div>
          <!-- VA Disability Toggle (hidden unless VA selected) -->
          <div class="va-disability-toggle" id="vaDisabilityToggle" style="display:none">
            <span class="va-toggle-label">10%+ Veteran's Disability?</span>
            <span class="va-tooltip" data-tooltip="With 10%+ VA disability rating, the 1.25% funding fee is waived.">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
            </span>
            <div class="toggle-group mini">
              <input type="radio" name="va_disability" id="va_disability_yes" value="yes" />
              <label for="va_disability_yes">Yes</label>
              <input type="radio" name="va_disability" id="va_disability_no" value="no" checked />
              <label for="va_disability_no">No</label>
            </div>
          </div>
        </div>
        <div class="grid trio-columns">
          <label class="percent-field loan-field">
            Down Payment (%)
            <input type="number" id="down_payment_pct" min="0" max="75" step="0.1" />
            <div class="slider-row">
              <input type="range" id="loan_dp_slider" min="0" max="75" step="1" aria-label="Down payment percent" />
              <span class="slider-value" id="loan_dp_slider_display">0%</span>
            </div>
          </label>
          <label class="percent-field loan-field">
            Interest Rate (%)
            <input type="number" id="interest_rate_pct" min="0" step="0.01" />
            <div class="slider-row">
              <input type="range" id="loan_rate_slider" min="0" max="15" step="0.05" aria-label="Interest rate percent" />
              <span class="slider-value" id="loan_rate_slider_display">0%</span>
            </div>
          </label>
          <label class="loan-field">
            Loan Term (years)
            <input type="number" id="loan_term_years" min="0" step="1" />
            <div class="slider-row">
              <input type="range" id="loan_term_slider" min="5" max="40" step="1" aria-label="Loan term years" />
              <span class="slider-value" id="loan_term_slider_display">30y</span>
            </div>
          </label>
        </div>
      </div>

      <div class="field-group" id="repairs_field_group">
        <div class="grid duo-columns">
          <label class="repair-field">
            Repair Cost ($)
            <input type="text" id="repair_cost" inputmode="numeric" pattern="[0-9,]*" />
          </label>
          <label class="repair-field">
            Value After Repairs ($)
            <input type="text" id="after_repair_value" inputmode="numeric" pattern="[0-9,]*" />
          </label>
        </div>
      </div>
    </div>
  </details>

  <details class="section-block collapsible" data-openai-component="income-details">
    <summary class="section-summary">💰 Income</summary>
    <div class="collapsible-content">
      <div class="grid trio-columns" style="align-items: end;">
        <div class="inline-pair">
          <label class="pair-col">
            <span class="label-row">Monthly Rent ($)<button type="button" class="add-units-btn" id="addUnitRentBtn">+ Unit Details</button></span>
            <input type="text" id="monthly_rent" inputmode="numeric" pattern="[0-9,]*" />
          </label>
          <label class="pair-col percent-compact">
            <span class="field-helper">Increase /Yr</span>
            <input type="number" id="monthly_rent_increase_pct" min="0" step="0.1" />
          </label>
        </div>
        <div class="inline-pair">
          <label class="pair-col">
            Other income ($/month)
            <input type="text" id="other_monthly_income" inputmode="numeric" pattern="[0-9,]*" />
          </label>
          <label class="pair-col percent-compact">
            <span class="field-helper">Increase /Yr</span>
            <input type="number" id="other_monthly_income_increase_pct" min="0" step="0.1" />
          </label>
        </div>
        <div id="vacancy_rate_wrapper">
          <label class="percent-field">
            Vacancy Rate (%)
            <input type="number" id="vacancy_rate_pct" min="0" max="100" step="0.1" />
          </label>
        </div>
      </div>
    </div>
  </details>

  <details class="section-block collapsible advanced-mode-only" id="operating_expenses_section" data-openai-component="operating-expenses">
    <summary class="section-summary">🔁 Recurring Operating Expenses</summary>
    <div class="collapsible-content">
      <div class="grid duo-columns">
        <div class="inline-pair">
          <label class="pair-col">
            <span class="label-row">Property Tax<span class="estimated-indicator" id="exp_property_tax_estimated" data-tooltip="Estimated based on purchase price. You can change it."><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>Est.</span></span>
            <span class="field-helper">Annual amount ($)</span>
            <input type="text" id="exp_property_tax_annual" inputmode="numeric" pattern="[0-9,]*" />
          </label>
          <label class="pair-col percent-compact">
            <span class="field-helper">Increase /Yr</span>
            <input type="number" id="exp_property_tax_increase_pct" min="0" step="0.1" />
          </label>
        </div>
        <div class="inline-pair">
          <label class="pair-col">
            <span class="label-row">Total Insurance<span class="estimated-indicator" id="exp_insurance_estimated" data-tooltip="Estimated based on purchase price. You can change it."><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>Est.</span></span>
            <span class="field-helper">Annual amount ($)</span>
            <input type="text" id="exp_insurance_annual" inputmode="numeric" pattern="[0-9,]*" />
          </label>
          <label class="pair-col percent-compact">
            <span class="field-helper">Increase /Yr</span>
            <input type="number" id="exp_insurance_increase_pct" min="0" step="0.1" />
          </label>
        </div>
      </div>
      <div class="grid duo-columns">
        <div class="inline-pair">
          <label class="pair-col">
            <span class="label-row">HOA Fee</span>
            <span class="field-helper">Annual amount ($)</span>
            <input type="text" id="exp_hoa_annual" inputmode="numeric" pattern="[0-9,]*" />
          </label>
          <label class="pair-col percent-compact">
            <span class="field-helper">Increase /Yr</span>
            <input type="number" id="exp_hoa_increase_pct" min="0" step="0.1" />
          </label>
        </div>
        <div class="inline-pair">
          <label class="pair-col">
            <span class="label-row">Lawn Care<span class="estimated-indicator" id="exp_lawn_estimated" data-tooltip="Estimated based on purchase price. You can change it."><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>Est.</span></span>
            <span class="field-helper">Annual amount ($)</span>
            <input type="text" id="exp_lawn_annual" inputmode="numeric" pattern="[0-9,]*" />
          </label>
          <label class="pair-col percent-compact">
            <span class="field-helper">Increase /Yr</span>
            <input type="number" id="exp_lawn_increase_pct" min="0" step="0.1" />
          </label>
        </div>
      </div>
      <div class="grid duo-columns">
        <div class="inline-pair">
          <label class="pair-col">
            <span class="label-row">Maintenance</span>
            <span class="field-helper">Annual amount ($)</span>
            <input type="text" id="exp_maintenance_annual" inputmode="numeric" pattern="[0-9,]*" />
          </label>
          <label class="pair-col percent-compact">
            <span class="field-helper">Increase /Yr</span>
            <input type="number" id="exp_maintenance_increase_pct" min="0" step="0.1" />
          </label>
        </div>
        <div class="inline-pair">
          <label class="pair-col">
            <span class="label-row">Water / Sewer<span class="estimated-indicator" id="exp_water_estimated" data-tooltip="Estimated based on purchase price. You can change it."><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>Est.</span></span>
            <span class="field-helper">Annual amount ($)</span>
            <input type="text" id="exp_water_annual" inputmode="numeric" pattern="[0-9,]*" />
          </label>
          <label class="pair-col percent-compact">
            <span class="field-helper">Increase /Yr</span>
            <input type="number" id="exp_water_increase_pct" min="0" step="0.1" />
          </label>
        </div>
      </div>
      <div class="grid duo-columns">
        <div class="inline-pair">
          <label class="pair-col">
            <span class="label-row">Other Costs</span>
            <span class="field-helper">Annual amount ($)</span>
            <input type="text" id="exp_other_annual" inputmode="numeric" pattern="[0-9,]*" />
          </label>
          <label class="pair-col percent-compact">
            <span class="field-helper">Increase /Yr</span>
            <input type="number" id="exp_other_increase_pct" min="0" step="0.1" />
          </label>
        </div>
      </div>
    </div>
  </details>

  <details class="section-block collapsible advanced-mode-only" id="sell_exit_section" data-openai-component="sell-exit-assumptions">
    <summary class="section-summary">
      <span class="summary-title">🚪 Sell / Exit Assumptions</span>
      <div class="summary-spacer"></div>
      <div class="sell-header-toggle" aria-label="Price or Appreciation">
        <div class="yesno-toggle" role="group" aria-label="Price or Appreciation">
          <label class="yesno-option">
            <input type="radio" id="price_mode_price" name="price_mode" value="price" />
            <span>Price</span>
          </label>
          <label class="yesno-option">
            <input type="radio" id="price_mode_appreciation" name="price_mode" value="appreciation" checked />
            <span>Appreciation</span>
          </label>
        </div>
      </div>
    </summary>
    <div class="collapsible-content">
      <div class="grid trio-columns" style="align-items: end; padding-top: 12px;">
        <!-- Column 1 -->
        <div style="position: relative; display: flex; flex-direction: column; justify-content: flex-end; margin-top: 0;">
          <label class="sell-price-field" style="margin-top: 0;">
            Sale Price ($)
            <input type="text" id="sell_price" inputmode="numeric" pattern="[0-9,]*" />
          </label>
          <label class="percent-field appreciation-field" style="margin-top: 0;">
            Value Appreciation (% per year)
            <input type="number" id="value_appreciation_pct" min="0" step="0.1" />
          </label>
        </div>

        <!-- Column 2 -->
        <label>
          Holding Length (years)
          <input type="number" id="holding_length_years" min="0" step="1" />
        </label>

        <!-- Column 3 -->
        <label class="percent-field">
          Cost to Sell (%)
          <input type="number" id="cost_to_sell_pct" min="0" step="0.1" />
        </label>
      </div>
    </div>
  </details>

  <!-- Restore original loan basics block -->
  <section class="section-block is-hidden" data-openai-component="loan-input-form" aria-hidden="true">
    <div class="section-title">Loan basics</div>
    <div class="scenario-bar" id="scenarioBar">
      <button type="button" class="scenario-chip" data-scenario="first-time">First-time buyer 3% down</button>
      <button type="button" class="scenario-chip" data-scenario="conventional">20% down conventional</button>
      <button type="button" class="scenario-chip" data-scenario="va">VA zero-down</button>
    </div>
    <div class="grid">
      <label>
        Loan program
        <select id="loan_type">
          <option value="conventional">Conventional</option>
          <option value="FHA">FHA</option>
          <option value="VA">VA</option>
          <option value="USDA">USDA</option>
        </select>
      </label>
      <label>
        Home value ($)
        <input type="number" id="home_value" min="0" step="1000" />
        <span class="field-message" data-field-error="home_value"></span>
      </label>
      <label>
        Down payment ($)
        <input type="number" id="down_payment_value" min="0" step="1000" />
        <span class="field-message" data-field-error="down_payment_value"></span>
        <div class="slider-row">
          <input type="range" id="down_payment_slider" min="0" max="80" step="1" aria-label="Down payment percent" />
          <span class="slider-value" id="down_payment_slider_display">0%</span>
        </div>
      </label>
      <label class="percent-field">
        Rate (APR %)
        <input type="number" id="rate_apr" min="0" step="0.01" />
        <span class="field-message" data-field-error="rate_apr"></span>
        <div class="slider-row">
          <input type="range" id="rate_slider" min="0" max="12" step="0.05" aria-label="Rate percent" />
          <span class="slider-value" id="rate_slider_display">0%</span>
        </div>
      </label>
      <label>
        Term (years)
        <input type="number" id="term_years" min="1" step="1" />
        <span class="field-message" data-field-error="term_years"></span>
        <div class="slider-row">
          <input type="range" id="term_slider" min="5" max="40" step="1" aria-label="Term years" />
          <span class="slider-value" id="term_slider_display">30y</span>
        </div>
      </label>
    </div>
  </section>

                <details class="section-block collapsible is-hidden" id="propertyMortgageFees" aria-hidden="true">
                  <summary class="section-summary">Property, mortgage, and fees</summary>
                  <div class="collapsible-content">
                    <div class="field-group">
                      <p class="field-group-label"><span class="icon">🏠</span> My information</p>
                      <div class="grid duo-columns">
                        <label>
                          ZIP code
                          <span class="field-helper">Location for tax estimates</span>
                          <input type="text" id="zip_code" inputmode="numeric" pattern="\d*" maxlength="9" placeholder="e.g. 94043" />
                        </label>
                        <label>
                          Credit score
                          <span class="field-helper">Affects interest rate</span>
                          <select id="credit_score">
                            <option value="">Select</option>
                            <option value="760+">760+</option>
                            <option value="720-759">720-759</option>
                            <option value="680-719">680-719</option>
                            <option value="640-679">640-679</option>
                            <option value="600-639">600-639</option>
                            <option value="<600">Below 600</option>
                          </select>
                        </label>
                      </div>
                    </div>

                    <div class="field-group">
                      <p class="field-group-label"><span class="icon">📍</span> Property information</p>
                      <div class="grid trio-columns">
                        <label class="percent-field has-tip">
                          <span class="label-row">Property tax <span class="info-wrap"><button type="button" class="info-trigger" aria-label="What is this?" title="What is this?">i</button><div class="info-bubble" role="tooltip">
                            <p class="tip-title">What is this?</p>
                            <p class="tip-text">Annual property tax as a percent of the assessed home value. Jurisdictions vary widely.</p>
                            <span class="tip-range">Typical range: 0.5%–2.5% yearly</span>
                          </div></span></span>
                          <span class="field-helper">Annual % of assessed value</span>
                          <input type="number" id="property_tax_input" min="0" step="0.01" />
                        </label>
                        <label class="has-tip">
                          <span class="label-row">Homeowners insurance <span class="info-wrap"><button type="button" class="info-trigger" aria-label="What is this?" title="What is this?">i</button><div class="info-bubble" role="tooltip">
                            <p class="tip-title">What is this?</p>
                            <p class="tip-text">Annual premium for hazard insurance that protects your home and belongings.</p>
                            <span class="tip-range">Typical range: $800–$2,500 per year (≈0.2%–0.5% of value)</span>
                          </div></span></span>
                          <span class="field-helper">Annual cost in dollars</span>
                          <input type="number" id="homeowners_insurance_yearly" min="0" step="50" />
                        </label>
                        <label class="has-tip">
                          <span class="label-row">HOA dues <span class="info-wrap"><button type="button" class="info-trigger" aria-label="What is this?" title="What is this?">i</button><div class="info-bubble" role="tooltip">
                            <p class="tip-title">What is this?</p>
                            <p class="tip-text">Monthly fee charged by a homeowners association for shared services and amenities.</p>
                            <span class="tip-range">Typical range: $0–$600 per month (many condos $200–$400)</span>
                          </div></span></span>
                          <span class="field-helper">Monthly cost in dollars</span>
                          <input type="number" id="hoa_monthly" min="0" step="10" />
                        </label>
                      </div>
                    </div>

                    <div class="field-group">
                      <p class="field-group-label"><span class="icon">💳</span> Mortgage insurance & fees</p>
                      <div class="grid trio-columns">
                        <label class="percent-field has-tip">
                          <span class="label-row">PMI <span class="info-wrap"><button type="button" class="info-trigger" aria-label="What is this?" title="What is this?">i</button><div class="info-bubble" role="tooltip">
                            <p class="tip-title">What is this?</p>
                            <p class="tip-text">Private Mortgage Insurance for conventional loans when down payment &lt; 20% (LTV &gt; 80%).</p>
                            <span class="tip-range">Typical range: 0.2%–1.5% of loan balance yearly</span>
                          </div></span></span>
                          <span class="field-helper">Annual % (conventional only)</span>
                          <input type="number" id="pmi_pct" min="0" step="0.01" />
                        </label>
                        <label class="percent-field" data-mi-only>
                          Annual MI fee
                          <span class="field-helper">% of remaining balance</span>
                          <input type="number" id="annual_mi_pct" min="0" step="0.01" />
                        </label>
                        <label class="percent-field">
                          Upfront fee
                          <span class="field-helper">% of base loan amount</span>
                          <input type="number" id="upfront_fee_pct" min="0" step="0.01" />
                          <div class="checkbox-row">
                            <input type="checkbox" id="finance_upfront_fee" />
                            <span>Add fee to principal balance</span>
                          </div>
                        </label>
                      </div>
                    </div>

                    <div class="field-group">
                      <p class="field-group-label"><span class="icon">⚙️</span> Advanced options</p>
                      <div class="grid duo-columns">
                        <label>
                          First payment month
                          <span class="field-helper">1-12 for Jan-Dec</span>
                          <input type="number" id="start_month" min="1" max="12" step="1" />
                          <span class="field-message" data-field-error="start_month"></span>
                        </label>
                        <label>
                          First payment year
                          <span class="field-helper">Year of first payment</span>
                          <input type="number" id="start_year" min="2024" step="1" />
                          <span class="field-message" data-field-error="start_year"></span>
                        </label>
                        <label>
                          Extra payment
                          <span class="field-helper">Additional monthly principal</span>
                          <input type="number" id="extra_principal_monthly" min="0" step="50" />
                        </label>
                        <label>
                          Extra starts at month
                          <span class="field-helper">Month index when extra begins</span>
                          <input type="number" id="extra_start_month_index" min="0" step="1" />
                        </label>
                      </div>
                    </div>
                  </div>
                </details>

                <div class="result-stack">
                  <div class="result-card primary" id="monthlyPaymentCard" data-openai-component="monthly-summary-card">
                    <div class="card-header">
                      <div class="card-controls">
                      </div>
                    </div>
                    <!-- Deal Quality Indicator -->
                    <div class="deal-indicator good" id="dealIndicator">
                      <span class="deal-emoji" id="dealIconGood">😊</span>
                      <span class="deal-emoji" id="dealIconMediocre" style="display:none">😐</span>
                      <span class="deal-emoji" id="dealIconBad" style="display:none">😢</span>
                      <span id="dealLabel">Good Deal</span>
                    </div>
                    <!-- Cashflow-focused summary -->
                    <div class="cashflow-summary">
                      <div class="cashflow-main">
                        <div class="label">Year 1 Cashflow</div>
                        <div class="cashflow-values">
                          <span class="value-primary positive" id="year1_cashflow_monthly" aria-live="polite">$0<span class="period-label">/mo</span></span>
                          <span class="value-secondary positive" id="year1_cashflow_value" aria-live="polite">$0<span class="period-label">/yr</span></span>
                        </div>
                      </div>
                      <div class="income-row cap-rate-row">
                        <span>Cap Rate:</span>
                        <span class="cap-rate-value" id="cap_rate_value">0%</span>
                      </div>
                      <!-- Highlight action buttons -->
                      <div class="highlight-actions">
                        <button type="button" class="highlight-action-btn" id="highlightPrintBtn" title="Print">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 6 2 18 2 18 9"/>
                            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                            <rect width="12" height="8" x="6" y="14"/>
                          </svg>
                        </button>
                        <button type="button" class="highlight-action-btn" id="highlightSaveBtn" title="Save">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                            <polyline points="17 21 17 13 7 13 7 21"/>
                            <polyline points="7 3 7 8 15 8"/>
                          </svg>
                        </button>
                      </div>
                      <!-- Breakeven price row (hidden when cashflow positive) -->
                      <div class="breakeven-row" id="breakevenRow" style="display:none">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <span>Breakeven at <span class="breakeven-price" id="breakevenPrice">$0</span> purchase price</span>
                      </div>
                    </div>
                    <span id="total_monthly_0" style="display:none"></span>
                  </div>

                  <a class="cta-pill" id="showBreakdownBtn" href="#">See Advanced Calculations
                    <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
                  </a>

                  <!-- Related Calculators Section -->
                  <div class="related-calculators-section">
                    <div class="related-calculators-title">Related Calculators</div>
                    <div class="related-calculators-grid">
                      <a href="#" class="related-calc-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                          <polyline points="17 6 23 6 23 12"/>
                        </svg>
                        Retirement Calculator
                      </a>
                      <a href="#" class="related-calc-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <circle cx="12" cy="12" r="10"/>
                          <circle cx="12" cy="12" r="6"/>
                          <circle cx="12" cy="12" r="2"/>
                        </svg>
                        Mortgage Calculator
                      </a>
                      <a href="#" class="related-calc-btn related-calc-btn-center">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        Investment Calculator
                      </a>
                    </div>
                  </div>

                  <!-- Bottom Action Buttons -->
                  <div class="bottom-actions">
                    <button type="button" class="bottom-action-btn" id="subscribeBtnBottom">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="4" width="20" height="16" rx="2"/>
                        <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
                      </svg>
                      Subscribe
                    </button>
                    <button type="button" class="bottom-action-btn" id="resetBtn">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                        <path d="M21 3v5h-5"/>
                        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                        <path d="M8 16H3v5"/>
                      </svg>
                      Reset
                    </button>
                    <button type="button" class="bottom-action-btn" id="donateBtn">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>
                      </svg>
                      Donate
                    </button>
                    <button type="button" class="bottom-action-btn" id="saveCalcBtn">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                        <polyline points="17 21 17 13 7 13 7 21"/>
                        <polyline points="7 3 7 8 15 8"/>
                      </svg>
                      Save
                    </button>
                    <button type="button" class="bottom-action-btn" id="feedbackBtn">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect width="18" height="14" x="3" y="4" rx="2"/>
                        <path d="M3 8h18"/>
                        <path d="M10 4v4"/>
                        <path d="M16 4v4"/>
                      </svg>
                      Feedback
                    </button>
                    <button type="button" class="bottom-action-btn" id="printBtn" onclick="window.print()">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 6 2 18 2 18 9"/>
                        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                        <rect width="12" height="8" x="6" y="14"/>
                      </svg>
                      Print
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="view-container is-hidden" id="breakdownView">
            <header>
              <div class="header-row">
                <h2>Outputs</h2>
                <div class="button-row" id="showSummaryBtn">
                  <button type="button" class="cta-button secondary">&larr; Back to Inputs</button>
                </div>
              </div>
              <p>Key performance metrics with first-year details.</p>
            </header>
            <div class="section-block">
              <div class="outputs-vertical">
                <section class="section-block">
                  <div class="section-title">First-Year Income & Expenses</div>
                  <div class="year1-grid">
                    <div class="kpi-main">
                      <div class="kpi-item">
                        <span class="kpi-label">Year 1 Cash Flow</span>
                        <span class="kpi-number" id="kpi_cashflow_annual">$0</span>
                        <span class="kpi-sub" id="kpi_cashflow_monthly">— /mo</span>
                      </div>
                      <div class="kpi-item">
                        <span class="kpi-label">Year 1 Income</span>
                        <span class="kpi-number" id="kpi_income_annual">$0</span>
                        <span class="kpi-sub" id="kpi_income_monthly">— /mo</span>
                      </div>
                    </div>
                    <div class="donut-row">
                      <canvas id="expenseDonut"></canvas>
                      <div class="donut-legend" id="expenseLegend"></div>
                    </div>
                    <div class="metrics-table-wrap">
                      <table class="metrics-table">
                        <thead>
                          <tr>
                            <th>Year 1 Data</th>
                            <th>Monthly</th>
                            <th>Annual</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td>Income</td>
                            <td id="y1_income_monthly">$0</td>
                            <td id="y1_income_annual">$0</td>
                          </tr>
                          <tr>
                            <td>Mortgage (P&I)</td>
                            <td id="y1_mortgage_monthly">$0</td>
                            <td id="y1_mortgage_annual">$0</td>
                          </tr>
                          <tr>
                            <td>Vacancy</td>
                            <td id="y1_vacancy_monthly">$0</td>
                            <td id="y1_vacancy_annual">$0</td>
                          </tr>
                          <tr>
                            <td>Property tax</td>
                            <td id="y1_tax_monthly">$0</td>
                            <td id="y1_tax_annual">$0</td>
                          </tr>
                          <tr>
                            <td>Insurance</td>
                            <td id="y1_insurance_monthly">$0</td>
                            <td id="y1_insurance_annual">$0</td>
                          </tr>
                          <tr>
                            <td>Maintenance</td>
                            <td id="y1_maintenance_monthly">$0</td>
                            <td id="y1_maintenance_annual">$0</td>
                          </tr>
                          <tr>
                            <td>Other expenses</td>
                            <td id="y1_other_monthly">$0</td>
                            <td id="y1_other_annual">$0</td>
                          </tr>
                          <tr>
                            <td>Cash flow</td>
                            <td id="y1_cashflow_monthly">$0</td>
                            <td id="y1_cashflow_annual">$0</td>
                          </tr>
                          <tr>
                            <td>NOI</td>
                            <td id="y1_noi_monthly">$0</td>
                            <td id="y1_noi_annual">$0</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </section>
                <section class="section-block">
                  <div class="section-title">20-Year Investment Summary</div>
                  <div class="grid three-col">
                    <div class="metric"><span class="label">Total rent collected</span><span class="value" id="out_total_rent">$0</span></div>
                    <div class="metric"><span class="label">Total mortgage paid (P&I)</span><span class="value" id="out_total_mortgage">$0</span></div>
                    <div class="metric"><span class="label">Total operating expenses</span><span class="value" id="out_total_expenses">$0</span></div>
                    <div class="metric"><span class="label">Total NOI</span><span class="value" id="out_total_noi">$0</span></div>
                    <div class="metric"><span class="label">Total profit when sold</span><span class="value" id="out_total_profit">$0</span></div>
                    <div class="metric"><span class="label">Cash-on-cash return</span><span class="value" id="out_coc">0%</span></div>
                    <div class="metric"><span class="label">Cap rate</span><span class="value" id="out_cap_rate">0%</span></div>
                    <div class="metric"><span class="label">IRR</span><span class="value" id="out_irr">0%</span></div>
                  </div>
                </section>
                <div class="button-row" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; width: 100%;">
                  <button type="button" class="cta-pill" id="backToInputsBtnBottom" style="margin: 0; width: auto;">
                    <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 16px; height: 16px; transform: rotate(180deg);">
                      <path fill="currentColor" d="M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z" />
                    </svg>Go Back to Inputs
                  </button>
                  <button type="button" class="cta-pill" id="showAmortizationBtn" style="margin: 0; width: auto;">
                    View Year-by-Year Breakdown
                    <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 16px; height: 16px;">
                      <path fill="currentColor" d="M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>
        </div>
        <div class="view-container is-hidden" id="amortizationView">
            <header>
              <h2>Breakdown Over Time (Year-by-Year)</h2>
              <div class="header-row">
                <p>Annual rollup of income, expenses, cash flow, returns, and equity.</p>
                <div class="header-actions">
                  <div class="button-row" id="showAmortizationSummaryBtn">
                    <button type="button" class="cta-button secondary">&larr; Back to Inputs</button>
                  </div>
                  <div class="button-row">
                    <button type="button" class="cta-button secondary" id="backToBreakdownBtn">&larr; Back to Breakdown</button>
                  </div>
                </div>
              </div>
            </header>
            <section class="section-block">
              <table class="yearly-table" id="overTimeTable">
                <thead>
                  <tr>
                    <th>Year</th>
                    <th>Income</th>
                    <th>Expenses</th>
                    <th>Cash Flow</th>
                    <th>Cap Rate</th>
                    <th>CoC Return</th>
                    <th>Equity</th>
                    <th>Loan Bal</th>
                    <th>Prop Value</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </section>
            <div class="button-row" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; width: 100%; margin-top: 20px;">
              <button type="button" class="cta-pill" id="backToInputsBtnSlide3" style="margin: 0; width: auto;">
                <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 16px; height: 16px; transform: rotate(180deg);">
                  <path fill="currentColor" d="M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z" />
                </svg>Go Back to Inputs
              </button>
              <button type="button" class="cta-pill" id="backToBreakdownBtnSlide3" style="margin: 0; width: auto;">
                <svg viewBox="0 0 24 24" aria-hidden="true" style="width: 16px; height: 16px; transform: rotate(180deg);">
                  <path fill="currentColor" d="M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z" />
                </svg>Back to Breakdown
              </button>
            </div>
        </div>
      </div>

    <script type="module">
      (function () {
        const MONTHS_IN_YEAR = 12;
        const ZERO_TOLERANCE = 1e-8;

        const toNumber = (value) => {
          // Strip commas before parsing to handle formatted currency inputs
          const cleaned = String(value).replace(/,/g, '');
          const num = Number(cleaned);
          return Number.isFinite(num) ? num : 0;
        };

        // Track if user manually edits fields so derived defaults stop auto-updating
        let taxEdited = false;
        let closingEdited = false;
        let rateEdited = false;
        let insuranceEdited = false;
        let waterEdited = false;
        let lawnEdited = false;

        const clampNonNegative = (value) => {
          const num = toNumber(value);
          return num < 0 ? 0 : num;
        };

        const normalizeMonth = (month) => {
          const m = Math.round(toNumber(month));
          if (Number.isNaN(m) || m <= 0) return 1;
          if (m > 12) {
            return ((m - 1) % 12) + 1;
          }
          return m;
        };

        const normalizeYear = (year) => {
          const y = Math.round(toNumber(year));
          return y > 0 ? y : new Date().getFullYear();
        };

        function compute_base_loan_amount(home_value, down_payment_value, down_payment_pct) {
          const hv = clampNonNegative(home_value);
          const dpValueInput = toNumber(down_payment_value);
          const dpPctInput = clampNonNegative(down_payment_pct);

          let loan_amount_base;
          let effectiveDpValue;
          let effectiveDpPct;

          // If both down payment fields provided, prefer down_payment_value
          if (dpValueInput > 0) {
            effectiveDpValue = Math.min(dpValueInput, hv); // Don't allow down payment > home value
            loan_amount_base = hv - effectiveDpValue;
            effectiveDpPct = hv > 0 ? effectiveDpValue / hv : 0;
          } else {
            effectiveDpPct = Math.min(dpPctInput, 1.0); // Don't allow down payment % > 100%
            effectiveDpValue = hv * effectiveDpPct;
            loan_amount_base = hv * (1 - effectiveDpPct);
          }

          return {
            loan_amount_base: clampNonNegative(loan_amount_base),
            down_payment_value: effectiveDpValue,
            down_payment_pct: effectiveDpPct,
          };
        }

        function apply_upfront_fee(loan_amount_base, upfront_fee_pct, finance_upfront_fee) {
          const base = clampNonNegative(loan_amount_base);
          const feePct = clampNonNegative(upfront_fee_pct);
          const upfront_fee = base * feePct;
          const financed = Boolean(finance_upfront_fee);
          const principal_0 = financed ? base + upfront_fee : base;
          const cash_at_close_upfront_fee = financed ? 0 : upfront_fee;

          return {
            principal_0,
            upfront_fee,
            cash_at_close_upfront_fee,
          };
        }

        function normalize_property_tax(property_tax_input, home_value) {
          const hv = clampNonNegative(home_value);
          const input = clampNonNegative(property_tax_input);

          if (input <= 20) {
            return {
              property_tax_yearly: hv * (input / 100),
              property_tax_mode: "percent",
            };
          }

          return {
            property_tax_yearly: input,
            property_tax_mode: "absolute",
          };
        }

        function monthly_p_and_i(principal_0, rate_apr, term_years) {
          const principal = clampNonNegative(principal_0);
          const termYears = clampNonNegative(term_years);
          const n = Math.max(Math.round(termYears * MONTHS_IN_YEAR), 0);

          if (n === 0 || principal === 0) {
            return 0;
          }

          const yearlyRate = clampNonNegative(rate_apr);
          const i_m = yearlyRate / MONTHS_IN_YEAR;

          if (i_m > 0) {
            const denominator = 1 - Math.pow(1 + i_m, -n);
            if (denominator === 0) {
              return principal / n;
            }
            return principal * i_m / denominator;
          } else {
            return principal / n;
          }
        }

        function monthly_mi(principal_t, loan_type, home_value, pmi_pct, annual_mi_pct) {
          const principal = clampNonNegative(principal_t);
          const hv = clampNonNegative(home_value);

          switch (loan_type) {
            case "conventional":
              if (hv === 0) return 0;
              const ltv = principal / hv;
              if (ltv <= 0.8) return 0;
              return (clampNonNegative(pmi_pct) / MONTHS_IN_YEAR) * principal;

            case "FHA":
              return (clampNonNegative(annual_mi_pct) / MONTHS_IN_YEAR) * principal;

            case "VA":
              return 0;

            case "USDA":
              return (clampNonNegative(annual_mi_pct) / MONTHS_IN_YEAR) * principal;

            default:
              return 0;
          }
        }

        const createStartDate = (start_month, start_year) =>
          new Date(normalizeYear(start_year), normalizeMonth(start_month) - 1, 1);

        const advanceOneMonth = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 1);

        function amortize_monthly(
          principal_0,
          i_m,
          n,
          start_month,
          start_year,
          tax_monthly,
          ins_monthly,
          hoa_monthly,
          home_value,
          loan_type,
          pmi_pct,
          annual_mi_pct,
          p_and_i,
          extra_principal_monthly = 0,
          extra_start_month_index = 0
        ) {
          let principal = clampNonNegative(principal_0);
          let currentDate = createStartDate(start_month, start_year);
          const totalPeriods = Math.max(Math.round(toNumber(n)), 0);
          const extraStartIndex = Math.max(Math.round(toNumber(extra_start_month_index)), 0);

          const totals = {
            interest: 0,
            tax: 0,
            ins: 0,
            hoa: 0,
            mi: 0,
            principal: 0,
            payments: 0,
          };

          const schedule = [];

          for (let t = 0; t < totalPeriods && principal > ZERO_TOLERANCE; t += 1) {
            const interest = principal * clampNonNegative(i_m);
            const principal_sched = Math.max(p_and_i - interest, 0);

            const mi = monthly_mi(principal, loan_type, home_value, pmi_pct, annual_mi_pct);

            const tax = clampNonNegative(tax_monthly);
            const ins = clampNonNegative(ins_monthly);
            const hoa_v = clampNonNegative(hoa_monthly);

            const extra = t >= extraStartIndex ? clampNonNegative(extra_principal_monthly) : 0;

            const principal_reduction = principal_sched + extra;
            const principal_next = Math.max(principal - principal_reduction, 0);

            totals.interest += interest;
            totals.tax += tax;
            totals.ins += ins;
            totals.hoa += hoa_v;
            totals.mi += mi;
            totals.principal += principal_reduction;
            totals.payments += p_and_i + mi + tax + ins + hoa_v + extra;

            schedule.push({
              index: t,
              date: {
                year: currentDate.getFullYear(),
                month: currentDate.getMonth() + 1,
              },
              opening_balance: principal,
              p_and_i,
              interest,
              principal_scheduled: principal_sched,
              extra_principal: extra,
              mi,
              tax,
              ins,
              hoa: hoa_v,
              total_payment: p_and_i + mi + tax + ins + hoa_v + extra,
              closing_balance: principal_next,
            });

            principal = principal_next;
            currentDate = advanceOneMonth(currentDate);

            if (principal <= ZERO_TOLERANCE) {
              principal = 0;
              break;
            }
          }

          const payoff_date = schedule.length
            ? schedule[schedule.length - 1].date
            : {
                year: normalizeYear(start_year),
                month: normalizeMonth(start_month),
              };

          return { schedule, payoff_date, totals };
        }

        function summarize_outputs(schedule, totals, p_and_i, tax_monthly, ins_monthly, hoa, principal_0, mi0) {
          const total_monthly_0 = p_and_i + tax_monthly + ins_monthly + hoa + mi0;

          const payoff_date = schedule.length
            ? schedule[schedule.length - 1].date
            : null;

          return {
            total_monthly_0,
            payoff_date,
            total_interest: totals.interest,
            total_tax: totals.tax,
            total_ins: totals.ins,
            total_hoa: totals.hoa,
            total_mi: totals.mi,
            total_of_payments: totals.payments,
            total_principal: totals.principal,
            payments_made: schedule.length,
            schedule,
          };
        }

        function calculate_mortgage(params) {
          const {
            loan_type,
            home_value,
            down_payment_value,
            down_payment_pct,
            rate_apr,
            term_years,
            start_month,
            start_year,
            property_tax_input,
            homeowners_insurance_yearly,
            hoa_monthly,
            upfront_fee_pct,
            annual_mi_pct,
            finance_upfront_fee,
            extra_principal_monthly,
            extra_start_month_index,
            pmi_pct,
          } = params;

          const baseLoan = compute_base_loan_amount(home_value, down_payment_value, down_payment_pct);
          const feeResult = apply_upfront_fee(
            baseLoan.loan_amount_base,
            clampNonNegative(upfront_fee_pct),
            finance_upfront_fee
          );
          const taxInfo = normalize_property_tax(property_tax_input, home_value);

          const tax_monthly = taxInfo.property_tax_yearly / MONTHS_IN_YEAR;
          const ins_monthly = clampNonNegative(homeowners_insurance_yearly) / MONTHS_IN_YEAR;
          const hoa = clampNonNegative(hoa_monthly);
          const n = Math.max(Math.round(clampNonNegative(term_years) * MONTHS_IN_YEAR), 0);
          const i_m = clampNonNegative(rate_apr) / MONTHS_IN_YEAR;
          const p_and_i = monthly_p_and_i(feeResult.principal_0, rate_apr, term_years);

          const loanType = typeof loan_type === "string" ? loan_type : "conventional";
          const pmiPct = clampNonNegative(pmi_pct);
          const annualMiPct = clampNonNegative(annual_mi_pct);

          const amortization = amortize_monthly(
            feeResult.principal_0,
            i_m,
            n,
            start_month,
            start_year,
            tax_monthly,
            ins_monthly,
            hoa,
            home_value,
            loanType,
            pmiPct,
            annualMiPct,
            p_and_i,
            extra_principal_monthly,
            extra_start_month_index
          );

          const monthly_mi_initial = monthly_mi(feeResult.principal_0, loanType, home_value, pmiPct, annualMiPct);

          const totalsSummary = summarize_outputs(
            amortization.schedule,
            amortization.totals,
            p_and_i,
            tax_monthly,
            ins_monthly,
            hoa,
            feeResult.principal_0,
            monthly_mi_initial
          );

          return {
            inputs: {
              loan_type: loanType,
              home_value: clampNonNegative(home_value),
              down_payment_value: baseLoan.down_payment_value,
              down_payment_pct: baseLoan.down_payment_pct,
              rate_apr: clampNonNegative(rate_apr),
              term_years: clampNonNegative(term_years),
              start_month: normalizeMonth(start_month),
              start_year: normalizeYear(start_year),
              property_tax_input: clampNonNegative(property_tax_input),
              homeowners_insurance_yearly: clampNonNegative(homeowners_insurance_yearly),
              hoa_monthly: hoa,
              upfront_fee_pct: clampNonNegative(upfront_fee_pct),
              annual_mi_pct: annualMiPct,
              finance_upfront_fee: Boolean(finance_upfront_fee),
              extra_principal_monthly: clampNonNegative(extra_principal_monthly),
              extra_start_month_index: Math.max(Math.round(toNumber(extra_start_month_index)), 0),
              pmi_pct: pmiPct,
            },
            derived: {
              loan_amount_base: baseLoan.loan_amount_base,
              principal_0: feeResult.principal_0,
              upfront_fee: feeResult.upfront_fee,
              cash_at_close_upfront_fee: feeResult.cash_at_close_upfront_fee,
              property_tax_yearly: taxInfo.property_tax_yearly,
              property_tax_mode: taxInfo.property_tax_mode,
              tax_monthly,
              ins_monthly,
              hoa_monthly: hoa,
              p_and_i,
              monthly_mi_initial,
              total_monthly_0: totalsSummary.total_monthly_0,
            },
            payoff_date: totalsSummary.payoff_date,
            totals: {
              total_interest: totalsSummary.total_interest,
              total_tax: totalsSummary.total_tax,
              total_ins: totalsSummary.total_ins,
              total_hoa: totalsSummary.total_hoa,
              total_mi: totalsSummary.total_mi,
              total_of_payments: totalsSummary.total_of_payments,
              total_principal: totalsSummary.total_principal,
              payments_made: totalsSummary.payments_made,
            },
            schedule: totalsSummary.schedule,
          };
        }

        const mortgageCalculator = Object.freeze({
          compute_base_loan_amount,
          apply_upfront_fee,
          normalize_property_tax,
          monthly_p_and_i,
          monthly_mi,
          amortize_monthly,
          summarize_outputs,
          calculate_mortgage,
        });

        globalThis.mortgageCalculator = mortgageCalculator;

        const $ = (id) => document.getElementById(id);
        const formatCurrency = (value) =>
          clampNonNegative(value).toLocaleString(undefined, {
            style: "currency",
            currency: "USD",
            maximumFractionDigits: 0,
          });

        const formatCurrencySigned = (value) => {
          const abs = Math.abs(Number(value) || 0);
          const s = abs.toLocaleString(undefined, {
            style: "currency",
            currency: "USD",
            maximumFractionDigits: 0,
          });
          return (Number(value) || 0) < 0 ? `-${s}` : s;
        };

        const formatCompactCurrency = (value) =>
          clampNonNegative(value).toLocaleString(undefined, {
            style: "currency",
            currency: "USD",
            maximumFractionDigits: 0,
            notation: "compact",
          });

        const formatPercent = (value, digits = 1) => {
          const n = Number(value);
          if (!Number.isFinite(n)) return "—";
          return `${n.toFixed(digits)}%`;
        };

        const monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];

        const baseDefaults = {
          loan_type: "conventional",
          home_value: 450000,
          down_payment_value: 90000,
          rate_apr: 6.75,
          term_years: 30,
          start_month: 2,
          start_year: new Date().getFullYear(),
          property_tax_input: 1.05,
          homeowners_insurance_yearly: 1500,
          hoa_monthly: 0,
          upfront_fee_pct: 0,
          annual_mi_pct: 0,
          finance_upfront_fee: false,
          extra_principal_monthly: 0,
          extra_start_month_index: 0,
          pmi_pct: 0.5,
        };

        const programDefaults = {
          conventional: { pmi_pct: 0.5, upfront_fee_pct: 0, annual_mi_pct: 0, finance_upfront_fee: false },
          FHA: { pmi_pct: 0, upfront_fee_pct: 1.75, annual_mi_pct: 0.85, finance_upfront_fee: true },
          VA: { pmi_pct: 0, upfront_fee_pct: 2.3, annual_mi_pct: 0, finance_upfront_fee: true },
          USDA: { pmi_pct: 0, upfront_fee_pct: 1.0, annual_mi_pct: 0.35, finance_upfront_fee: true },
        };

        // Defaults for Rental Calculator fields (used if user did not provide values)
        // Note: closing_cost, exp_property_tax_annual, exp_insurance_annual, exp_water_annual, exp_lawn_annual
        // are dynamically calculated based on purchase_price (see updatePriceBasedEstimates)
        const rentalDefaults = {
          purchase_price: 450000,
          monthly_rent: 5000,
          other_monthly_income: 0,
          vacancy_rate_pct: 5,
          exp_hoa_annual: 0,
          exp_maintenance_annual: 2000,
          exp_other_annual: 500,
          down_payment_pct: 20,
          interest_rate_pct: 6.5,
          loan_term_years: 30,
          // Annual increase defaults (for 20-year projections)
          monthly_rent_increase_pct: 3,
          other_monthly_income_increase_pct: 3,
          exp_property_tax_increase_pct: 3,
          exp_insurance_increase_pct: 3,
          exp_hoa_increase_pct: 3,
          exp_maintenance_increase_pct: 3,
          exp_other_increase_pct: 3,
          exp_water_increase_pct: 3,
          exp_lawn_increase_pct: 3,
          // Sell / Exit Assumptions defaults
          holding_length_years: 20,
          cost_to_sell_pct: 6,
          value_appreciation_pct: 3,
        };

        const setRentalDefaultsIfEmpty = (force = false) => {
          console.log('[DEBUG] setRentalDefaultsIfEmpty called');
          const setIfEmpty = (id, val) => {
            const el = document.getElementById(id);
            if (!el) {
              console.log(`[DEBUG] Element not found: ${id}`);
              return;
            }
            const cur = (el.value ?? '').trim();
            const asNum = Number((cur || '').replace(/[$,]/g, ''));
            if (force || cur === '' || (!Number.isNaN(asNum) && asNum === 0)) {
              el.value = String(val);
              console.log(`[DEBUG] Set ${id} = ${val}`);
            }
          };
          Object.entries(rentalDefaults).forEach(([id, val]) => setIfEmpty(id, val));

          // Derived defaults that depend on purchase price
          try {
            const ppEl = document.getElementById('purchase_price');
            const taxEl = document.getElementById('exp_property_tax_annual');
            const closeEl = document.getElementById('closing_cost');
            const insEl = document.getElementById('exp_insurance_annual');
            const waterEl = document.getElementById('exp_water_annual');
            const lawnEl = document.getElementById('exp_lawn_annual');
            const pp = Number((ppEl?.value || '0').toString().replace(/[$,]/g, '')) || 0;
            
            const shouldSet = (el, edited) => {
              if (!pp || !el || edited) return false;
              if (force) return true;
              const cur = (el.value ?? '').trim().replace(/,/g, '');
              return cur === '' || cur === '0';
            };
            
            // Property Tax: 1.1% of purchase price
            if (shouldSet(taxEl, taxEdited)) {
              taxEl.value = String(Math.round(pp * 0.011));
            }
            // Closing Cost: 2% of purchase price (rounded to nearest $100)
            if (shouldSet(closeEl, closingEdited)) {
              closeEl.value = String(Math.round(pp * 0.02 / 100) * 100);
            }
            // Insurance: 0.35% of purchase price
            if (shouldSet(insEl, insuranceEdited)) {
              insEl.value = String(Math.round(pp * 0.0035));
            }
            // Water/Sewer: $1,200 base + 0.1% of price
            if (shouldSet(waterEl, waterEdited)) {
              waterEl.value = String(Math.round(1200 + pp * 0.001));
            }
            // Lawn Care: 0.15% of purchase price (min $300)
            if (shouldSet(lawnEl, lawnEdited)) {
              lawnEl.value = String(Math.max(300, Math.round(pp * 0.0015)));
            }
          } catch(_) {}

          // Sync loan sliders from inputs if they exist
          if (typeof loanInputsMap !== 'undefined' && typeof loanSlidersMap !== 'undefined' && typeof loanDisplaysMap !== 'undefined') {
            if (loanInputsMap.dp_pct && loanSlidersMap.dp) {
              const v = Math.min(75, Math.max(0, Number(loanInputsMap.dp_pct.value) || 0));
              loanSlidersMap.dp.value = String(v);
              if (loanDisplaysMap.dp) loanDisplaysMap.dp.textContent = `${v}%`;
            }
            if (loanInputsMap.rate_pct && loanSlidersMap.rate) {
              const v = Math.min(15, Math.max(0, Number(loanInputsMap.rate_pct.value) || 0));
              loanSlidersMap.rate.value = String(v);
              if (loanDisplaysMap.rate) loanDisplaysMap.rate.textContent = `${v.toFixed(2)}%`;
            }
            if (loanInputsMap.term_years && loanSlidersMap.term) {
              const v = Math.round(Math.min(40, Math.max(5, Number(loanInputsMap.term_years.value) || 30)));
              loanSlidersMap.term.value = String(v);
              if (loanDisplaysMap.term) loanDisplaysMap.term.textContent = `${v}y`;
            }
          }
        };

        const inputs = {
          loan_type: $("loan_type"),
          home_value: $("home_value"),
          down_payment_value: $("down_payment_value"),
          rate_apr: $("rate_apr"),
          term_years: $("term_years"),
          start_month: $("start_month"),
          start_year: $("start_year"),
          property_tax_input: $("property_tax_input"),
          homeowners_insurance_yearly: $("homeowners_insurance_yearly"),
          hoa_monthly: $("hoa_monthly"),
          pmi_pct: $("pmi_pct"),
          upfront_fee_pct: $("upfront_fee_pct"),
          annual_mi_pct: $("annual_mi_pct"),
          finance_upfront_fee: $("finance_upfront_fee"),
          extra_principal_monthly: $("extra_principal_monthly"),
          extra_start_month_index: $("extra_start_month_index"),
        };

        const sliders = {
          down_payment: $("down_payment_slider"),
          rate: $("rate_slider"),
          term: $("term_slider"),
        };

        const sliderDisplays = {
          down_payment: $("down_payment_slider_display"),
          rate: $("rate_slider_display"),
          term: $("term_slider_display"),
        };

        const scenarioBar = document.getElementById("scenarioBar");
        let didUserEdit = false;

        const miVisibilityPrograms = new Set(["FHA", "USDA"]);
        const miOnlyElements = Array.from(document.querySelectorAll("[data-mi-only]"));

        const updateMiVisibility = () => {
          const program = inputs.loan_type.value;
          const show = miVisibilityPrograms.has(program);
          miOnlyElements.forEach((el) => {
            el.classList.toggle("is-hidden", !show);
          });
        };

        const percentInputIds = ["rate_apr", "pmi_pct", "upfront_fee_pct", "annual_mi_pct"];
        const percentInputSet = new Set(percentInputIds);

        const formatPercentValue = (value) => {
          const num = toNumber(value);
          if (!Number.isFinite(num)) return "";
          return num.toFixed(2);
        };

        const normalizePercentInput = (el) => {
          if (!el) return;
          const formatted = formatPercentValue(el.value);
          if (formatted !== "") {
            el.value = formatted;
          }
        };

        const normalizePercentInputs = () => {
          percentInputIds.forEach((id) => normalizePercentInput(inputs[id]));
        };

        const outputs = {
          total_monthly_0: $("total_monthly_0"),
          p_and_i: $("p_and_i"),
          total_interest: $("total_interest"),
          payoff_date: $("payoff_date"),
          interest_hint: $("interest_hint"),
          term_hint: $("term_hint"),
          totalsBreakdown: $("totalsBreakdown"),
          schedulePreview: $("schedulePreview"),
          scheduleNote: $("scheduleNote"),
          // Year 1 Summary card (slide 1)
          year1_income_value: $("year1_income_value"),
          year1_cashflow_value: $("year1_cashflow_value"),
          // Outputs slide KPIs and table
          kpi_cashflow_annual: $("kpi_cashflow_annual"),
          kpi_cashflow_monthly: $("kpi_cashflow_monthly"),
          kpi_income_annual: $("kpi_income_annual"),
          kpi_income_monthly: $("kpi_income_monthly"),
          y1_income_monthly: $("y1_income_monthly"),
          y1_income_annual: $("y1_income_annual"),
          y1_mortgage_monthly: $("y1_mortgage_monthly"),
          y1_mortgage_annual: $("y1_mortgage_annual"),
          y1_vacancy_monthly: $("y1_vacancy_monthly"),
          y1_vacancy_annual: $("y1_vacancy_annual"),
          y1_tax_monthly: $("y1_tax_monthly"),
          y1_tax_annual: $("y1_tax_annual"),
          y1_insurance_monthly: $("y1_insurance_monthly"),
          y1_insurance_annual: $("y1_insurance_annual"),
          y1_maintenance_monthly: $("y1_maintenance_monthly"),
          y1_maintenance_annual: $("y1_maintenance_annual"),
          y1_other_monthly: $("y1_other_monthly"),
          y1_other_annual: $("y1_other_annual"),
          y1_cashflow_monthly: $("y1_cashflow_monthly"),
          y1_cashflow_annual: $("y1_cashflow_annual"),
          y1_noi_monthly: $("y1_noi_monthly"),
          y1_noi_annual: $("y1_noi_annual"),
          // Investment summary outputs
          out_irr: $("out_irr"),
          out_total_profit: $("out_total_profit"),
          out_coc: $("out_coc"),
          out_cap_rate: $("out_cap_rate"),
          out_total_rent: $("out_total_rent"),
          out_total_mortgage: $("out_total_mortgage"),
          out_total_expenses: $("out_total_expenses"),
          out_total_noi: $("out_total_noi"),
          overTimeTableBody: (document.querySelector('#overTimeTable tbody')),
          // Donut
          expenseDonut: $("expenseDonut"),
          expenseLegend: $("expenseLegend"),
        };
        const monthlyPaymentCard = $("monthlyPaymentCard");
        const carousel = {
          track: $("resultTrack"),
          prev: $("cardPrev"),
          next: $("cardNext"),
          slides: Array.from(document.querySelectorAll(".carousel-slide")),
          index: 0,
        };
        const fieldMessages = Array.from(document.querySelectorAll(".field-message"));

        // CTA: Jump to the second slide (breakdown with chart)
        const seeAdvanced = document.getElementById('seeAdvanced');
        if (seeAdvanced) {
          seeAdvanced.addEventListener('click', (e) => {
            e.preventDefault();
            // Force navigation to the SECOND slide (index 1)
            const targetIndex = Math.min(1, carousel.slides.length - 1);
            carousel.index = targetIndex;
            updateCarousel();
            // Snap viewport to the top of the carousel region
            const root = document.querySelector('.result-carousel');
            setTimeout(() => {
              root?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 20);
          });
        }

        const clearFieldErrors = () => {
          fieldMessages.forEach((span) => {
            span.textContent = "";
            const label = span.closest("label");
            if (label) label.classList.remove("has-error");
          });
        };

        const setFieldError = (fieldId, message) => {
          const span = document.querySelector(`[data-field-error="${fieldId}"]`);
          if (!span) return;
          span.textContent = message;
          const label = span.closest("label");
          if (label) label.classList.add("has-error");
        };

        const emitTelemetry = (event, detail = {}) => {
          try {
            if (window?.openai?.trackEvent) {
              window.openai.trackEvent(event, detail);
              return;
            }
          } catch (err) {
            console.debug("trackEvent failed", err);
          }
          console.debug(`[mortgage-telemetry] ${event}`, detail);
        };

        // Lightweight toast notifications for success/failure messages
        const getToastContainer = () => {
          let el = document.querySelector('.toast-container');
          if (!el) {
            el = document.createElement('div');
            el.className = 'toast-container';
            document.body.appendChild(el);
          }
          return el;
        };
        const showToast = (type, message) => {
          const container = getToastContainer();
          const t = document.createElement('div');
          t.className = `toast ${type}`;
          t.textContent = message;
          container.appendChild(t);
          requestAnimationFrame(() => t.classList.add('show'));
          setTimeout(() => {
            t.classList.remove('show');
            setTimeout(() => t.remove(), 250);
          }, 3000);
        };

        const validateInputs = () => {
          try {
            clearFieldErrors();
            const issues = [];

            const hv = toNumber(document.getElementById('purchase_price')?.value ?? inputs.home_value?.value ?? 0);
            if (hv <= 0) {
              const field = document.getElementById('purchase_price') ? 'purchase_price' : 'home_value';
              setFieldError(field, "Enter a purchase price above 0");
              issues.push(field);
            }

            const dpVal = toNumber(inputs.down_payment_value?.value ?? 0);
            if (dpVal < 0) {
              setFieldError("down_payment_value", "Cannot be negative");
              issues.push("down_payment_value");
            } else if (hv > 0 && dpVal > hv) {
              setFieldError("down_payment_value", "Cannot exceed purchase price");
              issues.push("down_payment_value");
            }

            const rateApr = toNumber(document.getElementById('interest_rate_pct')?.value ?? inputs.rate_apr?.value ?? 0);
            if (rateApr < 0) {
              const field = document.getElementById('interest_rate_pct') ? 'interest_rate_pct' : 'rate_apr';
              setFieldError(field, "Rate cannot be negative");
              issues.push(field);
            }

            const termYears = toNumber(document.getElementById('loan_term_years')?.value ?? inputs.term_years?.value ?? 30);
            if (termYears < 1) {
              const field = document.getElementById('loan_term_years') ? 'loan_term_years' : 'term_years';
              setFieldError(field, "Must be at least 1 year");
              issues.push(field);
            }

            const startMonth = toNumber(inputs.start_month?.value ?? 1);
            if (startMonth && (startMonth < 1 || startMonth > 12)) {
              setFieldError("start_month", "Use a month between 1 and 12");
              issues.push("start_month");
            }

            const startYear = toNumber(inputs.start_year?.value ?? new Date().getFullYear());
            if (startYear && startYear < 1900) {
              setFieldError("start_year", "Year looks too early");
              issues.push("start_year");
            }

            if (issues.length) {
              emitTelemetry("validation_error", { fields: issues });
              // Do not block calculations; return true so app remains usable
              return true;
            }
            return true;
          } catch (err) {
            // Never block rendering due to missing legacy inputs
            console.debug('validateInputs fallback', err);
            return true;
          }
        };

        const updateSliderPositions = () => {
          const hv = toNumber(document.getElementById('purchase_price')?.value ?? inputs.home_value?.value ?? 0);
          if (sliders.down_payment) {
            const dpValue = toNumber(inputs.down_payment_value?.value ?? 0);
            const percent = hv > 0 ? Math.round((dpValue / hv) * 100) : 0;
            sliders.down_payment.value = String(Math.min(80, Math.max(0, percent)));
            if (sliderDisplays.down_payment) sliderDisplays.down_payment.textContent = `${sliders.down_payment.value}%`;
          }
          if (sliders.rate) {
            const rawRate = toNumber(document.getElementById('interest_rate_pct')?.value ?? inputs.rate_apr?.value ?? 0);
            sliders.rate.value = String(Math.min(12, Math.max(0, rawRate)));
            if (sliderDisplays.rate) sliderDisplays.rate.textContent = `${Number(sliders.rate.value).toFixed(2)}%`;
          }
          if (sliders.term) {
            const term = Math.round(toNumber(document.getElementById('loan_term_years')?.value ?? inputs.term_years?.value ?? 30));
            sliders.term.value = String(Math.min(40, Math.max(5, term)));
            if (sliderDisplays.term) sliderDisplays.term.textContent = `${sliders.term.value}y`;
          }
        };

        const setDefaults = (preset = baseDefaults) => {
          Object.entries(preset).forEach(([key, value]) => {
            if (!(key in inputs)) return;
            if (!inputs[key]) return;
            if (inputs[key].type === "checkbox") {
              inputs[key].checked = Boolean(value);
            } else {
              inputs[key].value = percentInputSet.has(key) ? formatPercentValue(value) : value;
            }
          });
          normalizePercentInputs();
          updateMiVisibility();
          clearFieldErrors();
          updateSliderPositions();
        };

        const mergeProgramDefaults = () => {
          const program = inputs.loan_type.value;
          const defaults = programDefaults[program];
          if (!defaults) return;
          Object.entries(defaults).forEach(([key, value]) => {
            if (!(key in inputs)) return;
            if (inputs[key].type === "checkbox") {
              inputs[key].checked = Boolean(value);
            } else {
              // Always update program-specific fields (pmi_pct, upfront_fee_pct, annual_mi_pct)
              inputs[key].value = percentInputSet.has(key) ? formatPercentValue(value) : value;
            }
          });
          normalizePercentInputs();
        };

        const readParams = () => {
          // Prefer new Purchase Details values if present
          const purchasePriceEl = document.getElementById('purchase_price');
          const dpPctEl = document.getElementById('down_payment_pct');
          const ratePctEl = document.getElementById('interest_rate_pct');
          const termYearsEl = document.getElementById('loan_term_years');
          const useLoanYes = document.getElementById('use_loan_yes');

          const hv = toNumber(purchasePriceEl?.value ?? inputs.home_value.value);
          const dpPct = toNumber(dpPctEl?.value ?? 0);
          const dpValueNew = Math.round(hv * (dpPct / 100));
          const rateAprNew = toNumber(ratePctEl?.value ?? 0) / 100;
          const termYearsNew = toNumber(termYearsEl?.value ?? inputs.term_years.value);

          const usingLoan = !!(useLoanYes && useLoanYes.checked);
          let downPaymentValue;
          if (usingLoan) {
            // If percentage input is present, honor it even when it's exactly 0%
            if (dpPctEl) {
              const v = Number.isFinite(dpValueNew) ? dpValueNew : 0;
              downPaymentValue = Math.max(0, Math.min(hv, v));
            } else {
              downPaymentValue = Math.max(0, Math.min(hv, toNumber(inputs.down_payment_value.value)));
            }
          } else {
            // No loan: DP equals purchase price so nothing is financed
            downPaymentValue = hv;
          }

          return {
            loan_type: inputs.loan_type.value,
            home_value: hv > 0 ? hv : toNumber(inputs.home_value.value),
            down_payment_value: downPaymentValue,
            down_payment_pct: hv > 0 ? (downPaymentValue / hv) : 0,
            rate_apr: Number.isFinite(rateAprNew) && rateAprNew > 0 ? rateAprNew : toNumber(inputs.rate_apr.value) / 100,
            term_years: Number.isFinite(termYearsNew) && termYearsNew > 0 ? termYearsNew : toNumber(inputs.term_years.value),
            start_month: toNumber(inputs.start_month.value),
            start_year: toNumber(inputs.start_year.value),
            property_tax_input: toNumber(inputs.property_tax_input.value),
            homeowners_insurance_yearly: toNumber(inputs.homeowners_insurance_yearly.value),
            hoa_monthly: toNumber(inputs.hoa_monthly.value),
            upfront_fee_pct: toNumber(inputs.upfront_fee_pct.value) / 100,
            annual_mi_pct: toNumber(inputs.annual_mi_pct.value) / 100,
            finance_upfront_fee: Boolean(inputs.finance_upfront_fee.checked),
            extra_principal_monthly: toNumber(inputs.extra_principal_monthly.value),
            extra_start_month_index: toNumber(inputs.extra_start_month_index.value),
            pmi_pct: toNumber(inputs.pmi_pct.value) / 100,
          };
        };

        const readRentalInputs = () => {
          const rent = toNumber((document.getElementById('monthly_rent')||{}).value);
          const other = toNumber((document.getElementById('other_monthly_income')||{}).value);
          const vacPct = toNumber((document.getElementById('vacancy_rate_pct')||{}).value) / 100;
          const taxAnnual = toNumber((document.getElementById('exp_property_tax_annual')||{}).value);
          const insAnnual = toNumber((document.getElementById('exp_insurance_annual')||{}).value);
          const hoaAnnual = toNumber((document.getElementById('exp_hoa_annual')||{}).value);
          const maintAnnual = toNumber((document.getElementById('exp_maintenance_annual')||{}).value);
          const otherAnnual = toNumber((document.getElementById('exp_other_annual')||{}).value);
          const waterAnnual = toNumber((document.getElementById('exp_water_annual')||{}).value);
          const lawnAnnual = toNumber((document.getElementById('exp_lawn_annual')||{}).value);
          const useLoanYes = document.getElementById('use_loan_yes');
          const usingLoan = !!(useLoanYes && useLoanYes.checked);

          return { rent, other, vacPct, taxAnnual, insAnnual, hoaAnnual, maintAnnual, otherAnnual, waterAnnual, lawnAnnual, usingLoan };
        };

        const divideSafe = (numerator, denominator) =>
          denominator === 0 ? 0 : numerator / denominator;

        const renderSummary = (calc) => {
          console.log('[DEBUG] renderSummary START');
          const { inputs: normalized, derived, totals, payoff_date } = calc;
          console.log('[DEBUG] renderSummary destructured calc');
          console.log('[DEBUG] About to update legacy outputs...');
          const monthsElapsed = totals.payments_made || 0;
          const yearsElapsed = divideSafe(monthsElapsed, 12);
          const payoffLabel = payoff_date
            ? `${monthNames[normalizeMonth(payoff_date.month) - 1]} ${payoff_date.year}`
            : "—";

          const monthlyPaymentEl = outputs.total_monthly_0;
          if (monthlyPaymentEl) monthlyPaymentEl.textContent = formatCurrency(derived.total_monthly_0);
          if (monthlyPaymentCard) {
            monthlyPaymentCard.classList.remove("glow-animate");
            void monthlyPaymentCard.offsetWidth;
            monthlyPaymentCard.classList.add("glow-animate");
          }

const totalExtraPrincipal = calc.schedule.reduce((sum, row) => sum + row.extra_principal, 0);

if (outputs.interest_hint) outputs.interest_hint.textContent = `Totals include ${formatCurrency(
  totals.total_principal - totalExtraPrincipal
)} scheduled principal and ${formatCurrency(totalExtraPrincipal)} extra payments.`;

if (outputs.term_hint) outputs.term_hint.textContent = `Original term ${normalized.term_years} yrs — paid off in ${yearsElapsed.toFixed(
  1
)} yrs (${monthsElapsed} months).`;

          if (outputs.totalsBreakdown) outputs.totalsBreakdown.innerHTML = `
            <div class="totals-item">
              <span class="label">Tax & insurance</span>
              <span class="value">${formatCurrency(totals.total_tax + totals.total_ins)}</span>
            </div>
            <div class="totals-item">
              <span class="label">Mortgage insurance</span>
              <span class="value">${formatCurrency(totals.total_mi)}</span>
            </div>
            <div class="totals-item">
              <span class="label">HOA dues</span>
              <span class="value">${formatCurrency(totals.total_hoa)}</span>
            </div>
            <div class="totals-item">
              <span class="label">Total paid</span>
              <span class="value">${formatCurrency(totals.total_of_payments)}</span>
            </div>
          `;

          const previewRows = calc.schedule.slice(0, 12);
          if (previewRows.length) {
            const rows = previewRows
              .map((row) => {
                const monthLabel = `${monthNames[row.date.month - 1].slice(0, 3)} ${row.date.year}`;
                return `
                  <tr>
                    <td class="label">${row.index + 1}</td>
                    <td>${monthLabel}</td>
                    <td>${formatCurrency(row.total_payment)}</td>
                    <td>${formatCurrency(row.principal_scheduled + row.extra_principal)}</td>
                    <td>${formatCurrency(row.interest)}</td>
                    <td>${formatCurrency(row.closing_balance)}</td>
                  </tr>`;
              })
              .join("");

            if (outputs.schedulePreview) outputs.schedulePreview.innerHTML = `
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th class="label">Month</th>
                    <th>Payment</th>
                    <th>Principal</th>
                    <th>Interest</th>
                    <th>Balance</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            `;
            if (outputs.scheduleNote) outputs.scheduleNote.textContent = `Showing first ${previewRows.length} of ${calc.schedule.length} months.`;
          } else {
            if (outputs.schedulePreview) outputs.schedulePreview.innerHTML = "";
            if (outputs.scheduleNote) outputs.scheduleNote.textContent = "Enter loan details to view amortization.";
          }
          // ---------- Rental outputs wiring (Year 1) ----------
          const r = readRentalInputs();
          const grossMonthlyIncome = Math.max((r.rent || 0) + (r.other || 0), 0);
          const vacancyMonthly = Math.max(grossMonthlyIncome * Math.max(r.vacPct || 0, 0), 0);
          const incomeMonthly = grossMonthlyIncome;
          const incomeAnnual = incomeMonthly * 12;
          const taxMonthly = (r.taxAnnual || 0) / 12;
          const insMonthly = (r.insAnnual || 0) / 12;
          const hoaMonthly = (r.hoaAnnual || 0) / 12;
          const maintMonthly = (r.maintAnnual || 0) / 12;
          const otherMonthly = (r.otherAnnual || 0) / 12;
          const waterMonthly = (r.waterAnnual || 0) / 12;
          const lawnMonthly = (r.lawnAnnual || 0) / 12;
          const opExMonthly = taxMonthly + insMonthly + hoaMonthly + maintMonthly + otherMonthly + waterMonthly + lawnMonthly;
          const noiMonthly = incomeMonthly - vacancyMonthly - opExMonthly;
          const noiAnnual = noiMonthly * 12;
          // Compute simple P&I from rental loan inputs to match the reference calculator
          const hvY1 = toNumber(document.getElementById('purchase_price')?.value || 0);
          const dpPctY1 = Math.max(0, toNumber(document.getElementById('down_payment_pct')?.value || 0)) / 100;
          let loanAmtY1 = r.usingLoan ? Math.max(0, hvY1 * (1 - dpPctY1)) : 0;
          
          // VA funding fee: 1.25% added to loan if VA loan and no disability exemption
          const loanPresetY1 = document.getElementById('loan_preset')?.value || '';
          const vaDisabilityYesY1 = document.getElementById('va_disability_yes');
          const hasVaDisabilityY1 = vaDisabilityYesY1 && vaDisabilityYesY1.checked;
          if (loanPresetY1 === 'va-zero' && !hasVaDisabilityY1 && r.usingLoan) {
            loanAmtY1 *= 1.0125; // Add 1.25% funding fee to loan
          }
          
          const rateDecY1 = Math.max(0, toNumber(document.getElementById('interest_rate_pct')?.value || 0)) / 100;
          const termYrsY1 = Math.max(1, Math.round(toNumber(document.getElementById('loan_term_years')?.value || 30)));
          const mortgageMonthly = r.usingLoan ? monthly_p_and_i(loanAmtY1, rateDecY1, termYrsY1) : 0;
          const mortgageAnnual = mortgageMonthly * 12;
          const cashflowAnnual = noiAnnual - mortgageAnnual;
          const cashflowMonthly = cashflowAnnual / 12;

          console.log('[DEBUG Year 1 Income]', {
            grossMonthlyIncome,
            vacancyMonthly,
            incomeMonthly,
            incomeAnnual,
            incomeAfterVacAnnual: (incomeMonthly - vacancyMonthly) * 12,
            element: outputs.year1_income_value
          });

          const safeSet = (el, val) => { if (el) el.textContent = val; };
          
          // Year 1 Income after vacancy (single source of truth)
          const incomeAfterVacAnnual = (incomeMonthly - vacancyMonthly) * 12;
          const incomeAfterVacMonthly = incomeMonthly - vacancyMonthly;
          
          // KPIs (Outputs slide) - use income AFTER vacancy for consistency
          safeSet(outputs.kpi_cashflow_annual, formatCurrencySigned(cashflowAnnual));
          if (outputs.kpi_cashflow_annual) outputs.kpi_cashflow_annual.classList.toggle('neg', cashflowAnnual < 0);
          safeSet(outputs.kpi_cashflow_monthly, `${formatCurrencySigned(cashflowMonthly)} /mo`);
          if (outputs.kpi_cashflow_monthly) outputs.kpi_cashflow_monthly.classList.toggle('neg', cashflowMonthly < 0);
          safeSet(outputs.kpi_income_annual, formatCurrency(incomeAfterVacAnnual));
          safeSet(outputs.kpi_income_monthly, `${formatCurrency(incomeAfterVacMonthly)} /mo`);

          // Year 1 Summary card - Deal Quality & Cashflow Focus
          
          // Update Deal Quality Indicator
          const dealIndicator = $("dealIndicator");
          const dealLabel = $("dealLabel");
          const dealIconGood = $("dealIconGood");
          const dealIconMediocre = $("dealIconMediocre");
          const dealIconBad = $("dealIconBad");
          
          let dealQuality = 'good';
          let dealText = 'Good Deal';
          if (cashflowMonthly < 0) {
            if (cashflowMonthly >= -999) {
              dealQuality = 'mediocre';
              dealText = 'Mediocre Deal';
            } else {
              dealQuality = 'bad';
              dealText = 'Bad Deal';
            }
          }
          
          if (dealIndicator) {
            dealIndicator.className = `deal-indicator ${dealQuality}`;
          }
          if (dealLabel) dealLabel.textContent = dealText;
          if (dealIconGood) dealIconGood.style.display = dealQuality === 'good' ? '' : 'none';
          if (dealIconMediocre) dealIconMediocre.style.display = dealQuality === 'mediocre' ? '' : 'none';
          if (dealIconBad) dealIconBad.style.display = dealQuality === 'bad' ? '' : 'none';
          
          // Update Cashflow values (monthly is primary, yearly is secondary)
          const cashflowMonthlyEl = $("year1_cashflow_monthly");
          const cashflowYearlyEl = $("year1_cashflow_value");
          
          if (cashflowMonthlyEl) {
            const monthlyFormatted = formatCurrencySigned(cashflowMonthly);
            cashflowMonthlyEl.innerHTML = `${monthlyFormatted}<span class="period-label">/mo</span>`;
            cashflowMonthlyEl.className = `value-primary ${cashflowMonthly >= 0 ? 'positive' : 'negative'}`;
          }
          if (cashflowYearlyEl) {
            const yearlyFormatted = formatCurrencySigned(cashflowAnnual);
            cashflowYearlyEl.innerHTML = `${yearlyFormatted}<span class="period-label">/yr</span>`;
            cashflowYearlyEl.className = `value-secondary ${cashflowAnnual >= 0 ? 'positive' : 'negative'}`;
          }
          
          // Calculate and display Cap Rate
          const capRateEl = $("cap_rate_value");
          if (capRateEl && hvY1 > 0) {
            const capRate = (noiAnnual / hvY1) * 100;
            capRateEl.textContent = `${capRate.toFixed(2)}%`;
          } else if (capRateEl) {
            capRateEl.textContent = '0%';
          }
          
          // Calculate and show breakeven price if cashflow is negative
          const breakevenRow = $("breakevenRow");
          const breakevenPriceEl = $("breakevenPrice");
          
          if (cashflowMonthly < 0 && r.usingLoan && hvY1 > 0 && rateDecY1 > 0) {
            // Calculate breakeven: what purchase price makes cashflow = 0?
            // NOI = mortgage payment at breakeven
            // noiMonthly = monthly_p_and_i(loanAmt, rate, term)
            // We need to solve for purchase price where P&I = NOI
            // loanAmt = purchasePrice * (1 - dpPct)
            // So we need: monthly_p_and_i(purchasePrice * (1 - dpPct), rate, term) = noiMonthly
            // This requires iteration or solving the mortgage formula backwards
            
            // Binary search for breakeven price
            let lowPrice = 0;
            let highPrice = hvY1 * 2;
            let breakevenPrice = null;
            
            for (let i = 0; i < 50; i++) {
              const midPrice = (lowPrice + highPrice) / 2;
              const testLoan = midPrice * (1 - dpPctY1);
              const testPayment = monthly_p_and_i(testLoan, rateDecY1, termYrsY1);
              const testCashflow = noiMonthly - testPayment;
              
              if (Math.abs(testCashflow) < 1) {
                breakevenPrice = midPrice;
                break;
              }
              
              if (testCashflow < 0) {
                highPrice = midPrice;
              } else {
                lowPrice = midPrice;
              }
            }
            
            if (breakevenPrice === null) breakevenPrice = (lowPrice + highPrice) / 2;
            
            if (breakevenRow) breakevenRow.style.display = 'flex';
            if (breakevenPriceEl) breakevenPriceEl.textContent = formatCurrency(Math.round(breakevenPrice));
          } else {
            if (breakevenRow) breakevenRow.style.display = 'none';
          }

            // Year 1 table values
          safeSet(outputs.y1_income_monthly, formatCurrency(incomeMonthly));
          safeSet(outputs.y1_income_annual, formatCurrency(incomeAnnual));
          safeSet(outputs.y1_mortgage_monthly, formatCurrency(mortgageMonthly));
          safeSet(outputs.y1_mortgage_annual, formatCurrency(mortgageAnnual));
          safeSet(outputs.y1_vacancy_monthly, formatCurrency(vacancyMonthly));
          safeSet(outputs.y1_vacancy_annual, formatCurrency(vacancyMonthly * 12));
          safeSet(outputs.y1_tax_monthly, formatCurrency(taxMonthly));
          safeSet(outputs.y1_tax_annual, formatCurrency(r.taxAnnual || 0));
          safeSet(outputs.y1_insurance_monthly, formatCurrency(insMonthly));
          safeSet(outputs.y1_insurance_annual, formatCurrency(r.insAnnual || 0));
          safeSet(outputs.y1_maintenance_monthly, formatCurrency(maintMonthly));
          safeSet(outputs.y1_maintenance_annual, formatCurrency(r.maintAnnual || 0));
          safeSet(outputs.y1_other_monthly, formatCurrency(otherMonthly));
          safeSet(outputs.y1_other_annual, formatCurrency(r.otherAnnual || 0));
          safeSet(outputs.y1_cashflow_monthly, formatCurrencySigned(cashflowMonthly));
          safeSet(outputs.y1_cashflow_annual, formatCurrencySigned(cashflowAnnual));
          safeSet(outputs.y1_noi_monthly, formatCurrencySigned(noiMonthly));
          safeSet(outputs.y1_noi_annual, formatCurrencySigned(noiAnnual));
        };

        // ---------- Investment summary & Over Time ----------
        const readSellInputs = () => {
          const modePriceEl = document.getElementById('price_mode_price');
          // Fallback to legacy radios if new toggle not present
          const legacyKnowYes = document.getElementById('know_sell_price_yes');
          const knowSell = modePriceEl ? !!modePriceEl.checked : !!(legacyKnowYes && legacyKnowYes.checked);
          return {
            knowSell,
            sellPrice: toNumber(document.getElementById('sell_price')?.value || 0),
            holdYears: Math.max(0, Math.round(toNumber(document.getElementById('holding_length_years')?.value || 0))),
            costToSellPct: Math.max(0, toNumber(document.getElementById('cost_to_sell_pct')?.value || 0)) / 100,
            appPct: Math.max(0, toNumber(document.getElementById('value_appreciation_pct')?.value || 0)) / 100,
          };
        };

        const readIncreaseInputs = () => {
          const num = (id) => toNumber(document.getElementById(id)?.value || 0) / 100;
          return {
            rentInc: num('monthly_rent_increase_pct'),
            otherInc: num('other_monthly_income_increase_pct'),
            taxInc: num('exp_property_tax_increase_pct'),
            insInc: num('exp_insurance_increase_pct'),
            hoaInc: num('exp_hoa_increase_pct'),
            maintInc: num('exp_maintenance_increase_pct'),
            otherExpInc: num('exp_other_increase_pct'),
            waterInc: num('exp_water_increase_pct'),
            lawnInc: num('exp_lawn_increase_pct'),
          };
        };

        const computeIRR = (cashflows) => {
          let low = -0.9999, high = 10.0;
          const npv = (r) => cashflows.reduce((acc, cf, t) => acc + cf / Math.pow(1 + r, t), 0);
          let fLow = npv(low), fHigh = npv(high);
          if (fLow * fHigh > 0) return null;
          for (let i = 0; i < 80; i++) {
            const mid = (low + high) / 2;
            const fMid = npv(mid);
            if (Math.abs(fMid) < 1e-6) return mid * 100;
            if (fLow * fMid <= 0) { high = mid; fHigh = fMid; } else { low = mid; fLow = fMid; }
          }
          return ((low + high) / 2) * 100;
        };

        const computeProForma = (calc) => {
          const r = readRentalInputs();
          const inc = readIncreaseInputs();
          const sell = readSellInputs();
          const hv = toNumber(document.getElementById('purchase_price')?.value || 0);
          const closing = toNumber(document.getElementById('closing_cost')?.value || 0);
          const repairs = toNumber(document.getElementById('repair_cost')?.value || 0);

          const basePrice = hv;
          const months = calc.schedule.length;
          const holdYears = Math.max(1, sell.holdYears || 20);
          const holdMonths = Math.min(months, holdYears * 12);

          const p_and_i = calc.derived.p_and_i || 0;
          const miByMonth = (idx) => (calc.schedule[idx]?.mi || 0);

          const initialDown = clampNonNegative(calc.inputs.down_payment_value || 0);
          const upfrontCash = clampNonNegative(calc.derived.cash_at_close_upfront_fee || 0);
          const initialCash = (r.usingLoan ? initialDown : basePrice) + closing + repairs + upfrontCash;

          const perYear = [];
          let totalRent = 0, totalMort = 0, totalExp = 0, totalNOI = 0, totalCF = 0;

          for (let y = 1; y <= holdYears; y++) {
            const rentM = (r.rent || 0) * Math.pow(1 + (inc.rentInc || 0), y - 1);
            // Reference calc treats rental income as rent-only; exclude Other Monthly Income from totals
            const incomeAnnual = rentM * 12;
            // Vacancy applied to rent only
            const vacancyAnnual = incomeAnnual * (r.vacPct || 0);

            const taxA = (r.taxAnnual || 0) * Math.pow(1 + (inc.taxInc || 0), y - 1);
            const insA = (r.insAnnual || 0) * Math.pow(1 + (inc.insInc || 0), y - 1);
            const hoaA = (r.hoaAnnual || 0) * Math.pow(1 + (inc.hoaInc || 0), y - 1);
            const maintA = (r.maintAnnual || 0) * Math.pow(1 + (inc.maintInc || 0), y - 1);
            const otherA = (r.otherAnnual || 0) * Math.pow(1 + (inc.otherExpInc || 0), y - 1);
            const waterA = (r.waterAnnual || 0) * Math.pow(1 + (inc.waterInc || 0), y - 1);
            const lawnA = (r.lawnAnnual || 0) * Math.pow(1 + (inc.lawnInc || 0), y - 1);
            const opExA = taxA + insA + hoaA + maintA + otherA + waterA + lawnA;

            const startIdx = (y - 1) * 12;
            const endIdx = Math.min(y * 12, months);
            let mortA = 0;
            let miA = 0;
            // Totals use P&I only (exclude MI), but cash flow/IRR subtracts MI separately
            for (let i = startIdx; i < endIdx; i++) {
              mortA += p_and_i;
              miA += miByMonth(i);
            }

            const noiA = incomeAnnual - vacancyAnnual - opExA;
            const cfA = noiA - mortA - miA;

            const idxEnd = Math.min(endIdx, months) - 1;
            const remaining = idxEnd >= 0 ? (calc.schedule[idxEnd]?.closing_balance || 0) : (calc.derived.principal_0 || 0);
            const propertyValue = basePrice * Math.pow(1 + (sell.appPct || 0), y);
            const equity = propertyValue - remaining;
            const cashIfSold = propertyValue * (1 - (sell.costToSellPct || 0)) - remaining;

            perYear.push({ y, incomeAnnual, mortA, opExA, cfA, equity, cashIfSold });

            totalRent += incomeAnnual;
            totalMort += mortA;
            totalExp += opExA;
            totalNOI += noiA;
            totalCF += cfA;
          }

          const endValue = sell.knowSell && sell.sellPrice > 0 ? sell.sellPrice : basePrice * Math.pow(1 + (sell.appPct || 0), holdYears);
          const sellCosts = endValue * (sell.costToSellPct || 0);
          const remainIdx = Math.min(holdMonths, months) - 1;
          const remainingEnd = remainIdx >= 0 ? (calc.schedule[remainIdx]?.closing_balance || 0) : 0;
          const equityFromSale = (endValue - sellCosts) - remainingEnd;

          const flows = [-initialCash];
          for (let i = 0; i < holdYears - 1; i++) flows.push(perYear[i]?.cfA || 0);
          const finalCF = (perYear[holdYears - 1]?.cfA || 0) + equityFromSale;
          flows.push(finalCF);
          const irrPct = computeIRR(flows);

          const capRate = basePrice > 0 ? ((perYear[0]?.cfA || 0) + (perYear[0]?.mortA || 0)) / basePrice * 100 : null; // NOI/PurchasePrice
          // Reference-style metrics:
          // - Total Profit When Sold = cumulative cash flow + net sale proceeds - initial cash invested
          // - Cash-on-Cash Return (%) [display] = Cumulative Net Cash Flow / initial cash (exclude sale proceeds)
          const profitWhenSold = (totalCF + equityFromSale) - initialCash;
          const cocExcludingSale = initialCash > 0 ? (totalCF / initialCash) * 100 : null;
          const cocIncludingSale = initialCash > 0 ? (profitWhenSold / initialCash) * 100 : null;

          // Expose both for potential toggling; use cocExcludingSale for display to match your reference
          return { perYear, totals: { totalRent, totalMort, totalExp, totalNOI, totalCF, equityFromSale, irrPct, capRate, coc: cocExcludingSale, coc_incl_sale: cocIncludingSale, initialCash, profitWhenSold } };
        };

        const renderInvestmentSummary = (calc) => {
          const pf = computeProForma(calc);
          const t = pf.totals;
          const safeSet = (el, v) => { if (el) el.textContent = v; };
          safeSet(outputs.out_total_rent, formatCurrency(t.totalRent));
          safeSet(outputs.out_total_mortgage, formatCurrency(t.totalMort));
          safeSet(outputs.out_total_expenses, formatCurrency(t.totalExp));
          safeSet(outputs.out_total_noi, formatCurrency(t.totalNOI));
          safeSet(outputs.out_total_profit, formatCurrencySigned(t.profitWhenSold));
          safeSet(outputs.out_cap_rate, t.capRate == null ? '—' : formatPercent(t.capRate));
          // Display CoC including sale proceeds to align with your reference (~2000%)
          safeSet(outputs.out_coc, t.coc_incl_sale == null ? '—' : formatPercent(t.coc_incl_sale));
          safeSet(outputs.out_irr, t.irrPct == null ? '—' : formatPercent(t.irrPct));
          return pf;
        };

        const renderOverTimeTable = (pf) => {
          const tbody = outputs.overTimeTableBody;
          if (!tbody) return;
          const rows = pf.perYear.map((r) => `
            <tr>
              <td>${r.y}</td>
              <td>${formatCurrency(r.incomeAnnual)}</td>
              <td>${formatCurrency(r.mortA)}</td>
              <td>${formatCurrency(r.opExA)}</td>
              <td>${formatCurrencySigned(r.cfA)}</td>
              <td>${r.y === pf.perYear.length && pf.totals.coc_incl_sale != null ? formatPercent(pf.totals.coc_incl_sale) : '—'}</td>
              <td>${formatCurrency(r.equity)}</td>
              <td>${formatCurrency(r.cashIfSold)}</td>
              <td>${r.y === pf.perYear.length && pf.totals.irrPct != null ? formatPercent(pf.totals.irrPct) : '—'}</td>
            </tr>
          `).join('');
          tbody.innerHTML = rows;
        };

        const renderExpenseDonut = (calc) => {
          const r = readRentalInputs();
          const tax = (r.taxAnnual || 0);
          const ins = (r.insAnnual || 0);
          const hoa = (r.hoaAnnual || 0);
          const maint = (r.maintAnnual || 0);
          const other = (r.otherAnnual || 0);
          const water = (r.waterAnnual || 0);
          const lawn = (r.lawnAnnual || 0);
          const vacancy = ((r.rent || 0) + (r.other || 0)) * 12 * (r.vacPct || 0);
          const data = [tax, ins, hoa, maint, other, water, lawn, vacancy];
          const labels = ['Tax', 'Insurance', 'HOA', 'Maintenance', 'Other', 'Water', 'Lawn', 'Vacancy'];
          // Solid colors for clearer legend mapping
          const colors = ['#60a5fa', '#34d399', '#fbbf24', '#f472b6', '#a78bfa', '#22d3ee', '#84cc16', '#94a3b8'];
          const canvas = outputs.expenseDonut;
          if (!canvas) return;
          // Match the chart's visual size to the height of the Year‑1 table
          const tableEl = document.getElementById('y1_income_monthly')?.closest('table');
          const tableH = tableEl ? tableEl.getBoundingClientRect().height : null;
          fitCanvasToParent(canvas, tableH);
          const ctx = canvas.getContext('2d');
          const draw = (hi = -1) => drawDonutChart(ctx, data, colors, hi);
          draw();
          const total = data.reduce((s, v) => s + v, 0) || 1;
          const legend = outputs.expenseLegend;
          if (legend) {
            legend.innerHTML = labels.map((l, i) => {
              const pct = (data[i] / total) * 100;
              return `<div class="legend-item" data-index="${i}"><span class="swatch" style="background:${colors[i]}"></span><span class="name">${l}</span> <span class="pct">${pct.toFixed(0)}%</span></div>`;
            }).join('');
            // Hover highlight from legend
            Array.from(legend.querySelectorAll('.legend-item')).forEach((el) => {
              const idx = Number(el.getAttribute('data-index'));
              el.addEventListener('mouseenter', () => draw(idx));
              el.addEventListener('mouseleave', () => draw(-1));
            });
          }
        };

        const breakdownInputs = {
          tax: $("breakdown_tax_input"),
          ins: $("breakdown_ins_input"),
          hoa: $("breakdown_hoa_input"),
        };

        const breakdownOutputs = {
          p_and_i: $("breakdown_p_and_i"),
          tax: $("breakdown_tax"),
          ins: $("breakdown_ins"),
          hoa: $("breakdown_hoa"),
          mi: $("breakdown_mi"),
          mi_row: $("breakdown_mi_row"),
          chartTotal: $("chartTotal"),
          canvas: $("breakdownChart"),
        };

        const fitCanvasToParent = (canvas, matchHeightPx = null) => {
          const parent = canvas.parentElement || canvas;
          const parentRect = parent.getBoundingClientRect();
          const dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
          // CSS pixel size we want the canvas to render at (square)
          const cssSize = Math.max(
            140,
            Math.round(
              matchHeightPx != null && matchHeightPx > 0
                ? matchHeightPx
                : parentRect.width
            )
          );
          // Backing store size in device pixels for sharpness
          const backingSize = Math.round(cssSize * dpr);
          canvas.style.width = `${cssSize}px`;
          canvas.style.height = `${cssSize}px`;
          if (canvas.width !== backingSize || canvas.height !== backingSize) {
            canvas.width = backingSize;
            canvas.height = backingSize;
          }
        };

        const drawDonutChart = (ctx, data, colors, highlightIndex = -1) => {
          const canvas = ctx.canvas;
          const centerX = canvas.width / 2;
          const centerY = canvas.height / 2;
          const radiusBase = Math.min(canvas.width, canvas.height) * 0.44;
          const holeBase = radiusBase * 0.7;

          ctx.clearRect(0, 0, canvas.width, canvas.height);

          const total = data.reduce((sum, val) => sum + val, 0);
          if (total === 0) return;

          const nonZero = data.map((v, i) => ({ v, i })).filter(x => x.v > 0);
          const gap = 0.02; // radians gap between slices for readability
          const full = Math.PI * 2;
          const totalGap = Math.max(0, (nonZero.length) * gap);
          const scale = full - totalGap;

          let angle = -Math.PI / 2;
          data.forEach((value, index) => {
            if (value <= 0) return;
            const proportion = value / total;
            const sliceAngle = proportion * scale;
            const start = angle + gap / 2;
            const end = angle + sliceAngle - gap / 2;

            const isHi = index === highlightIndex;
            const radius = isHi ? radiusBase * 1.03 : radiusBase;
            const holeRadius = isHi ? holeBase * 0.98 : holeBase;

            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, start, end);
            ctx.arc(centerX, centerY, holeRadius, end, start, true);
            ctx.closePath();
            ctx.fillStyle = colors[index % colors.length];
            ctx.fill();

            angle += sliceAngle;
          });
        };

        const renderBreakdown = (calc) => {
          const { derived } = calc;
          
          if (!breakdownOutputs.canvas) return;
          
          const tax_monthly = derived.tax_monthly;
          const ins_monthly = derived.ins_monthly;
          const hoa_monthly = derived.hoa_monthly;
          const p_and_i = derived.p_and_i;
          const mi = derived.monthly_mi_initial;
          
          const total = p_and_i + tax_monthly + ins_monthly + hoa_monthly + mi;
          
          if (breakdownOutputs.p_and_i) {
            breakdownOutputs.p_and_i.textContent = formatCurrency(p_and_i);
          }
          
          if (breakdownOutputs.tax) {
            breakdownOutputs.tax.textContent = formatCurrency(tax_monthly);
          }
          if (breakdownOutputs.ins) {
            breakdownOutputs.ins.textContent = formatCurrency(ins_monthly);
          }
          if (breakdownOutputs.hoa) {
            breakdownOutputs.hoa.textContent = formatCurrency(hoa_monthly);
          }
          if (breakdownOutputs.mi) {
            breakdownOutputs.mi.textContent = formatCurrency(mi);
          }
          if (breakdownOutputs.mi_row) {
            const miHidden = mi <= 0;
            breakdownOutputs.mi_row.classList.toggle("is-hidden", miHidden);
            const listEl = document.getElementById("breakdown_list");
            if (listEl) {
              const rows = miHidden ? 4 : 5;
              listEl.style.setProperty("--rows", String(rows));
            }
          }
          
          if (breakdownOutputs.chartTotal) {
            breakdownOutputs.chartTotal.innerHTML = `${formatCurrency(total)}<span>/mo</span>`;
          }
          
          fitCanvasToParent(breakdownOutputs.canvas);
          const ctx = breakdownOutputs.canvas.getContext("2d");
          const data = [p_and_i, tax_monthly, ins_monthly, hoa_monthly];
          if (mi > 0) data.push(mi);
          
          const colors = [
            // P&I — cyan
            ["rgba(14, 165, 233, 0.95)", "rgba(56, 189, 248, 0.85)"],
            // Tax — indigo/violet
            ["rgba(99, 102, 241, 0.95)", "rgba(139, 92, 246, 0.85)"],
            // Insurance — fuchsia/purple (distinct from tax)
            ["rgba(168, 85, 247, 0.95)", "rgba(217, 70, 239, 0.85)"],
            // HOA — teal/emerald
            ["rgba(20, 184, 166, 0.95)", "rgba(45, 212, 191, 0.85)"],
            // MI (optional) — blue
            ["rgba(59, 130, 246, 0.95)", "rgba(96, 165, 250, 0.85)"],
          ];
          
          drawDonutChart(ctx, data, colors);
          // Constrain list to match chart height (fluid, computed per render)
          const listEl = document.getElementById("breakdown_list");
          if (listEl) {
            const chartH = breakdownOutputs.canvas.getBoundingClientRect().height;
            listEl.style.height = `${Math.max(160, Math.round(chartH))}px`;
          }
        };

        const syncBreakdownToMain = () => {
          if (breakdownInputs.tax && inputs.property_tax_input) {
            const monthlyTax = toNumber(breakdownInputs.tax.value);
            const yearlyTax = monthlyTax * 12;
            inputs.property_tax_input.value = yearlyTax.toFixed(2);
          }
          
          if (breakdownInputs.ins && inputs.homeowners_insurance_yearly) {
            const monthlyIns = toNumber(breakdownInputs.ins.value);
            const yearlyIns = monthlyIns * 12;
            inputs.homeowners_insurance_yearly.value = Math.round(yearlyIns);
          }
          
          if (breakdownInputs.hoa && inputs.hoa_monthly) {
            inputs.hoa_monthly.value = Math.round(toNumber(breakdownInputs.hoa.value));
          }
        };

        const calculateAndRender = () => {
          console.log('[DEBUG] calculateAndRender called');
          const validationResult = validateInputs();
          console.log('[DEBUG] validateInputs result:', validationResult);
          if (!validationResult) {
            console.log('[DEBUG] Validation failed, exiting calculateAndRender');
            return;
          }
          console.log('[DEBUG] Reading params...');
          const params = readParams();
          console.log('[DEBUG] Params:', params);
          console.log('[DEBUG] Calling calculate_mortgage...');
          const calc = mortgageCalculator.calculate_mortgage(params);
          console.log('[DEBUG] Calc result:', calc);
          console.log('[DEBUG] Calling renderSummary...');
          try {
            renderSummary(calc);
            console.log('[DEBUG] renderSummary completed successfully');
          } catch (err) {
            console.error('[DEBUG] ERROR in renderSummary:', err);
            console.error('[DEBUG] Stack:', err.stack);
          }
          // New outputs: investment summary, over-time table, expense donut
          const pf = renderInvestmentSummary(calc);
          renderOverTimeTable(pf);
          renderExpenseDonut(calc);
          // Keep legacy hook if present
          if (typeof renderBreakdown === 'function') {
            try { renderBreakdown(calc); } catch (_) {}
          }
          updateCarousel();
          updateSliderPositions();
        };

        const CAROUSEL_STORAGE_KEY = "mortgage-carousel-index";
        const persistCarouselIndex = () => {
          try {
            sessionStorage.setItem(CAROUSEL_STORAGE_KEY, String(carousel.index));
          } catch (err) {
            console.debug("Unable to persist carousel index", err);
          }
        };

        const loadCarouselIndex = () => {
          try {
            const stored = sessionStorage.getItem(CAROUSEL_STORAGE_KEY);
            if (stored !== null) {
              const parsed = Number(stored);
              if (!Number.isNaN(parsed)) {
                carousel.index = parsed;
              }
            }
          } catch (err) {
            console.debug("Unable to load carousel index", err);
          }
        };

        let lastCarouselIndex = carousel.index;
        let isInitialCarouselSync = true;
        const updateCarousel = () => {
          if (!carousel.track) return;
          const clamped = Math.max(0, Math.min(carousel.index, carousel.slides.length - 1));
          const changed = clamped !== lastCarouselIndex;
          carousel.index = clamped;
          const viewportWidth = carousel.track.parentElement ? carousel.track.parentElement.getBoundingClientRect().width : 0;
          carousel.track.style.transform = `translateX(${-(clamped * viewportWidth)}px)`;

          if (carousel.prev) {
            const disabled = clamped === 0;
            carousel.prev.disabled = disabled;
            carousel.prev.setAttribute("aria-disabled", String(disabled));
          }
          if (carousel.next) {
            const disabled = clamped === carousel.slides.length - 1;
            carousel.next.disabled = disabled;
            carousel.next.setAttribute("aria-disabled", String(disabled));
          }

          // Reflect visible slide for screen readers
          carousel.slides.forEach((slide, idx) => {
            const isCurrent = idx === clamped;
            slide.setAttribute("aria-hidden", String(!isCurrent));
            if (isCurrent) slide.setAttribute("aria-current", "true");
            else slide.removeAttribute("aria-current");
          });

          persistCarouselIndex();

          // Persist widget state in host if available
          try {
            if (window?.openai?.setWidgetState) {
              window.openai.setWidgetState({ carouselIndex: clamped });
            }
          } catch (_) {
            /* ignore */
          }

          if (!isInitialCarouselSync && changed) {
            const cardId = carousel.slides[clamped]?.dataset.card || "unknown";
            emitTelemetry("carousel_navigated", { index: clamped, card: cardId });
          }
          lastCarouselIndex = clamped;
          if (isInitialCarouselSync) {
            isInitialCarouselSync = false;
          }
        };

        const moveCarousel = (delta) => {
          carousel.index += delta;
          updateCarousel();
        };

        if (carousel.prev) {
          carousel.prev.addEventListener("click", () => moveCarousel(-1));
        }

        if (carousel.next) {
          carousel.next.addEventListener("click", () => moveCarousel(1));
        }

        const printButton = $("printBtn");
        if (printButton) {
          printButton.addEventListener("click", () => {
            try { emitTelemetry("print_clicked", {}); } catch (_) {}
            try { window.print?.(); } catch (_) {}
          });
        }

        const resetButton = $("resetBtn");
        if (resetButton) {
          resetButton.addEventListener("click", () => {
            clearUserInputsState();
            // Reset all edited flags so derived defaults can be recalculated
            taxEdited = false;
            closingEdited = false;
            rateEdited = false;
            insuranceEdited = false;
            waterEdited = false;
            lawnEdited = false;
            setDefaults(baseDefaults);
            mergeProgramDefaults();
            setRentalDefaultsIfEmpty(true);
            // Reset price/appreciation toggle to default (Appreciation)
            const pmPrice = document.getElementById('price_mode_price');
            const pmApp = document.getElementById('price_mode_appreciation');
            if (pmPrice && pmApp) { pmPrice.checked = false; pmApp.checked = true; }
            // Reset loan preset to "Choose Preset Loan"
            const loanPresetEl = document.getElementById('loan_preset');
            if (loanPresetEl) loanPresetEl.value = '';
            // Hide VA disability toggle and reset to No
            const vaToggle = document.getElementById('vaDisabilityToggle');
            if (vaToggle) vaToggle.style.display = 'none';
            const vaNo = document.getElementById('va_disability_no');
            if (vaNo) vaNo.checked = true;
            // Reset mode to Simple
            const modeSimple = document.getElementById('mode_simple');
            if (modeSimple) modeSimple.checked = true;
            toggleMode();
            toggleLoanFields();
            toggleRepairFields();
            toggleSellFields();
            updatePriceAppHeader?.();
            adjustPurchaseDetailsSpacing?.();
            updateEstimatedIndicators();
            calculateAndRender();
            saveUserInputsState();
          });
        }

        // Unit Rent Modal
        const addUnitRentBtn = $("addUnitRentBtn");
        if (addUnitRentBtn) {
          let unitRentOverlay = null;
          let unitRents = []; // Array of unit rent values
          
          const formatCurrencyUnit = (val) => {
            const num = parseFloat(String(val).replace(/,/g, ''));
            if (!Number.isFinite(num)) return '';
            return num.toLocaleString('en-US', { maximumFractionDigits: 0 });
          };
          
          const parseUnitValue = (val) => {
            return parseFloat(String(val).replace(/[$,]/g, '')) || 0;
          };
          
          const updateUnitRentTotal = () => {
            const inputs = unitRentOverlay?.querySelectorAll('.unit-rent-input') || [];
            let total = 0;
            inputs.forEach(inp => { total += parseUnitValue(inp.value); });
            const totalEl = unitRentOverlay?.querySelector('.total-value');
            if (totalEl) totalEl.textContent = '$' + formatCurrencyUnit(total);
            return total;
          };
          
          const renderUnitList = () => {
            const listEl = unitRentOverlay?.querySelector('.unit-rent-list');
            if (!listEl) return;
            listEl.innerHTML = unitRents.map((rent, idx) => `
              <div class="unit-rent-item" data-idx="${idx}">
                <span class="unit-label">Unit ${idx + 1}</span>
                <input type="text" class="unit-rent-input" inputmode="numeric" value="${formatCurrencyUnit(rent)}" placeholder="0" />
                <button type="button" class="remove-unit-btn" title="Remove unit">✕</button>
              </div>
            `).join('');
            
            // Bind input events
            listEl.querySelectorAll('.unit-rent-input').forEach((inp, idx) => {
              inp.addEventListener('input', () => {
                unitRents[idx] = parseUnitValue(inp.value);
                updateUnitRentTotal();
              });
              inp.addEventListener('blur', () => {
                inp.value = formatCurrencyUnit(unitRents[idx]);
              });
            });
            
            // Bind remove buttons
            listEl.querySelectorAll('.remove-unit-btn').forEach((btn) => {
              btn.addEventListener('click', () => {
                const idx = parseInt(btn.closest('.unit-rent-item').dataset.idx);
                unitRents.splice(idx, 1);
                if (unitRents.length === 0) unitRents.push(0);
                renderUnitList();
                updateUnitRentTotal();
              });
            });
            
            updateUnitRentTotal();
          };
          
          const ensureUnitRentModal = () => {
            if (unitRentOverlay) return;
            unitRentOverlay = document.createElement('div');
            unitRentOverlay.className = 'modal-overlay unit-rent-modal';
            unitRentOverlay.innerHTML = `
              <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="unitRentTitle">
                <h3 id="unitRentTitle">Unit Rents</h3>
                <p>Enter the monthly rent for each unit in your property.</p>
                <div class="unit-rent-list"></div>
                <button type="button" class="unit-rent-add-btn">+ Add Another Unit</button>
                <div class="unit-rent-total">
                  <span class="total-label">Total Monthly Rent</span>
                  <span class="total-value">$0</span>
                </div>
                <div class="modal-actions">
                  <button type="button" id="unitRentCancel">Cancel</button>
                  <button type="button" id="unitRentApply" class="primary">Apply</button>
                </div>
              </div>`;
            document.body.appendChild(unitRentOverlay);
            
            // Add unit button
            unitRentOverlay.querySelector('.unit-rent-add-btn').addEventListener('click', () => {
              unitRents.push(0);
              renderUnitList();
              // Focus the new input
              const inputs = unitRentOverlay.querySelectorAll('.unit-rent-input');
              inputs[inputs.length - 1]?.focus();
            });
            
            // Cancel button
            unitRentOverlay.querySelector('#unitRentCancel').addEventListener('click', () => {
              unitRentOverlay.style.display = 'none';
            });
            
            // Apply button
            unitRentOverlay.querySelector('#unitRentApply').addEventListener('click', () => {
              const total = updateUnitRentTotal();
              const monthlyRentInput = document.getElementById('monthly_rent');
              if (monthlyRentInput) {
                monthlyRentInput.value = formatCurrencyUnit(total);
                // Trigger recalculation
                monthlyRentInput.dispatchEvent(new Event('input', { bubbles: true }));
              }
              unitRentOverlay.style.display = 'none';
            });
            
            // Close on overlay click
            unitRentOverlay.addEventListener('click', (e) => {
              if (e.target === unitRentOverlay) unitRentOverlay.style.display = 'none';
            });
          };
          
          const openUnitRentModal = () => {
            ensureUnitRentModal();
            // Initialize with 4 units by default
            if (unitRents.length === 0) {
              const currentRent = parseUnitValue(document.getElementById('monthly_rent')?.value || 0);
              unitRents = [currentRent > 0 ? currentRent : 0, 0, 0, 0];
            }
            renderUnitList();
            // Position modal near the button
            const btnRect = addUnitRentBtn.getBoundingClientRect();
            const topOffset = Math.max(16, btnRect.top - 20);
            unitRentOverlay.style.setProperty('--modal-top', topOffset + 'px');
            unitRentOverlay.style.display = 'flex';
          };
          
          addUnitRentBtn.addEventListener('click', openUnitRentModal);
        }

        // Save Calculation Feature
        const SAVED_CALCS_KEY = 'rental_calc_saved_calculations';
        let savedCalculations = [];
        let saveCalcOverlay = null;
        let currentEditId = null;
        
        const loadSavedCalculations = () => {
          try {
            const stored = localStorage.getItem(SAVED_CALCS_KEY);
            savedCalculations = stored ? JSON.parse(stored) : [];
          } catch (_) { savedCalculations = []; }
        };
        
        const persistSavedCalculations = () => {
          try { localStorage.setItem(SAVED_CALCS_KEY, JSON.stringify(savedCalculations)); } catch (_) {}
        };
        
        const getAllInputValues = () => {
          const inputs = {};
          PERSIST_INPUT_IDS.forEach(id => {
            const el = document.getElementById(id);
            if (el) inputs[id] = el.value;
          });
          // Also save toggles
          inputs._use_loan = document.getElementById('use_loan_yes')?.checked ? 'yes' : 'no';
          inputs._need_repairs = document.getElementById('need_repairs_yes')?.checked ? 'yes' : 'no';
          inputs._loan_preset = document.getElementById('loan_preset')?.value || '';
          inputs._va_disability = document.getElementById('va_disability_yes')?.checked ? 'yes' : 'no';
          inputs._calc_mode = document.getElementById('mode_simple')?.checked ? 'simple' : 'advanced';
          return inputs;
        };
        
        const restoreInputValues = (inputs) => {
          if (!inputs) return;
          Object.keys(inputs).forEach(id => {
            if (id.startsWith('_')) return; // Skip special keys
            const el = document.getElementById(id);
            if (el) el.value = inputs[id];
          });
          // Restore toggles
          if (inputs._use_loan === 'yes') document.getElementById('use_loan_yes').checked = true;
          else document.getElementById('use_loan_no').checked = true;
          if (inputs._need_repairs === 'yes') document.getElementById('need_repairs_yes').checked = true;
          else document.getElementById('need_repairs_no').checked = true;
          if (inputs._loan_preset) document.getElementById('loan_preset').value = inputs._loan_preset;
          if (inputs._va_disability === 'yes') document.getElementById('va_disability_yes').checked = true;
          else document.getElementById('va_disability_no').checked = true;
          if (inputs._calc_mode === 'simple') document.getElementById('mode_simple').checked = true;
          else document.getElementById('mode_advanced').checked = true;
          // Apply toggles
          toggleMode();
          toggleLoanFields();
          toggleRepairFields();
          // Show VA toggle if needed
          const vaToggle = document.getElementById('vaDisabilityToggle');
          if (vaToggle) vaToggle.style.display = inputs._loan_preset === 'va-zero' ? 'flex' : 'none';
          calculateAndRender();
        };
        
        const formatPrice = (val) => {
          const num = parseFloat(String(val).replace(/[$,]/g, '')) || 0;
          return '$' + num.toLocaleString('en-US', { maximumFractionDigits: 0 });
        };
        
        const renderSavedCalcsList = () => {
          const container = document.getElementById('savedCalcsListMain');
          if (!container) return;
          
          if (savedCalculations.length === 0) {
            container.innerHTML = '<div class="saved-calcs-empty">No saved calculations yet. Use the Save button below to save your first calculation.</div>';
            return;
          }
          
          container.innerHTML = savedCalculations.map((calc, idx) => `
            <div class="saved-calc-item" data-id="${calc.id}">
              <div class="saved-calc-info">
                <div class="saved-calc-name">${calc.name}</div>
                <div class="saved-calc-meta">${formatPrice(calc.inputs?.purchase_price || 0)} · ${new Date(calc.savedAt).toLocaleDateString()}</div>
              </div>
              <div class="saved-calc-actions">
                <button type="button" class="load-btn" title="Load">Load</button>
                <button type="button" class="duplicate-btn" title="Duplicate">Copy</button>
                <button type="button" class="delete-btn" title="Delete">✕</button>
              </div>
            </div>
          `).join('');
          
          // Bind actions
          container.querySelectorAll('.saved-calc-item').forEach(item => {
            const id = item.dataset.id;
            item.querySelector('.load-btn')?.addEventListener('click', (e) => {
              e.stopPropagation();
              const calc = savedCalculations.find(c => c.id === id);
              if (calc) {
                restoreInputValues(calc.inputs);
                currentEditId = id;
                showToast('success', 'Calculation loaded');
              }
            });
            item.querySelector('.duplicate-btn')?.addEventListener('click', (e) => {
              e.stopPropagation();
              const calc = savedCalculations.find(c => c.id === id);
              if (calc) {
                const newCalc = {
                  id: Date.now().toString(),
                  name: calc.name + ' (copy)',
                  inputs: { ...calc.inputs },
                  savedAt: new Date().toISOString()
                };
                savedCalculations.unshift(newCalc);
                persistSavedCalculations();
                renderSavedCalcsList();
                updateSavedCount();
                showToast('success', 'Calculation duplicated');
              }
            });
            item.querySelector('.delete-btn')?.addEventListener('click', (e) => {
              e.stopPropagation();
              savedCalculations = savedCalculations.filter(c => c.id !== id);
              persistSavedCalculations();
              renderSavedCalcsList();
              updateSavedCount();
              showToast('success', 'Calculation deleted');
            });
            // Click on item to load
            item.addEventListener('click', () => {
              const calc = savedCalculations.find(c => c.id === id);
              if (calc) {
                restoreInputValues(calc.inputs);
                currentEditId = id;
                showToast('success', 'Calculation loaded');
              }
            });
          });
        };
        
        const updateSavedCount = () => {
          const badgeEl = document.getElementById('savedCalcsBadge');
          const panelEl = document.getElementById('savedCalcsPanel');
          if (badgeEl) {
            badgeEl.textContent = savedCalculations.length;
            badgeEl.setAttribute('data-count', savedCalculations.length);
          }
          // Show/hide the saved calculations section based on count
          if (panelEl) {
            panelEl.style.display = savedCalculations.length > 0 ? '' : 'none';
          }
        };
        
        const ensureSaveCalcModal = () => {
          if (saveCalcOverlay) return;
          saveCalcOverlay = document.createElement('div');
          saveCalcOverlay.className = 'modal-overlay save-calc-modal';
          saveCalcOverlay.innerHTML = `
            <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="saveCalcTitle">
              <h3 id="saveCalcTitle">Save Calculation</h3>
              <p>Give this calculation a name (e.g., property address)</p>
              <input type="text" id="saveCalcName" placeholder="123 Main St, City, State" />
              <div class="modal-actions">
                <button type="button" id="saveCalcCancel">Cancel</button>
                <button type="button" id="saveCalcSubmit" class="primary">Save</button>
              </div>
            </div>`;
          document.body.appendChild(saveCalcOverlay);
          
          // Save button
          saveCalcOverlay.querySelector('#saveCalcSubmit').addEventListener('click', () => {
            const nameInput = saveCalcOverlay.querySelector('#saveCalcName');
            const name = nameInput.value.trim();
            if (!name) {
              nameInput.focus();
              return;
            }
            
            const inputs = getAllInputValues();
            
            if (currentEditId) {
              // Update existing
              const idx = savedCalculations.findIndex(c => c.id === currentEditId);
              if (idx !== -1) {
                savedCalculations[idx] = {
                  ...savedCalculations[idx],
                  name,
                  inputs,
                  savedAt: new Date().toISOString()
                };
              }
            } else {
              // Create new
              const newCalc = {
                id: Date.now().toString(),
                name,
                inputs,
                savedAt: new Date().toISOString()
              };
              savedCalculations.unshift(newCalc);
            }
            
            persistSavedCalculations();
            renderSavedCalcsList();
            updateSavedCount();
            nameInput.value = '';
            currentEditId = null;
            saveCalcOverlay.style.display = 'none';
            showToast('success', 'Calculation saved!');
          });
          
          // Cancel button
          saveCalcOverlay.querySelector('#saveCalcCancel').addEventListener('click', () => {
            saveCalcOverlay.style.display = 'none';
          });
          
          // Close on overlay click
          saveCalcOverlay.addEventListener('click', (e) => {
            if (e.target === saveCalcOverlay) saveCalcOverlay.style.display = 'none';
          });
        };
        
        const openSaveCalcModal = (triggerBtn) => {
          ensureSaveCalcModal();
          // Position modal slightly above the button that triggered it
          if (triggerBtn) {
            const btnRect = triggerBtn.getBoundingClientRect();
            const topOffset = Math.max(60, btnRect.top - 180);
            saveCalcOverlay.style.setProperty('--modal-top', topOffset + 'px');
          } else {
            saveCalcOverlay.style.setProperty('--modal-top', '25vh');
          }
          saveCalcOverlay.style.display = 'flex';
          saveCalcOverlay.querySelector('#saveCalcName')?.focus();
        };
        
        const saveCalcBtn = $("saveCalcBtn");
        if (saveCalcBtn) {
          saveCalcBtn.addEventListener('click', () => openSaveCalcModal(saveCalcBtn));
        }
        
        // Also bind the highlight section save button
        const highlightSaveBtn = $("highlightSaveBtn");
        if (highlightSaveBtn) {
          highlightSaveBtn.addEventListener('click', () => openSaveCalcModal(highlightSaveBtn));
        }
        
        // Highlight print button - same as bottom print button
        const highlightPrintBtn = $("highlightPrintBtn");
        if (highlightPrintBtn) {
          highlightPrintBtn.addEventListener('click', () => {
            try { emitTelemetry("print_clicked", {}); } catch (_) {}
            window.print();
          });
        }
        
        // Load and render saved calculations on init
        loadSavedCalculations();
        renderSavedCalcsList();
        updateSavedCount();

        // Feedback modal & tracking
        const feedbackBtn = $("feedbackBtn");
        if (feedbackBtn) {
          let fbOverlay, fbTextarea, fbStatusEl, fbCancelBtn, fbSubmitBtn;

          const ensureFeedbackModal = () => {
            if (fbOverlay) return;
            fbOverlay = document.createElement('div');
            fbOverlay.className = 'modal-overlay';
            fbOverlay.innerHTML = `
              <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="fbTitle">
                <h3 id="fbTitle">Share feedback</h3>
                <p>Tell us what worked or what could be improved.</p>
                <textarea id="fbText" placeholder="Your feedback..."></textarea>
                <div id="fbStatus" class="modal-status"></div>
                <div class="modal-actions">
                  <button type="button" id="fbCancel">Cancel</button>
                  <button type="button" id="fbSubmit" class="primary">Send</button>
                </div>
              </div>`;
            document.body.appendChild(fbOverlay);
            fbTextarea = fbOverlay.querySelector('#fbText');
            fbStatusEl = fbOverlay.querySelector('#fbStatus');
            fbCancelBtn = fbOverlay.querySelector('#fbCancel');
            fbSubmitBtn = fbOverlay.querySelector('#fbSubmit');

            const onCancel = () => { fbOverlay.style.display = 'none'; };
            fbCancelBtn.addEventListener('click', onCancel);
            fbOverlay.addEventListener('click', (e) => { if (e.target === fbOverlay) onCancel(); });
            fbTextarea.addEventListener('keydown', (e) => {
              if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'enter') submitFeedback();
            });
            fbSubmitBtn.addEventListener('click', () => submitFeedback());
          };

          const openFeedback = () => {
            ensureFeedbackModal();
            if (fbStatusEl) fbStatusEl.textContent = '';
            if (fbTextarea) fbTextarea.value = '';
            fbOverlay.style.display = 'flex';
            setTimeout(() => fbTextarea?.focus(), 0);
          };

          const TRACK_ENDPOINTS = [
            'https://mortgage-calculator-open-ai.onrender.com/api/track',
            'http://localhost:8000/api/track',
            '/api/track',
          ];

          const postJson = async (url, payload) => {
            return fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              mode: 'cors',
              body: JSON.stringify(payload),
            });
          };

          const submitFeedback = async () => {
            const feedback = (fbTextarea?.value || '').trim();
            if (!feedback) {
              if (fbStatusEl) fbStatusEl.textContent = 'Please enter feedback.';
              return;
            }
            if (fbStatusEl) fbStatusEl.textContent = 'Sending…';
            try { emitTelemetry('user_feedback', { feedback }); } catch (_) {}

            try {
              let ok = false;
              for (const url of TRACK_ENDPOINTS) {
                try {
                  const resp = await postJson(url, { event: 'user_feedback', data: { feedback } });
                  if (resp && resp.ok) { ok = true; break; }
                } catch (_) {
                  // try next endpoint
                }
              }
              if (ok) {
                if (fbStatusEl) fbStatusEl.textContent = 'Thanks for your feedback!';
                fbOverlay.style.display = 'none';
                window.setTimeout(() => window.alert('Thanks for your feedback!'), 50);
              } else {
                if (fbStatusEl) fbStatusEl.textContent = 'Failed to send feedback. Please try again.';
                showToast('error', 'Feedback failed');
              }
            } catch (err) {
              console.error('Notify subscription error', err);
              if (fbStatusEl) fbStatusEl.textContent = 'Failed to send feedback. Please try again.';
              showToast('error', 'Feedback failed');
            }
          };

          feedbackBtn.addEventListener('click', (e) => { e.preventDefault(); openFeedback(); });
        }

        const recalcButton = $("calculateBtn");
        if (recalcButton) {
          recalcButton.addEventListener("click", calculateAndRender);
        }

        inputs.loan_type.addEventListener("change", () => {
          mergeProgramDefaults();
          calculateAndRender();
        });

        // ---------- Persisted user inputs (72h) via Apps SDK widgetState with localStorage fallback ----------
        const PERSIST_KEY = "rpc_user_inputs_state_v1";
        const PERSIST_TTL_MS = 72 * 60 * 60 * 1000;

        const PERSIST_INPUT_IDS = [
          // Income
          'monthly_rent','other_monthly_income','vacancy_rate_pct',
          'monthly_rent_increase_pct','other_monthly_income_increase_pct',
          // Operating expenses
          'exp_property_tax_annual','exp_insurance_annual','exp_hoa_annual','exp_maintenance_annual','exp_other_annual',
          'exp_property_tax_increase_pct','exp_insurance_increase_pct','exp_hoa_increase_pct','exp_maintenance_increase_pct','exp_other_increase_pct',
          // Purchase details / loan
          'purchase_price','closing_cost','down_payment_pct','interest_rate_pct','loan_term_years',
          // Repairs
          'repair_cost','after_repair_value',
          // Sell / exit
          'sell_price','holding_length_years','cost_to_sell_pct','value_appreciation_pct'
        ];

        const readToggleValue = (yesId, noId) => {
          const yes = document.getElementById(yesId);
          const no = document.getElementById(noId);
          return !!(yes && yes.checked);
        };

        const getInputsState = () => {
          const inputsObj = {};
          PERSIST_INPUT_IDS.forEach((id) => {
            const el = document.getElementById(id);
            if (!el) return;
            inputsObj[id] = String(el.value ?? "");
          });
          const state = {
            savedAt: Date.now(),
            inputs: inputsObj,
            toggles: {
              use_loan: readToggleValue('use_loan_yes','use_loan_no'),
              need_repairs: readToggleValue('need_repairs_yes','need_repairs_no'),
              price_mode: (document.getElementById('price_mode_price')?.checked ? 'price' : 'appreciation')
            }
          };
          return state;
        };

        const saveUserInputsState = () => {
          try {
            const state = getInputsState();
            // Apps SDK widgetState
            const base = (window?.openai?.widgetState) ? { ...window.openai.widgetState } : {};
            if (window?.openai?.setWidgetState) {
              window.openai.setWidgetState({ ...base, rentalInputsState: state });
            }
            // Fallback localStorage for cross-prompt persistence
            try { localStorage.setItem(PERSIST_KEY, JSON.stringify(state)); } catch(_) {}
          } catch(_) { /* no-op */ }
        };

        const loadUserInputsState = () => {
          let state = null;
          // First, try the official widgetState (scoped to this widget instance)
          try { state = window?.openai?.widgetState?.rentalInputsState || null; } catch(_) { state = null; }
          // If no widgetState, fall back to localStorage for cross-prompt persistence
          if (!state) {
            try { state = JSON.parse(localStorage.getItem(PERSIST_KEY) || 'null'); } catch(_) { state = null; }
          }
          // If still no state, or it's expired, return null
          if (!state || !state.savedAt || (Date.now() - state.savedAt) > PERSIST_TTL_MS) return null;
          return state;
        };

        const hydrateInputsFromState = () => {
          console.log('[Debug] Starting hydrateInputsFromState...');
          const state = loadUserInputsState();
          if (!state) {
            console.log('[Debug] loadUserInputsState returned null. No saved state found.');
            return false;
          }
          console.log('[Debug] Found saved state:', state);

          const entries = Object.entries(state.inputs || {});
          const hasMeaningfulInput = entries.some(([, val]) => {
            const s = String(val ?? '').trim();
            return s !== '';
          });
          // If everything saved was blank, treat as no prior state so defaults can apply
          if (!hasMeaningfulInput) {
            console.log('[Debug] State has no meaningful input. Ignoring and applying defaults.');
            return false;
          }
          console.log('[Debug] State has meaningful input. Proceeding to hydrate inputs.');

          // Fill inputs
          entries.forEach(([id, val]) => {
            const el = document.getElementById(id);
            if (!el) return;
            el.value = String(val);
          });
          // Only mark interest rate as edited from saved state (to avoid API overwrite)
          // Price-based estimates should show "Est." indicator until user manually edits them this session
          if (state.inputs && 'interest_rate_pct' in state.inputs) rateEdited = true;

          // Radios / toggles
          try {
            const setRadio = (yesId, noId, on) => {
              const yes = document.getElementById(yesId);
              const no = document.getElementById(noId);
              if (yes && no) { yes.checked = !!on; no.checked = !on; }
            };
            setRadio('use_loan_yes','use_loan_no', !!state.toggles?.use_loan);
            setRadio('need_repairs_yes','need_repairs_no', !!state.toggles?.need_repairs);
            const priceOn = (state.toggles?.price_mode === 'price');
            const pmPrice = document.getElementById('price_mode_price');
            const pmApp = document.getElementById('price_mode_appreciation');
            if (pmPrice && pmApp) { pmPrice.checked = priceOn; pmApp.checked = !priceOn; }
          } catch(_) {}
          return true;
        };

        const clearUserInputsState = () => {
          try {
            if (window?.openai?.setWidgetState) {
              const base = (window?.openai?.widgetState) ? { ...window.openai.widgetState } : {};
              delete base.rentalInputsState;
              window.openai.setWidgetState(base);
            }
          } catch(_) {}
          try { localStorage.removeItem(PERSIST_KEY); } catch(_) {}
        };

        // Update "estimated" indicator visibility based on edited flags
        const updateEstimatedIndicators = () => {
          const setIndicator = (id, isEstimated) => {
            const el = document.getElementById(id);
            if (el) el.classList.toggle('hidden', !isEstimated);
          };
          setIndicator('closing_cost_estimated', !closingEdited);
          setIndicator('exp_property_tax_estimated', !taxEdited);
          setIndicator('simple_property_tax_estimated', !taxEdited);
          setIndicator('exp_insurance_estimated', !insuranceEdited);
          setIndicator('exp_water_estimated', !waterEdited);
          setIndicator('exp_lawn_estimated', !lawnEdited);
        };

        // Update price-based estimates when purchase price changes
        const updatePriceBasedEstimates = () => {
          const ppEl = document.getElementById('purchase_price');
          const pp = Number((ppEl?.value || '0').toString().replace(/[$,]/g, '')) || 0;
          if (!pp) return;
          
          const taxEl = document.getElementById('exp_property_tax_annual');
          const closeEl = document.getElementById('closing_cost');
          const insEl = document.getElementById('exp_insurance_annual');
          const waterEl = document.getElementById('exp_water_annual');
          const lawnEl = document.getElementById('exp_lawn_annual');
          
          // Property Tax: 1.1% of purchase price
          if (taxEl && !taxEdited) {
            taxEl.value = String(Math.round(pp * 0.011));
            // Sync simple mode property tax
            const simpleTaxEl = document.getElementById('simple_property_tax');
            if (simpleTaxEl) simpleTaxEl.value = taxEl.value;
          }
          // Closing Cost: 2% of purchase price (rounded to nearest $100)
          if (closeEl && !closingEdited) {
            closeEl.value = String(Math.round(pp * 0.02 / 100) * 100);
          }
          // Insurance: 0.35% of purchase price
          if (insEl && !insuranceEdited) {
            insEl.value = String(Math.round(pp * 0.0035));
          }
          // Water/Sewer: $1,200 base + 0.1% of price
          if (waterEl && !waterEdited) {
            waterEl.value = String(Math.round(1200 + pp * 0.001));
          }
          // Lawn Care: 0.15% of purchase price (min $300)
          if (lawnEl && !lawnEdited) {
            lawnEl.value = String(Math.max(300, Math.round(pp * 0.0015)));
          }
          
          updateEstimatedIndicators();
        };

        const bindRecalc = (id, evt = 'input') => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener(evt, () => {
            didUserEdit = true;
            if (id === 'interest_rate_pct' || id === 'loan_rate_slider') rateEdited = true;
            if (id === 'exp_property_tax_annual') taxEdited = true;
            if (id === 'closing_cost') closingEdited = true;
            if (id === 'exp_insurance_annual') insuranceEdited = true;
            if (id === 'exp_water_annual') waterEdited = true;
            if (id === 'exp_lawn_annual') lawnEdited = true;
            // When purchase price changes, update all price-based estimates
            if (id === 'purchase_price') updatePriceBasedEstimates();
            // Update indicator visibility when any estimated field is edited
            if (['exp_property_tax_annual', 'closing_cost', 'exp_insurance_annual', 'exp_water_annual', 'exp_lawn_annual', 'simple_property_tax'].includes(id)) {
              if (id === 'simple_property_tax') taxEdited = true;
              updateEstimatedIndicators();
            }
            calculateAndRender();
            saveUserInputsState();
          });
        };
        [
          // Income
          'monthly_rent','other_monthly_income','vacancy_rate_pct',
          'monthly_rent_increase_pct','other_monthly_income_increase_pct',
          // Operating expenses
          'exp_property_tax_annual','exp_insurance_annual','exp_hoa_annual','exp_maintenance_annual','exp_other_annual','exp_water_annual','exp_lawn_annual',
          'exp_property_tax_increase_pct','exp_insurance_increase_pct','exp_hoa_increase_pct','exp_maintenance_increase_pct','exp_other_increase_pct','exp_water_increase_pct','exp_lawn_increase_pct',
          // Purchase details / loan (including simple mode property tax)
          'purchase_price','closing_cost','simple_property_tax','down_payment_pct','interest_rate_pct','loan_term_years',
          // Repairs
          'repair_cost','after_repair_value',
          // Sell / exit
          'sell_price','holding_length_years','cost_to_sell_pct','value_appreciation_pct'
        ].forEach((id) => bindRecalc(id, 'input'));
        // Radios / toggles
        ['use_loan_yes','use_loan_no','need_repairs_yes','need_repairs_no','know_sell_price_yes','know_sell_price_no','price_mode_price','price_mode_appreciation']
          .forEach((id) => bindRecalc(id, 'change'));

        // Explicit listeners for rate slider to set the edited flag immediately
        const rateSlider = document.getElementById('loan_rate_slider');
        if (rateSlider) rateSlider.addEventListener('input', () => { didUserEdit = true; rateEdited = true; });

        // Currency input formatting with commas
        const currencyInputIds = [
          'purchase_price', 'closing_cost', 'monthly_rent', 'other_monthly_income',
          'exp_property_tax_annual', 'exp_insurance_annual', 'exp_hoa_annual',
          'exp_maintenance_annual', 'exp_other_annual', 'exp_water_annual', 'exp_lawn_annual',
          'simple_property_tax',
          'sell_price', 'repair_cost', 'after_repair_value'
        ];
        
        const formatWithCommas = (value) => {
          const num = parseFloat(String(value).replace(/,/g, ''));
          if (!Number.isFinite(num)) return '';
          return num.toLocaleString('en-US', { maximumFractionDigits: 0 });
        };
        
        const setupCurrencyInput = (id) => {
          const el = document.getElementById(id);
          if (!el) return;
          
          // Format on blur
          el.addEventListener('blur', () => {
            const raw = el.value.replace(/,/g, '');
            if (raw !== '' && !isNaN(parseFloat(raw))) {
              el.value = formatWithCommas(raw);
            }
          });
          
          // Remove formatting on focus for easier editing
          el.addEventListener('focus', () => {
            const raw = el.value.replace(/,/g, '');
            if (raw !== '') el.value = raw;
          });
          
          // Format initial value if present
          if (el.value) {
            el.value = formatWithCommas(el.value);
          }
        };
        
        currencyInputIds.forEach(setupCurrencyInput);
        updateMiVisibility();
        updateCarousel();
        let resizeRaf = 0;
        window.addEventListener("resize", () => {
          if (resizeRaf) cancelAnimationFrame(resizeRaf);
          resizeRaf = requestAnimationFrame(() => {
            updateCarousel();
            const breakdownSlide = document.querySelector('.carousel-slide[data-card="breakdown"]');
            const isBreakdownVisible = breakdownSlide && breakdownSlide.getAttribute('aria-hidden') === 'false';
            if (isBreakdownVisible) {
              if (breakdownOutputs.canvas) fitCanvasToParent(breakdownOutputs.canvas);
              const params = readParams();
              const calc = mortgageCalculator.calculate_mortgage(params);
              renderBreakdown(calc);
            }
          });
        });

        const carouselWindowEl = document.querySelector(".carousel-window");
        let pointerStartX = null;
        const SWIPE_THRESHOLD = 30;

        if (carouselWindowEl) {
          carouselWindowEl.addEventListener("pointerdown", (event) => {
            if (event.pointerType === "touch" || event.pointerType === "pen") {
              pointerStartX = event.clientX;
            }
          });

          const handlePointerEnd = (event) => {
            if (pointerStartX === null) return;
            const deltaX = event.clientX - pointerStartX;
            if (Math.abs(deltaX) > SWIPE_THRESHOLD) {
              moveCarousel(deltaX < 0 ? 1 : -1);
            }
            pointerStartX = null;
          };

          carouselWindowEl.addEventListener("pointerup", handlePointerEnd);
          carouselWindowEl.addEventListener("pointercancel", () => {
            pointerStartX = null;
          });
        }

        document.addEventListener("keydown", (event) => {
          const target = event.target;
          if (target && ["INPUT", "SELECT", "TEXTAREA"].includes(target.tagName)) {
            return;
          }

          if (event.key === "ArrowLeft") {
            event.preventDefault();
            moveCarousel(-1);
          } else if (event.key === "ArrowRight") {
            event.preventDefault();
            moveCarousel(1);
          }
        });

        const scenarioConfigs = {
          "first-time": (current) => {
            const hv = Math.max(100000, toNumber(current.home_value.value) || baseDefaults.home_value);
            return {
              loan_type: "conventional",
              down_payment_value: Math.round(hv * 0.03),
              rate_apr: Math.max(4.5, toNumber(current.rate_apr.value) || baseDefaults.rate_apr),
              term_years: 30,
            };
          },
          conventional: (current) => {
            const hv = Math.max(100000, toNumber(current.home_value.value) || baseDefaults.home_value);
            return {
              loan_type: "conventional",
              down_payment_value: Math.round(hv * 0.2),
              rate_apr: toNumber(current.rate_apr.value) || baseDefaults.rate_apr,
              term_years: 30,
            };
          },
          va: () => ({
            loan_type: "VA",
            down_payment_value: 0,
            term_years: 30,
          }),
        };

        const applyScenario = (scenarioKey) => {
          const configFn = scenarioConfigs[scenarioKey];
          if (!configFn) return;
          const overrides = configFn(inputs);
          Object.entries(overrides).forEach(([key, value]) => {
            if (!(key in inputs)) return;
            if (inputs[key].type === "checkbox") {
              inputs[key].checked = Boolean(value);
            } else {
              inputs[key].value = percentInputSet.has(key) ? formatPercentValue(value) : value;
            }
          });
          if (overrides.loan_type) {
            mergeProgramDefaults();
          }
          updateSliderPositions();
          calculateAndRender();
        };

        const markActiveScenario = (target) => {
          if (!scenarioBar) return;
          scenarioBar.querySelectorAll(".scenario-chip").forEach((chip) => {
            chip.classList.toggle("active", chip === target);
          });
        };

        if (scenarioBar) {
          scenarioBar.addEventListener("click", (event) => {
            const chip = event.target.closest(".scenario-chip");
            if (!chip) return;
            const key = chip.getAttribute("data-scenario");
            if (!key) return;
            markActiveScenario(chip);
            applyScenario(key);
            emitTelemetry("scenario_applied", { scenario: key });
          });
        }

        const attachSlider = (slider, onChange) => {
          if (!slider) return;
          slider.addEventListener("input", onChange);
          slider.addEventListener("change", onChange);
        };

        attachSlider(sliders.down_payment, () => {
          const hv = toNumber(inputs.home_value.value);
          const pct = Number(sliders.down_payment.value) / 100;
          inputs.down_payment_value.value = Math.round(hv * pct);
          if (sliderDisplays.down_payment) sliderDisplays.down_payment.textContent = `${sliders.down_payment.value}%`;
          calculateAndRender();
        });

        attachSlider(sliders.rate, () => {
          const val = Number(sliders.rate.value);
          inputs.rate_apr.value = val.toFixed(2);
          if (sliderDisplays.rate) sliderDisplays.rate.textContent = `${inputs.rate_apr.value}%`;
          calculateAndRender();
        });

        attachSlider(sliders.term, () => {
          const val = Math.round(Number(sliders.term.value));
          inputs.term_years.value = val;
          if (sliderDisplays.term) sliderDisplays.term.textContent = `${val}y`;
          calculateAndRender();
        });

        // Sliders for Purchase Details: Use Loan fields
        const loanInputsMap = {
          dp_pct: document.getElementById('down_payment_pct'),
          rate_pct: document.getElementById('interest_rate_pct'),
          term_years: document.getElementById('loan_term_years'),
        };
        const loanSlidersMap = {
          dp: document.getElementById('loan_dp_slider'),
          rate: document.getElementById('loan_rate_slider'),
          term: document.getElementById('loan_term_slider'),
        };
        const loanDisplaysMap = {
          dp: document.getElementById('loan_dp_slider_display'),
          rate: document.getElementById('loan_rate_slider_display'),
          term: document.getElementById('loan_term_slider_display'),
        };

        attachSlider(loanSlidersMap.dp, () => {
          const v = Math.min(75, Math.max(0, Number(loanSlidersMap.dp.value) || 0));
          if (loanInputsMap.dp_pct) loanInputsMap.dp_pct.value = String(v);
          if (loanDisplaysMap.dp) loanDisplaysMap.dp.textContent = `${v}%`;
        });

        attachSlider(loanSlidersMap.rate, () => {
          const v = Math.min(15, Math.max(0, Number(loanSlidersMap.rate.value) || 0));
          if (loanInputsMap.rate_pct) loanInputsMap.rate_pct.value = v.toFixed(2);
          if (loanDisplaysMap.rate) loanDisplaysMap.rate.textContent = `${v.toFixed(2)}%`;
        });

        attachSlider(loanSlidersMap.term, () => {
          const v = Math.round(Math.min(40, Math.max(5, Number(loanSlidersMap.term.value) || 30)));
          if (loanInputsMap.term_years) loanInputsMap.term_years.value = String(v);
          if (loanDisplaysMap.term) loanDisplaysMap.term.textContent = `${v}y`;
        });

        // Keep sliders in sync when typing numbers
        if (loanInputsMap.dp_pct && loanSlidersMap.dp) {
          loanInputsMap.dp_pct.addEventListener('change', () => {
            const v = Math.min(75, Math.max(0, Number(loanInputsMap.dp_pct.value) || 0));
            loanSlidersMap.dp.value = String(v);
            if (loanDisplaysMap.dp) loanDisplaysMap.dp.textContent = `${v}%`;
          });
        }
        if (loanInputsMap.rate_pct && loanSlidersMap.rate) {
          loanInputsMap.rate_pct.addEventListener('change', () => {
            const v = Math.min(15, Math.max(0, Number(loanInputsMap.rate_pct.value) || 0));
            loanSlidersMap.rate.value = String(v);
            if (loanDisplaysMap.rate) loanDisplaysMap.rate.textContent = `${v.toFixed(2)}%`;
          });
        }
        if (loanInputsMap.term_years && loanSlidersMap.term) {
          loanInputsMap.term_years.addEventListener('change', () => {
            const v = Math.round(Math.min(40, Math.max(5, Number(loanInputsMap.term_years.value) || 30)));
            loanSlidersMap.term.value = String(v);
            if (loanDisplaysMap.term) loanDisplaysMap.term.textContent = `${v}y`;
          });
        }

        // Initialize slider positions from current input values
        if (loanSlidersMap.dp && loanInputsMap.dp_pct) {
          const v = Math.min(75, Math.max(0, Number(loanInputsMap.dp_pct.value) || 0));
          loanSlidersMap.dp.value = String(v);
          if (loanDisplaysMap.dp) loanDisplaysMap.dp.textContent = `${v}%`;
        }
        if (loanSlidersMap.rate && loanInputsMap.rate_pct) {
          const v = Math.min(15, Math.max(0, Number(loanInputsMap.rate_pct.value) || 0));
          loanSlidersMap.rate.value = String(v);
          if (loanDisplaysMap.rate) loanDisplaysMap.rate.textContent = `${v.toFixed(2)}%`;
        }
        if (loanSlidersMap.term && loanInputsMap.term_years) {
          const v = Math.round(Math.min(40, Math.max(5, Number(loanInputsMap.term_years.value) || 30)));
          loanSlidersMap.term.value = String(v);
          if (loanDisplaysMap.term) loanDisplaysMap.term.textContent = `${v}y`;
        }

        const loanPresetSelect = document.getElementById('loan_preset');
        const loanPresetChips = Array.from(document.querySelectorAll('.preset-chip'));

        const setLoanPresetActive = (key) => {
          loanPresetChips.forEach((btn) => btn.classList.toggle('active', btn.getAttribute('data-preset') === key));
          if (loanPresetSelect && loanPresetSelect.value !== key) loanPresetSelect.value = key || '';
        };

        const applyLoanPreset = (key) => {
          const map = {
            'first-time': { dp: 3, term: 30 },
            'conventional-20': { dp: 20, term: 30 },
            'va-zero': { dp: 0, term: 30 },
          };
          const cfg = map[key];
          if (!cfg) return;
          if (loanInputsMap.dp_pct) loanInputsMap.dp_pct.value = String(cfg.dp);
          if (loanSlidersMap.dp) loanSlidersMap.dp.value = String(cfg.dp);
          if (loanDisplaysMap.dp) loanDisplaysMap.dp.textContent = `${cfg.dp}%`;
          if (loanInputsMap.term_years) loanInputsMap.term_years.value = String(cfg.term);
          if (loanSlidersMap.term) loanSlidersMap.term.value = String(cfg.term);
          if (loanDisplaysMap.term) loanDisplaysMap.term.textContent = `${cfg.term}y`;
        };

        // Show/hide VA disability toggle based on loan preset
        const toggleVaDisability = (presetKey) => {
          const vaToggle = document.getElementById('vaDisabilityToggle');
          if (vaToggle) {
            vaToggle.style.display = presetKey === 'va-zero' ? 'flex' : 'none';
          }
          // Reset to "No" when hiding
          if (presetKey !== 'va-zero') {
            const noRadio = document.getElementById('va_disability_no');
            if (noRadio) noRadio.checked = true;
          }
        };

        if (loanPresetSelect) {
          loanPresetSelect.addEventListener('change', (e) => {
            const key = e.target.value || '';
            setLoanPresetActive(key);
            applyLoanPreset(key);
            toggleVaDisability(key);
            calculateAndRender();
          });
        }
        loanPresetChips.forEach((btn) => {
          btn.addEventListener('click', () => {
            const key = btn.getAttribute('data-preset') || '';
            setLoanPresetActive(key);
            applyLoanPreset(key);
            toggleVaDisability(key);
            calculateAndRender();
          });
        });
        
        // VA disability toggle change handler
        const vaDisabilityYes = document.getElementById('va_disability_yes');
        const vaDisabilityNo = document.getElementById('va_disability_no');
        if (vaDisabilityYes) vaDisabilityYes.addEventListener('change', () => calculateAndRender());
        if (vaDisabilityNo) vaDisabilityNo.addEventListener('change', () => calculateAndRender());

        // Rental property: conditional visibility toggles
        const qsa = (sel) => Array.from(document.querySelectorAll(sel));

        const adjustPurchaseDetailsSpacing = () => {
          const loanOn = !!(document.getElementById('use_loan_yes') && document.getElementById('use_loan_yes').checked);
          const repairsOn = !!(document.getElementById('need_repairs_yes') && document.getElementById('need_repairs_yes').checked);
          const row = document.getElementById('purchase_inputs_row');
          if (!row) return;
          const compact = !loanOn && !repairsOn;
          row.style.marginBottom = compact ? '8px' : '16px';
        };

        const toggleLoanFields = () => {
          const yes = document.getElementById('use_loan_yes');
          const show = !!(yes && yes.checked);
          // Hide/show individual loan fields
          qsa('.loan-field').forEach((el) => el.classList.toggle('is-hidden', !show));
          // Collapse/expand the entire group to remove extra whitespace
          const group = document.getElementById('loan_field_group');
          if (group) group.classList.toggle('is-hidden', !show);
        };

        const toggleRepairFields = () => {
          const yes = document.getElementById('need_repairs_yes');
          const show = !!(yes && yes.checked);
          // Hide/show individual repair fields
          qsa('.repair-field').forEach((el) => el.classList.toggle('is-hidden', !show));
          // Collapse/expand the entire group to remove extra whitespace
          const group = document.getElementById('repairs_field_group');
          if (group) group.classList.toggle('is-hidden', !show);
        };

        const updatePriceAppHeader = () => {
          const header = document.getElementById('price_app_header');
          if (!header) return;
          const modePrice = document.getElementById('price_mode_price');
          if (modePrice && modePrice.checked) {
            header.textContent = 'Sale Price ($)';
          } else {
            header.textContent = 'Value Appreciation (% per year)';
          }
        };

        const toggleSellFields = () => {
          const modePrice = document.getElementById('price_mode_price');
          let showPrice;
          if (modePrice) {
            showPrice = !!modePrice.checked;
          } else {
            const knowYes = document.getElementById('know_sell_price_yes');
            showPrice = !!(knowYes && knowYes.checked);
          }
          qsa('.sell-price-field').forEach((el) => el.classList.toggle('is-hidden', !showPrice));
          qsa('.appreciation-field').forEach((el) => el.classList.toggle('is-hidden', showPrice));
          updatePriceAppHeader();
        };

        // Simple/Advanced mode toggle
        const toggleMode = () => {
          const isSimple = document.getElementById('mode_simple')?.checked;
          
          // Toggle visibility of sections
          const opExpSection = document.getElementById('operating_expenses_section');
          const sellSection = document.getElementById('sell_exit_section');
          const vacancyWrapper = document.getElementById('vacancy_rate_wrapper');
          const simpleTaxRow = document.getElementById('simple_property_tax_row');
          const advancedCalcBtn = document.getElementById('showBreakdownBtn');
          const needRepairsRow = document.getElementById('need_repairs_row');
          
          if (opExpSection) opExpSection.style.display = isSimple ? 'none' : '';
          if (sellSection) sellSection.style.display = isSimple ? 'none' : '';
          if (vacancyWrapper) vacancyWrapper.style.display = isSimple ? 'none' : '';
          if (simpleTaxRow) simpleTaxRow.style.display = isSimple ? '' : 'none';
          if (advancedCalcBtn) advancedCalcBtn.style.display = isSimple ? 'none' : '';
          
          // Grey out (disable) Need Repairs toggle in simple mode instead of hiding
          if (needRepairsRow) {
            needRepairsRow.style.opacity = isSimple ? '0.4' : '';
            needRepairsRow.style.pointerEvents = isSimple ? 'none' : '';
          }
          
          // If switching to simple, ensure repairs is set to No and fields hidden
          if (isSimple) {
            const repairsNo = document.getElementById('need_repairs_no');
            if (repairsNo) repairsNo.checked = true;
            toggleRepairFields();
          }
          
          // Sync simple property tax with the real one
          const simpleTaxEl = document.getElementById('simple_property_tax');
          const realTaxEl = document.getElementById('exp_property_tax_annual');
          if (isSimple && simpleTaxEl && realTaxEl) {
            simpleTaxEl.value = realTaxEl.value;
          }
        };
        
        // Sync simple property tax to real property tax
        const syncSimplePropertyTax = () => {
          const simpleTaxEl = document.getElementById('simple_property_tax');
          const realTaxEl = document.getElementById('exp_property_tax_annual');
          if (simpleTaxEl && realTaxEl) {
            realTaxEl.value = simpleTaxEl.value;
            // Trigger recalc
            calculateAndRender();
          }
        };
        
        // Mode toggle event listeners
        ['mode_simple', 'mode_advanced'].forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.addEventListener('change', toggleMode);
        });
        
        // Simple property tax sync
        const simpleTaxInput = document.getElementById('simple_property_tax');
        if (simpleTaxInput) {
          simpleTaxInput.addEventListener('input', syncSimplePropertyTax);
        }

        ['use_loan_yes','use_loan_no','need_repairs_yes','need_repairs_no','know_sell_price_yes','know_sell_price_no','price_mode_price','price_mode_appreciation']
          .forEach((id) => {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('change', () => {
              if (id.startsWith('use_loan')) toggleLoanFields();
              else if (id.startsWith('need_repairs')) toggleRepairFields();
              else toggleSellFields();
              adjustPurchaseDetailsSpacing();
            });
          });

        // Initialize visibility on load
        toggleMode();
        toggleLoanFields();
        toggleRepairFields();
        toggleSellFields();
        updatePriceAppHeader();
        adjustPurchaseDetailsSpacing();

        // Breakdown list is read-only; no input listeners needed.

        // Subscribe functionality
        const SUBSCRIBE_KEY = "mc_rates_subscribed";
        const markSubscribed = () => {
          try { localStorage.setItem(SUBSCRIBE_KEY, "1"); } catch (_) {}
          try {
            if (window?.openai?.setWidgetState) {
              const s = window.openai.widgetState || {};
              window.openai.setWidgetState({ ...s, hasSubscribedRates: true });
            }
          } catch (_) {}
          // Hide the subscribe banner
          const subscribeBannerEl = document.getElementById('subscribeBanner');
          if (subscribeBannerEl) subscribeBannerEl.classList.add('is-hidden');
        };
        const isSubscribed = (() => {
          try {
            if (window?.openai?.widgetState?.hasSubscribedRates) return true;
            const v = localStorage.getItem(SUBSCRIBE_KEY);
            return v === "1" || v === "true";
          } catch (_) { return false; }
        })();

        const summaryView = document.getElementById('summaryView');
        const breakdownView = document.getElementById('breakdownView');
        const amortizationView = document.getElementById('amortizationView');
        const showBreakdownBtn = document.getElementById('showBreakdownBtn');
        const showSummaryBtn = document.getElementById('showSummaryBtn');
        const showAmortizationBtn = document.getElementById('showAmortizationBtn');
        const showAmortizationSummaryBtn = document.getElementById('showAmortizationSummaryBtn');
        const backToBreakdownBtn = document.getElementById('backToBreakdownBtn');
        const backToInputsBtnBottom = document.getElementById('backToInputsBtnBottom');

        const showView = (viewToShow) => {
          [summaryView, breakdownView, amortizationView].forEach(view => {
            if (view) view.classList.toggle('is-hidden', view.id !== viewToShow);
          });
          if (showSummaryBtn) showSummaryBtn.classList.toggle('is-hidden', viewToShow === 'summaryView');
          if (showAmortizationSummaryBtn) showAmortizationSummaryBtn.classList.toggle('is-hidden', viewToShow === 'summaryView');
        };

        const scrollViewToTop = (viewEl) => {
          if (!viewEl) return;
          viewEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
        };

        if (showBreakdownBtn) {
          showBreakdownBtn.addEventListener('click', () => {
            showView('breakdownView');
            scrollViewToTop(breakdownView);
          });
        }
        if (showAmortizationBtn) {
          showAmortizationBtn.addEventListener('click', () => {
            showView('amortizationView');
            scrollViewToTop(amortizationView);
          });
        }
        if (showSummaryBtn) {
          showSummaryBtn.addEventListener('click', () => {
            showView('summaryView');
            scrollViewToTop(summaryView);
          });
        }
        if (showAmortizationSummaryBtn) {
          showAmortizationSummaryBtn.addEventListener('click', () => {
            showView('summaryView');
            scrollViewToTop(summaryView);
          });
        }
        if (backToBreakdownBtn) {
          backToBreakdownBtn.addEventListener('click', () => {
            showView('breakdownView');
            scrollViewToTop(breakdownView);
          });
        }

        if (backToInputsBtnBottom) {
          backToInputsBtnBottom.addEventListener('click', () => {
            showView('summaryView');
            scrollViewToTop(summaryView);
          });
        }

        const backToInputsBtnSlide3 = document.getElementById('backToInputsBtnSlide3');
        const backToBreakdownBtnSlide3 = document.getElementById('backToBreakdownBtnSlide3');

        if (backToInputsBtnSlide3) {
          backToInputsBtnSlide3.addEventListener('click', () => {
            showView('summaryView');
            scrollViewToTop(summaryView);
          });
        }

        if (backToBreakdownBtnSlide3) {
          backToBreakdownBtnSlide3.addEventListener('click', () => {
            showView('breakdownView');
            scrollViewToTop(breakdownView);
          });
        }

        // Show summary view by default
        showView('summaryView');

        // Subscribe modal - initialize for subscribe buttons
        const subscribeBannerBtnRef = document.getElementById('subscribeBannerBtn');
        const subscribeBtnBottomRef = document.getElementById('subscribeBtnBottom');
        
        if (subscribeBannerBtnRef || subscribeBtnBottomRef) {
          let overlay, emailInput, statusEl, cancelBtn, submitBtn;

          const ensureSubscribeModal = () => {
            if (overlay) return;
            overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.innerHTML = `
              <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="subscribeTitle">
                <h3 id="subscribeTitle">Subscribe for Updates</h3>
                <p>Get expert tips to maximize your rental property returns.</p>
                <input id="subscribeEmail" type="email" placeholder="you@example.com" autocomplete="email" />
                <div id="subscribeStatus" class="modal-status"></div>
                <div class="modal-actions">
                  <button type="button" id="subscribeCancel">Cancel</button>
                  <button type="button" id="subscribeSubmit" class="primary">Subscribe</button>
                </div>
              </div>`;
            document.body.appendChild(overlay);
            emailInput = overlay.querySelector('#subscribeEmail');
            statusEl = overlay.querySelector('#subscribeStatus');
            cancelBtn = overlay.querySelector('#subscribeCancel');
            submitBtn = overlay.querySelector('#subscribeSubmit');

            const onCancel = () => { overlay.style.display = 'none'; };
            cancelBtn.addEventListener('click', onCancel);
            overlay.addEventListener('click', (e) => { if (e.target === overlay) onCancel(); });
            emailInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') submitSubscription(); });
            submitBtn.addEventListener('click', () => submitSubscription());
          };

          const openSubscribeModal = () => {
            ensureSubscribeModal();
            statusEl.textContent = '';
            overlay.style.display = 'flex';
            setTimeout(() => emailInput?.focus(), 0);
          };

          const SUBSCRIBE_ENDPOINTS = [
            'https://mortgage-calculator-open-ai.onrender.com/api/subscribe',
            'http://localhost:8000/api/subscribe',
            '/api/subscribe',
          ];

          const postJson = async (url, payload) => {
            return fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              mode: 'cors',
              body: JSON.stringify(payload),
            });
          };

          const submitSubscription = async () => {
            const email = (emailInput?.value || '').trim();
            if (!email || !email.includes('@')) {
              statusEl.textContent = 'Please enter a valid email address.';
              return;
            }
            statusEl.textContent = 'Subscribing…';

            try {
              emitTelemetry("notify_me_subscribe", { type: "rates", email });
              let resp = null;
              let raw = '';
              let data = {};
              const payload = {
                email,
                settlementId: 'rental_property_calculator',
                settlementName: 'Rental Property Calculator',
                deadline: null,
              };
              for (const url of SUBSCRIBE_ENDPOINTS) {
                try {
                  resp = await postJson(url, payload);
                  raw = await resp.text();
                  try { data = raw ? JSON.parse(raw) : {}; } catch (_) { data = {}; }
                  if (resp.ok && (data?.success || data?.id)) break;
                } catch (_) {
                  resp = null;
                  raw = '';
                  data = {};
                }
              }
              if (!resp) {
                statusEl.textContent = 'Subscription failed: no response from any endpoint';
                return;
              }
              if (resp.ok && (data?.success || data?.id)) {
                const code = Math.random().toString(36).slice(2, 8).toUpperCase();
                statusEl.textContent = data.message || "You're subscribed!";
                markSubscribed();
                overlay.style.display = 'none';
                window.setTimeout(() => window.alert(`${data.message || "You're subscribed!"}\nConfirmation: ${code}`), 50);
              } else {
                const detail = data?.error || (typeof data?.detail === 'string' ? data.detail : '') || resp.statusText || raw || 'Unknown error';
                statusEl.textContent = `Subscription failed: ${detail}`;
              }
            } catch (err) {
              console.error('Subscribe error', err);
              statusEl.textContent = 'Subscription failed. Please try again.';
            }
          };

          // Subscribe banner button opens modal
          if (subscribeBannerBtnRef) {
            subscribeBannerBtnRef.addEventListener('click', (e) => { e.preventDefault(); openSubscribeModal(); });
          }

          // Subscribe button at bottom opens modal  
          if (subscribeBtnBottomRef) {
            subscribeBtnBottomRef.addEventListener('click', (e) => { e.preventDefault(); openSubscribeModal(); });
          }
        }

        // Subscribe banner close functionality
        const subscribeBanner = document.getElementById('subscribeBanner');
        const subscribeBannerClose = document.getElementById('subscribeBannerClose');
        const BANNER_DISMISSED_KEY = 'mc_subscribe_banner_dismissed';

        // Check if banner was previously dismissed
        try {
          if (localStorage.getItem(BANNER_DISMISSED_KEY) === '1' && subscribeBanner) {
            subscribeBanner.classList.add('is-hidden');
          }
        } catch (_) {}

        // Also hide banner if already subscribed
        if (subscribeBanner && isSubscribed) {
          subscribeBanner.classList.add('is-hidden');
        }

        if (subscribeBannerClose) {
          subscribeBannerClose.addEventListener('click', () => {
            if (subscribeBanner) subscribeBanner.classList.add('is-hidden');
            try { localStorage.setItem(BANNER_DISMISSED_KEY, '1'); } catch (_) {}
          });
        }

        // Donate button handler
        const donateBtn = document.getElementById('donateBtn');
        if (donateBtn) {
          donateBtn.addEventListener('click', () => {
            window.open('https://buymeacoffee.com/jhtep', '_blank');
          });
        }

        // Load daily rate (FRED + 0.5%) and robustly update badge with retries and guard
        const RATE_ENDPOINTS = [
          '/api/rate',
          'https://mortgage-calculator-open-ai.onrender.com/api/rate',
          'http://localhost:8000/api/rate',
        ];

        const applyRateBadge = (val) => {
          const numEl = document.querySelector('.rate-badge .rate-num');
          if (!numEl) return false;
          const text = `${val}%`;
          if (numEl.textContent !== text) numEl.textContent = text;
          try { numEl.setAttribute('data-rate', String(val)); } catch (_) {}
          // Also set default interest rate input if user hasn't edited it
          try {
            if (!rateEdited) {
              const rateInput = document.getElementById('interest_rate_pct');
              if (rateInput) {
                const f = Number(val);
                const fmt = Number.isFinite(f) ? f.toFixed(2) : String(val);
                rateInput.value = fmt;
                const slider = document.getElementById('loan_rate_slider');
                const disp = document.getElementById('loan_rate_slider_display');
                if (slider && Number.isFinite(f)) slider.value = String(f);
                if (disp && Number.isFinite(f)) disp.textContent = `${Number(fmt).toFixed(2)}%`;
                calculateAndRender();
                saveUserInputsState();
              }
            }
          } catch(_) {}
          requestAnimationFrame(() => {
            if (typeof centerNotifyUnderRate === 'function') centerNotifyUnderRate();
          });
          return true;
        };

        const fetchRateOnce = async () => {
          for (const url of RATE_ENDPOINTS) {
            try {
              const resp = await fetch(url, { cache: 'no-store' });
              if (!resp.ok) continue;
              const data = await resp.json();
              const val = Number(data?.ratePercent);
              if (Number.isFinite(val)) return val;
            } catch (_) {
              // try next endpoint
            }
          }
          return null;
        };

        const guardRateBadge = (expectedText, ms = 10000) => {
          const numEl = document.querySelector('.rate-badge .rate-num');
          if (!numEl || typeof MutationObserver === 'undefined') return;
          const end = Date.now() + ms;
          const obs = new MutationObserver(() => {
            if (Date.now() > end) { obs.disconnect(); return; }
            if (numEl.textContent !== expectedText) {
              numEl.textContent = expectedText;
            }
          });
          obs.observe(numEl, { childList: true, characterData: true, subtree: true });
          // Stop guarding after ms
          setTimeout(() => obs.disconnect(), ms + 50);
        };

        const refreshRateBadge = async (maxTries = 6) => {
          try { emitTelemetry("rate_fetch_attempt", { maxTries }); } catch (_) {}
          for (let attempt = 0; attempt < maxTries; attempt++) {
            const val = await fetchRateOnce();
            if (val != null) {
              try { emitTelemetry("rate_fetch_success", { attempt, value: val }); } catch (_) {}
              const applied = applyRateBadge(val);
              if (applied) guardRateBadge(`${val}%`, 12000);
              return;
            }
            try { emitTelemetry("rate_fetch_retry", { attempt }); } catch (_) {}
            const delay = Math.min(8000, 500 * Math.pow(2, attempt));
            await new Promise((r) => setTimeout(r, delay));
          }
          try { emitTelemetry("rate_fetch_failed", {}); } catch (_) {}
        };

        // Read parameters from ChatGPT tool call if available (robust fallbacks)
        const DEBUG_HYDRATION = true;
        const pickProvided = (src) => {
          if (!src || typeof src !== 'object') return {};
          const out = {};
          const parseNumberish = (v) => {
            if (typeof v === 'number') return v;
            if (typeof v === 'string') {
              const cleaned = v.replace(/[$,\s]/g, '');
              const n = Number(cleaned);
              if (Number.isFinite(n)) return n;
            }
            return v;
          };
          const setIf = (k, v) => {
            if (v !== undefined && v !== null) {
              const keysNeedingNum = new Set([
                // legacy mortgage
                'home_value','down_payment_value','rate_apr','term_years','property_tax_input','homeowners_insurance_yearly','hoa_monthly','pmi_pct','annual_mi_pct','upfront_fee_pct','start_month','start_year','extra_principal_monthly','extra_start_month_index',
                // rental-specific
                'purchase_price','closing_cost','monthly_rent','other_monthly_income','vacancy_rate_pct','exp_property_tax_annual','exp_insurance_annual','exp_hoa_annual','exp_maintenance_annual','exp_other_annual','down_payment_pct','interest_rate_pct','loan_term_years','monthly_rent_increase_pct','other_monthly_income_increase_pct','exp_property_tax_increase_pct','exp_insurance_increase_pct','exp_hoa_increase_pct','exp_maintenance_increase_pct','exp_other_increase_pct','holding_length_years','cost_to_sell_pct','value_appreciation_pct','sell_price'
              ]);
              out[k] = keysNeedingNum.has(k) ? parseNumberish(v) : v;
            }
          };
          setIf('loan_type', src.loan_type);
          setIf('home_value', src.home_value);
          setIf('down_payment_value', src.down_payment_value);
          setIf('rate_apr', src.rate_apr);
          setIf('term_years', src.term_years);
          setIf('zip_code', src.zip_code);
          setIf('credit_score', src.credit_score);
          setIf('property_tax_input', src.property_tax_input);
          setIf('homeowners_insurance_yearly', src.homeowners_insurance_yearly);
          setIf('hoa_monthly', src.hoa_monthly);
          setIf('pmi_pct', src.pmi_pct);
          setIf('annual_mi_pct', src.annual_mi_pct);
          setIf('upfront_fee_pct', src.upfront_fee_pct);
          setIf('finance_upfront_fee', src.finance_upfront_fee);
          setIf('start_month', src.start_month);
          setIf('start_year', src.start_year);
          setIf('extra_principal_monthly', src.extra_principal_monthly);
          setIf('extra_start_month_index', src.extra_start_month_index);
          // rental-specific overlays
          setIf('purchase_price', src.purchase_price);
          setIf('closing_cost', src.closing_cost);
          setIf('monthly_rent', src.monthly_rent);
          setIf('other_monthly_income', src.other_monthly_income);
          setIf('vacancy_rate_pct', src.vacancy_rate_pct);
          setIf('exp_property_tax_annual', src.exp_property_tax_annual);
          setIf('exp_insurance_annual', src.exp_insurance_annual);
          setIf('exp_hoa_annual', src.exp_hoa_annual);
          setIf('exp_maintenance_annual', src.exp_maintenance_annual);
          setIf('exp_other_annual', src.exp_other_annual);
          setIf('down_payment_pct', src.down_payment_pct);
          setIf('interest_rate_pct', src.interest_rate_pct);
          setIf('loan_term_years', src.loan_term_years);
          setIf('monthly_rent_increase_pct', src.monthly_rent_increase_pct);
          setIf('other_monthly_income_increase_pct', src.other_monthly_income_increase_pct);
          setIf('exp_property_tax_increase_pct', src.exp_property_tax_increase_pct);
          setIf('exp_insurance_increase_pct', src.exp_insurance_increase_pct);
          setIf('exp_hoa_increase_pct', src.exp_hoa_increase_pct);
          setIf('exp_maintenance_increase_pct', src.exp_maintenance_increase_pct);
          setIf('exp_other_increase_pct', src.exp_other_increase_pct);
          setIf('holding_length_years', src.holding_length_years);
          setIf('cost_to_sell_pct', src.cost_to_sell_pct);
          setIf('value_appreciation_pct', src.value_appreciation_pct);
          setIf('sell_price', src.sell_price);
          return out;
        };
        // Apply rental-provided params directly to DOM fields (keeps flow intact)
        const applyRentalProvided = (params) => {
          if (!params || typeof params !== 'object') return;
          const ids = [
            'purchase_price','closing_cost','monthly_rent','other_monthly_income','vacancy_rate_pct',
            'exp_property_tax_annual','exp_insurance_annual','exp_hoa_annual','exp_maintenance_annual','exp_other_annual',
            'down_payment_pct','interest_rate_pct','loan_term_years',
            'monthly_rent_increase_pct','other_monthly_income_increase_pct','exp_property_tax_increase_pct','exp_insurance_increase_pct','exp_hoa_increase_pct','exp_maintenance_increase_pct','exp_other_increase_pct',
            'holding_length_years','cost_to_sell_pct','value_appreciation_pct','sell_price'
          ];
          ids.forEach((id) => {
            if (!(id in params)) return;
            const el = document.getElementById(id);
            if (!el) return;
            const v = params[id];
            if (el.type === 'checkbox') el.checked = Boolean(v);
            else el.value = String(v);
          });
        };
        const readProvidedParams = () => {
          const oa = (window && window.openai) ? window.openai : {};
          const candidates = [
            oa.toolOutput,
            oa.structuredContent,
            oa.result?.structuredContent,
            oa.toolInput,
          ];
          for (const c of candidates) {
            const p = pickProvided(c);
            if (Object.keys(p).length) {
              if (DEBUG_HYDRATION) console.debug('[Hydration] Found provided params source:', c === oa.toolOutput ? 'toolOutput' : (c === oa.structuredContent ? 'structuredContent' : (c === oa.toolInput ? 'toolInput' : 'result.structuredContent')), p);
              return p;
            }
          }
          if (DEBUG_HYDRATION) console.debug('[Hydration] No provided params found. openai keys:', Object.keys(oa || {}));
          return {};
        };
        const providedParams = readProvidedParams();
        
        // Merge provided parameters with base defaults
        setDefaults(baseDefaults);
        if (providedParams && typeof providedParams === 'object' && 'loan_type' in providedParams && providedParams.loan_type) {
          if (inputs.loan_type) inputs.loan_type.value = providedParams.loan_type;
        }
        mergeProgramDefaults();
        if (providedParams && Object.keys(providedParams).length > 0) {
          setDefaults(providedParams);
          applyRentalProvided(providedParams);
        }

        // Hydrate from saved widget/local state BEFORE applying derived defaults
        const hadSavedState = !!hydrateInputsFromState();
        console.log(`[Debug] Result of hydrateInputsFromState: ${hadSavedState}`);
        if (!hadSavedState) {
          console.log('[Debug] No saved state was hydrated. Applying rental defaults.');
          setRentalDefaultsIfEmpty(true);
        } else {
          console.log('[Debug] Saved state was hydrated. Filling any empty price-based estimates.');
          // Even with saved state, fill in any empty price-based estimates (lawn, water, etc.)
          updatePriceBasedEstimates();
        }

        // Ensure visibility and computed labels reflect hydrated/defaulted state
        try { toggleLoanFields(); } catch(_) {}
        try { toggleRepairFields(); } catch(_) {}
        try { toggleSellFields(); updatePriceAppHeader?.(); } catch(_) {}
        try { adjustPurchaseDetailsSpacing?.(); } catch(_) {}
        try { updateEstimatedIndicators(); } catch(_) {}

        calculateAndRender();
        saveUserInputsState();

        // Late overlay retry in case window.openai is attached slightly after execution
        let retries = 0;
        const tryLateOverlay = () => {
          if (didUserEdit) return;
          const late = readProvidedParams();
          if (late && Object.keys(late).length > 0) {
            if (DEBUG_HYDRATION) console.debug('[Hydration] Late overlay with provided params', late);
            if (late.loan_type) { try { inputs.loan_type.value = late.loan_type; mergeProgramDefaults(); } catch(_){} }
            setDefaults(late);
            applyRentalProvided(late);
            calculateAndRender();
            return true;
          }
          return false;
        };
        setTimeout(() => { if (!tryLateOverlay()) {
          const id = setInterval(() => {
            retries += 1;
            if (tryLateOverlay() || retries >= 6) clearInterval(id);
          }, 200);
        } }, 50);

        window.addEventListener('openai:set_globals', (ev) => {
          if (didUserEdit) return;
          const globals = ev?.detail?.globals || {};
          const props = pickProvided(globals.toolOutput || globals.structuredContent || globals.toolInput || {});
          if (props && Object.keys(props).length > 0) {
            if (DEBUG_HYDRATION) console.debug('[Hydration] Event overlay from set_globals', props);
            if (props.loan_type) { try { inputs.loan_type.value = props.loan_type; mergeProgramDefaults(); } catch(_){} }
            setDefaults(props);
            applyRentalProvided(props);
            calculateAndRender();
          }
        }, { passive: true });

        // Fetch and display the latest daily rate from server (FRED + 0.5%)
        let rateBadgeRefreshing = false;

        const refreshRateBadgeWithState = async () => {
          if (rateBadgeRefreshing) return;
          rateBadgeRefreshing = true;
          try {
            await refreshRateBadge();
          } finally {
            rateBadgeRefreshing = false;
          }
        };

        refreshRateBadgeWithState();

        const rateRefreshBtn = document.querySelector('.rate-refresh');
        if (rateRefreshBtn) {
          rateRefreshBtn.addEventListener('click', async () => {
            if (rateBadgeRefreshing) return;
            rateRefreshBtn.classList.add('is-spinning');
            try {
              await refreshRateBadgeWithState();
            } finally {
              rateRefreshBtn.classList.remove('is-spinning');
            }
          });
        }

        // Component loaded telemetry (Apps SDK guidance)
        emitTelemetry("component_loaded", {});
      })();
    </script>
  </body>
</html>
